# JUC

## Interrupt

ä¸­æ–­åœ¨javaä¸­ä¸»è¦æœ‰3ä¸ªæ–¹æ³•ï¼Œinterrupt(),isInterrupted()å’Œinterrupted()ã€‚

- interrupt()ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨å¦ä¸€ä¸ªçº¿ç¨‹çš„interrupt()æ–¹æ³•ï¼Œå³ä¼šå‘é‚£ä¸ªçº¿ç¨‹å‘å‡ºä¿¡å·â€”â€”è®¾ç½®ä¸­æ–­ä½ã€‚è‡³äºé‚£ä¸ªçº¿ç¨‹ä½•å»ä½•ä»ï¼Œç”±å…·ä½“çš„ä»£ç å®ç°å†³å®šã€‚
- isInterrupted()ï¼Œç”¨æ¥åˆ¤æ–­å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€(true or false)ã€‚
- interrupted()æ˜¯ä¸ªThreadçš„staticæ–¹æ³•ï¼Œæ¢å¤ä¸­æ–­ä½ï¼Œåå­—èµ·å¾—é¢ğŸ™„ã€‚



## LockSupport

LockSupportç”¨äºå µå¡å’Œé‡Šæ”¾çº¿ç¨‹ã€‚

- parkç³»åˆ—æ–¹æ³•ä¸»è¦ç”¨äºå µå¡çº¿ç¨‹ï¼Œunparkæ–¹æ³•ç”¨äºé‡Šæ”¾çº¿ç¨‹

  ~~~java
      private static void setBlocker(Thread t, Object arg) 
      public static void unpark(Thread thread) 
      public static void park(Object blocker) 
      public static void parkNanos(Object blocker, long nanos) 
      public static void parkUntil(Object blocker, long deadline) 
      public static Object getBlocker(Thread t)
      public static void park() 
      public static void parkNanos(long nanos)
      public static void parkUntil(long deadline) 
  ~~~

- blockerå¯¹è±¡ä¸»è¦ç”¨äºçº¿ç¨‹dumpæ—¶æä¾›æ›´å¤šçš„çº¿ç¨‹ä¿¡æ¯ï¼Œ æ–¹ä¾¿å®šä½é—®é¢˜

![image-20210922203140308](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20210922203140308.png)



- LockSupportå µå¡çº¿ç¨‹ä¸éœ€è¦é”ï¼Œ åº•å±‚æ˜¯è°ƒç”¨unsafeçš„nativeæ–¹æ³•ã€‚

- **Thread.interrupt()ä¸­æ–­å µå¡çš„çº¿ç¨‹æ—¶ï¼Œ park()æ–¹æ³•é€€å‡ºä½†æ˜¯ä¸ä¼šæŠ›å‡ºInterruptExceptionï¼Œ isInterrupt()è¿”å›trueï¼Œæ‰€ä»¥é€€å‡ºpark()æ–¹æ³•æ—¶éœ€è¦æ‰§è¡Œåˆ¤æ–­æ˜¯æ­£å¸¸é€€å‡ºè¿˜æ˜¯è¢«ä¸­æ–­äº†ã€‚**

- **park()æ–¹æ³•å µå¡æ—¶ä¸ä¼šé‡Šæ”¾é”èµ„æºï¼Œ ä¸sleepç±»ä¼¼**

- éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ åœ¨c++ä»£ç ä¸­ï¼Œ æ¯ä¸ªjavaçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªParkerå¯¹è±¡ï¼Œ å…¶ä¸­ç»´æŠ¤ç€ä¸€ä¸ªå˜é‡_countï¼Œè¿™ä¸ªå˜é‡ç›¸å½“äºä¸€ä¸ªè®¸å¯è¯ã€‚

  unparkä½¿\_count=1ï¼Œè¡¨ç¤ºè®¸å¯è¯å¯ç”¨ï¼Œè€Œparkæ–¹æ³•æ£€æµ‹è®¸å¯è¯æ˜¯å¦å¯ç”¨ï¼Œ å¦‚æœå¯ç”¨é‚£å°±æ¶ˆè€—æ‰è®¸å¯è¯å¹¶ç›´æ¥é€€å‡ºï¼Œ å¦‚æœè®¸å¯è¯ä¸å¯ç”¨æ‰å µå¡çº¿ç¨‹çŸ¥é“è®¸å¯è¯å¯ç”¨æˆ–è€…å µå¡æ—¶é—´åˆ°äº†ã€‚

  **æ‰€ä»¥å¯¹äºè°ƒç”¨å…ˆè°ƒç”¨unparkæ–¹æ³•åœ¨è°ƒç”¨parkæ–¹æ³•å¹¶ä¸ä¼šå µå¡çº¿ç¨‹è€Œæ˜¯æ¶ˆè€—è®¸å¯è¯ã€‚**

  ![image-20210922205111953](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20210922205111953.png)

  https://zhuanlan.zhihu.com/p/380327398

  https://www.jianshu.com/p/ceb8870ef2c5

## é”çš„åˆ†ç±»

- äº’æ–¥é”ï¼šç”¨äºä¿è¯åœ¨ä»»ä½•æ—¶åˆ»ï¼Œéƒ½åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®è¯¥å¯¹è±¡ã€‚å½“è·å–é”æ“ä½œå¤±è´¥æ—¶ï¼Œçº¿ç¨‹ä¼šè¿›å…¥ç¡çœ ï¼Œç­‰å¾…é”é‡Šæ”¾æ—¶è¢«å”¤é†’ã€‚
- è¯»å†™é”ï¼šrwlockï¼Œåˆ†ä¸ºè¯»é”å’Œå†™é”ã€‚å¤„äºè¯»æ“ä½œæ—¶ï¼Œå¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å¾—è¯»æ“ä½œã€‚ä½†æ˜¯åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å¾—å†™é”ã€‚å…¶å®ƒè·å–å†™é”å¤±è´¥çš„çº¿ç¨‹éƒ½ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç›´åˆ°å†™é”é‡Šæ”¾æ—¶è¢«å”¤é†’ã€‚ æ³¨æ„ï¼šå†™é”ä¼šé˜»å¡å…¶å®ƒè¯»å†™é”ã€‚å½“æœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾—å†™é”åœ¨å†™æ—¶ï¼Œè¯»é”ä¹Ÿä¸èƒ½è¢«å…¶å®ƒçº¿ç¨‹è·å–ï¼›å†™è€…ä¼˜å…ˆäºè¯»è€…ï¼ˆä¸€æ—¦æœ‰å†™è€…ï¼Œåˆ™åç»­è¯»è€…å¿…é¡»ç­‰å¾…ï¼Œå”¤é†’æ—¶ä¼˜å…ˆè€ƒè™‘å†™è€…ï¼‰ã€‚é€‚ç”¨äºè¯»å–æ•°æ®çš„é¢‘ç‡è¿œè¿œå¤§äºå†™æ•°æ®çš„é¢‘ç‡çš„åœºåˆã€‚
- è‡ªæ—‹é”ï¼šspinlockï¼Œåœ¨ä»»ä½•æ—¶åˆ»åŒæ ·åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¯¹è±¡ã€‚ä½†æ˜¯å½“è·å–é”æ“ä½œå¤±è´¥æ—¶ï¼Œä¸ä¼šè¿›å…¥ç¡çœ ï¼Œè€Œæ˜¯ä¼šåœ¨åŸåœ°è‡ªæ—‹ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚è¿™æ ·èŠ‚çœäº†çº¿ç¨‹ä»ç¡çœ çŠ¶æ€åˆ°è¢«å”¤é†’æœŸé—´çš„æ¶ˆè€—ï¼Œåœ¨åŠ é”æ—¶é—´çŸ­æš‚çš„ç¯å¢ƒä¸‹ä¼šæå¤§çš„æé«˜æ•ˆç‡ã€‚ä½†å¦‚æœåŠ é”æ—¶é—´è¿‡é•¿ï¼Œåˆ™ä¼šéå¸¸æµªè´¹CPUèµ„æºã€‚
- RCUï¼šå³read-copy-updateï¼Œåœ¨ä¿®æ”¹æ•°æ®æ—¶ï¼Œé¦–å…ˆéœ€è¦è¯»å–æ•°æ®ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªå‰¯æœ¬ï¼Œå¯¹å‰¯æœ¬è¿›è¡Œä¿®æ”¹ã€‚ä¿®æ”¹å®Œæˆåï¼Œå†å°†è€æ•°æ®updateæˆæ–°çš„æ•°æ®ã€‚ä½¿ç”¨RCUæ—¶ï¼Œè¯»è€…å‡ ä¹ä¸éœ€è¦åŒæ­¥å¼€é”€ï¼Œæ—¢ä¸éœ€è¦è·å¾—é”ï¼Œä¹Ÿä¸ä½¿ç”¨åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šå¯¼è‡´é”ç«äº‰ï¼Œå› æ­¤å°±ä¸ç”¨è€ƒè™‘æ­»é”é—®é¢˜äº†ã€‚è€Œå¯¹äºå†™è€…çš„åŒæ­¥å¼€é”€è¾ƒå¤§ï¼Œå®ƒéœ€è¦å¤åˆ¶è¢«ä¿®æ”¹çš„æ•°æ®ï¼Œè¿˜å¿…é¡»ä½¿ç”¨é”æœºåˆ¶åŒæ­¥å¹¶è¡Œå…¶å®ƒå†™è€…çš„ä¿®æ”¹æ“ä½œã€‚åœ¨æœ‰å¤§é‡è¯»æ“ä½œï¼Œå°‘é‡å†™æ“ä½œçš„æƒ…å†µä¸‹æ•ˆç‡éå¸¸é«˜ã€‚

## çº¿ç¨‹æ± ThreadPoolExecutor

### çº¿ç¨‹æ± ä¸»è¦å·¥ä½œæ–¹å¼

ä¸€ä¸ªExecutorServiceä½¿ç”¨å¯èƒ½çš„å‡ ä¸ªæ± çº¿ç¨‹ä¹‹ä¸€æ‰§è¡Œæ¯ä¸ªæäº¤çš„ä»»åŠ¡ï¼Œé€šå¸¸ä½¿ç”¨Executorså·¥å‚æ–¹æ³•é…ç½®ã€‚
çº¿ç¨‹æ± è§£å†³ä¸¤ä¸ªä¸åŒçš„é—®é¢˜ï¼šç”±äºå‡å°‘äº†æ¯ä¸ªä»»åŠ¡çš„è°ƒç”¨å¼€é”€ï¼Œå®ƒä»¬é€šå¸¸åœ¨æ‰§è¡Œå¤§é‡å¼‚æ­¥ä»»åŠ¡æ—¶æä¾›æ”¹è¿›çš„æ€§èƒ½ï¼Œå¹¶ä¸”å®ƒä»¬æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºçš„æ–¹æ³•ï¼ŒåŒ…æ‹¬åœ¨æ‰§è¡Œé›†åˆæ—¶æ¶ˆè€—çš„çº¿ç¨‹ä»»åŠ¡ã€‚ æ¯ä¸ªThreadPoolExecutorè¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆçš„ä»»åŠ¡æ•°ã€‚
ä¸ºäº†åœ¨å¹¿æ³›çš„ä¸Šä¸‹æ–‡ä¸­æœ‰ç”¨ï¼Œæ­¤ç±»æä¾›äº†è®¸å¤šå¯è°ƒæ•´çš„å‚æ•°å’Œå¯æ‰©å±•æ€§æŒ‚é’©ã€‚ ä½†æ˜¯ï¼Œå¼ºçƒˆå»ºè®®ç¨‹åºå‘˜ä½¿ç”¨æ›´æ–¹ä¾¿çš„Executorså·¥å‚æ–¹æ³•Executors.newCachedThreadPool ï¼ˆæ— ç•Œçº¿ç¨‹æ± ï¼Œå…·æœ‰è‡ªåŠ¨çº¿ç¨‹å›æ”¶ï¼‰ã€ Executors.newFixedThreadPool ï¼ˆå›ºå®šå¤§å°çº¿ç¨‹æ± ï¼‰å’ŒExecutors.newSingleThreadExecutor ï¼ˆå•ä¸ªåå°çº¿ç¨‹ï¼‰ï¼Œå®ƒä»¬ä¸ºæœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯ã€‚ å¦åˆ™ï¼Œåœ¨æ‰‹åŠ¨é…ç½®å’Œè°ƒæ•´æ­¤ç±»æ—¶ä½¿ç”¨ä»¥ä¸‹æŒ‡å—ï¼š
æ ¸å¿ƒå’Œæœ€å¤§æ± å¤§å°
ThreadPoolExecutorå°†æ ¹æ® corePoolSizeï¼ˆè¯·å‚é˜…getCorePoolSize ï¼‰å’ŒgetCorePoolSize ï¼ˆè¯·å‚é˜…getMaximumPoolSize ï¼‰è®¾ç½®çš„è¾¹ç•Œè‡ªåŠ¨è°ƒæ•´æ± å¤§å°ï¼ˆè¯·å‚é˜…getPoolSize ï¼‰ã€‚ åœ¨æ–¹æ³•execute(Runnable)æäº¤æ–°ä»»åŠ¡æ—¶ï¼Œå¦‚æœè¿è¡Œçš„çº¿ç¨‹å°‘äº corePoolSizeï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥å¤„ç†è¯·æ±‚ï¼Œå³ä½¿å…¶ä»–å·¥ä½œçº¿ç¨‹å¤„äºç©ºé—²çŠ¶æ€ã€‚ å¦åˆ™ï¼Œå¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹å°‘äº maximumPoolSizeï¼Œåˆ™åªæœ‰åœ¨é˜Ÿåˆ—å·²æ»¡æ—¶æ‰ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥å¤„ç†è¯·æ±‚ã€‚ é€šè¿‡å°† corePoolSize å’Œ maximumPoolSize è®¾ç½®ä¸ºç›¸åŒï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ã€‚ é€šè¿‡å°† maximumPoolSize è®¾ç½®ä¸ºä¸€ä¸ªåŸºæœ¬ä¸Šæ— ç•Œçš„å€¼ï¼Œä¾‹å¦‚Integer.MAX_VALUE ï¼Œæ‚¨å¯ä»¥å…è®¸æ± å®¹çº³ä»»æ„æ•°é‡çš„å¹¶å‘ä»»åŠ¡ã€‚ æœ€å…¸å‹çš„æ˜¯ï¼Œæ ¸å¿ƒå’Œæœ€å¤§æ± å¤§å°ä»…åœ¨æ„é€ æ—¶è®¾ç½®ï¼Œä½†å®ƒä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨setCorePoolSizeå’ŒsetMaximumPoolSizeåŠ¨æ€æ›´æ”¹ã€‚
æŒ‰éœ€æ„å»º
é»˜è®¤æƒ…å†µä¸‹ï¼Œå³ä½¿æ˜¯æ ¸å¿ƒçº¿ç¨‹ä¹Ÿåªæœ‰åœ¨æ–°ä»»åŠ¡åˆ°è¾¾æ—¶æ‰æœ€åˆåˆ›å»ºå’Œå¯åŠ¨ï¼Œä½†è¿™å¯ä»¥ä½¿ç”¨æ–¹æ³•prestartCoreThreadæˆ–prestartAllCoreThreadsåŠ¨æ€è¦†ç›–ã€‚ å¦‚æœæ‚¨ä½¿ç”¨éç©ºé˜Ÿåˆ—æ„é€ æ± ï¼Œæ‚¨å¯èƒ½æƒ³è¦é¢„å¯åŠ¨çº¿ç¨‹ã€‚
åˆ›å»ºæ–°çº¿ç¨‹
ä½¿ç”¨ThreadFactoryåˆ›å»ºæ–°çº¿ç¨‹ã€‚ å¦‚æœæ²¡æœ‰å¦å¤–æŒ‡å®šï¼Œåˆ™ä½¿ç”¨Executors.defaultThreadFactory ï¼Œå®ƒåˆ›å»ºçš„çº¿ç¨‹éƒ½åœ¨åŒä¸€ä¸ªThreadGroupå¹¶ä¸”å…·æœ‰ç›¸åŒçš„NORM_PRIORITYä¼˜å…ˆçº§å’Œéå®ˆæŠ¤è¿›ç¨‹çŠ¶æ€ã€‚ é€šè¿‡æä¾›ä¸åŒçš„ ThreadFactoryï¼Œæ‚¨å¯ä»¥æ›´æ”¹çº¿ç¨‹çš„åç§°ã€çº¿ç¨‹ç»„ã€ä¼˜å…ˆçº§ã€å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€ç­‰ã€‚å¦‚æœThreadFactoryåœ¨é€šè¿‡ä»newThreadè¿”å› null çš„è¯¢é—®æ—¶æœªèƒ½åˆ›å»ºçº¿ç¨‹ï¼Œåˆ™æ‰§è¡Œç¨‹åºå°†ç»§ç»­ï¼Œä½†å¯èƒ½æ— æ³•æ‰§è¡Œä»»ä½•ä»»åŠ¡ã€‚ çº¿ç¨‹åº”è¯¥æ‹¥æœ‰â€œmodifyThreadâ€ RuntimePermission ã€‚ å¦‚æœå·¥ä½œçº¿ç¨‹æˆ–å…¶ä»–ä½¿ç”¨æ± çš„çº¿ç¨‹ä¸å…·å¤‡æ­¤æƒé™ï¼Œåˆ™æœåŠ¡å¯èƒ½ä¼šé™çº§ï¼šé…ç½®æ›´æ”¹å¯èƒ½æ— æ³•åŠæ—¶ç”Ÿæ•ˆï¼Œå…³é—­æ± å¯èƒ½ä¼šä¸€ç›´å¤„äºå¯ä»¥ç»ˆæ­¢ä½†æœªå®Œæˆçš„çŠ¶æ€ã€‚
ä¿æ´»æ—¶é—´
å¦‚æœæ± ä¸­å½“å‰æœ‰è¶…è¿‡ corePoolSize çš„çº¿ç¨‹ï¼Œåˆ™å¤šä½™çš„çº¿ç¨‹å¦‚æœç©ºé—²æ—¶é—´è¶…è¿‡ keepAliveTimeï¼ˆè¯·å‚é˜…getKeepAliveTime(TimeUnit) ï¼‰å°†è¢«ç»ˆæ­¢ã€‚ è¿™æä¾›äº†ä¸€ç§åœ¨æœªç§¯æä½¿ç”¨æ± æ—¶å‡å°‘èµ„æºæ¶ˆè€—çš„æ–¹æ³•ã€‚ å¦‚æœæ± ç¨åå˜å¾—æ›´åŠ æ´»è·ƒï¼Œåˆ™å°†æ„å»ºæ–°çº¿ç¨‹ã€‚ ä¹Ÿå¯ä»¥ä½¿ç”¨setKeepAliveTime(long, TimeUnit)æ–¹æ³•åŠ¨æ€æ›´æ”¹æ­¤å‚æ•°ã€‚ ä½¿ç”¨Long.MAX_VALUE TimeUnit.NANOSECONDSå€¼Long.MAX_VALUEæœ‰æ•ˆåœ°ç¦æ­¢ç©ºé—²çº¿ç¨‹åœ¨å…³é—­ä¹‹å‰ç»ˆæ­¢ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œä¿æŒæ´»åŠ¨ç­–ç•¥ä»…åœ¨æœ‰è¶…è¿‡ corePoolSize ä¸ªçº¿ç¨‹æ—¶åº”ç”¨ï¼Œä½†æ–¹æ³•allowCoreThreadTimeOut(boolean)ä¹Ÿå¯ç”¨äºå°†æ­¤è¶…æ—¶ç­–ç•¥åº”ç”¨äºæ ¸å¿ƒçº¿ç¨‹ï¼Œåªè¦ keepAliveTime å€¼ä¸ä¸ºé›¶.
æ’é˜Ÿ
ä»»ä½•BlockingQueueéƒ½å¯ç”¨äºä¼ è¾“å’Œä¿å­˜æäº¤çš„ä»»åŠ¡ã€‚ æ­¤é˜Ÿåˆ—çš„ä½¿ç”¨ä¸æ± å¤§å°äº¤äº’ï¼š
å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹å°‘äº corePoolSizeï¼Œåˆ™ Executor æ€»æ˜¯å–œæ¬¢æ·»åŠ æ–°çº¿ç¨‹è€Œä¸æ˜¯æ’é˜Ÿã€‚
å¦‚æœ corePoolSize æˆ–æ›´å¤šçº¿ç¨‹æ­£åœ¨è¿è¡Œï¼ŒExecutor æ€»æ˜¯å–œæ¬¢å°†è¯·æ±‚æ’é˜Ÿè€Œä¸æ˜¯æ·»åŠ æ–°çº¿ç¨‹ã€‚
å¦‚æœè¯·æ±‚æ— æ³•æ’é˜Ÿï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œé™¤éè¿™ä¼šè¶…è¿‡ maximumPoolSizeï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»»åŠ¡å°†è¢«æ‹’ç»ã€‚
æ’é˜Ÿçš„ä¸€èˆ¬ç­–ç•¥æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š
ç›´æ¥äº¤æ¥ã€‚ å·¥ä½œé˜Ÿåˆ—çš„ä¸€ä¸ªå¾ˆå¥½çš„é»˜è®¤é€‰æ‹©æ˜¯SynchronousQueue ï¼Œå®ƒå°†ä»»åŠ¡ç§»äº¤ç»™çº¿ç¨‹è€Œä¸ç”¨å…¶ä»–æ–¹å¼ä¿ç•™å®ƒä»¬ã€‚ åœ¨è¿™é‡Œï¼Œå¦‚æœæ²¡æœ‰çº¿ç¨‹å¯ç«‹å³è¿è¡Œï¼Œåˆ™å°†ä»»åŠ¡æ’é˜Ÿçš„å°è¯•å°†å¤±è´¥ï¼Œå› æ­¤å°†æ„å»ºä¸€ä¸ªæ–°çº¿ç¨‹ã€‚ åœ¨å¤„ç†å¯èƒ½å…·æœ‰å†…éƒ¨ä¾èµ–æ€§çš„è¯·æ±‚é›†æ—¶ï¼Œæ­¤ç­–ç•¥å¯é¿å…é”å®šã€‚ ç›´æ¥åˆ‡æ¢é€šå¸¸éœ€è¦æ— é™çš„maximumPoolSizes ä»¥é¿å…æ‹’ç»æ–°æäº¤çš„ä»»åŠ¡ã€‚ è¿™åè¿‡æ¥åˆæ‰¿è®¤äº†å½“å‘½ä»¤å¹³å‡åˆ°è¾¾é€Ÿåº¦è¶…è¿‡å®ƒä»¬å¯ä»¥å¤„ç†çš„é€Ÿåº¦æ—¶æ— é™çº¿ç¨‹å¢é•¿çš„å¯èƒ½æ€§ã€‚
æ— ç•Œé˜Ÿåˆ—ã€‚ ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—ï¼ˆä¾‹å¦‚ï¼Œæ²¡æœ‰é¢„å®šä¹‰å®¹é‡çš„LinkedBlockingQueue ï¼‰å°†å¯¼è‡´æ–°ä»»åŠ¡åœ¨æ‰€æœ‰ corePoolSize çº¿ç¨‹éƒ½å¿™æ—¶åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚ å› æ­¤ï¼Œä¸ä¼šåˆ›å»ºè¶…è¿‡ corePoolSize çš„çº¿ç¨‹ã€‚ ï¼ˆå› æ­¤maximumPoolSizeçš„å€¼æ²¡æœ‰ä»»ä½•å½±å“ã€‚ï¼‰å½“æ¯ä¸ªä»»åŠ¡å®Œå…¨ç‹¬ç«‹äºå…¶ä»–ä»»åŠ¡æ—¶ï¼Œè¿™å¯èƒ½æ˜¯åˆé€‚çš„ï¼Œå› æ­¤ä»»åŠ¡ä¸ä¼šå½±å“å½¼æ­¤çš„æ‰§è¡Œï¼› ä¾‹å¦‚ï¼Œåœ¨ç½‘é¡µæœåŠ¡å™¨ä¸­ã€‚ è™½ç„¶è¿™ç§æ’é˜Ÿæ–¹å¼åœ¨å¹³æ»‘è¯·æ±‚çš„ç¬æ—¶çˆ†å‘æ–¹é¢å¾ˆæœ‰ç”¨ï¼Œä½†å®ƒæ‰¿è®¤å½“å‘½ä»¤çš„å¹³å‡åˆ°è¾¾é€Ÿåº¦è¶…è¿‡å®ƒä»¬çš„å¤„ç†é€Ÿåº¦æ—¶ï¼Œå·¥ä½œé˜Ÿåˆ—å¯èƒ½ä¼šæ— é™å¢é•¿ã€‚
æœ‰ç•Œé˜Ÿåˆ—ã€‚ æœ‰ç•Œé˜Ÿåˆ—ï¼ˆä¾‹å¦‚ï¼Œ ArrayBlockingQueue ï¼‰åœ¨ä¸æœ‰é™çš„ maximumPoolSizes ä¸€èµ·ä½¿ç”¨æ—¶æœ‰åŠ©äºé˜²æ­¢èµ„æºè€—å°½ï¼Œä½†å¯èƒ½æ›´éš¾ä»¥è°ƒæ•´å’Œæ§åˆ¶ã€‚ é˜Ÿåˆ—å¤§å°å’Œæœ€å¤§æ± å¤§å°å¯ä»¥ç›¸äº’æƒè¡¡ï¼šä½¿ç”¨å¤§é˜Ÿåˆ—å’Œå°æ± å¯ä»¥æœ€å¤§é™åº¦åœ°å‡å°‘ CPU ä½¿ç”¨ç‡ã€æ“ä½œç³»ç»Ÿèµ„æºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œä½†ä¼šå¯¼è‡´äººä¸ºåœ°é™ä½ååé‡ã€‚ å¦‚æœä»»åŠ¡é¢‘ç¹é˜»å¡ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœå®ƒä»¬å— I/O é™åˆ¶ï¼‰ï¼Œåˆ™ç³»ç»Ÿå¯èƒ½èƒ½å¤Ÿä¸ºæ¯”æ‚¨å…è®¸çš„æ›´å¤šçº¿ç¨‹å®‰æ’æ—¶é—´ã€‚ ä½¿ç”¨å°é˜Ÿåˆ—é€šå¸¸éœ€è¦æ›´å¤§çš„æ± å¤§å°ï¼Œè¿™ä¼šä½¿ CPU æ›´å¿™ï¼Œä½†å¯èƒ½ä¼šé‡åˆ°ä¸å¯æ¥å—çš„è°ƒåº¦å¼€é”€ï¼Œè¿™ä¹Ÿä¼šé™ä½ååé‡ã€‚
è¢«æ‹’ç»çš„ä»»åŠ¡
å½“ Executor å·²ç»å…³é—­ï¼Œå¹¶ä¸”å½“ Executor å¯¹æœ€å¤§çº¿ç¨‹å’Œå·¥ä½œé˜Ÿåˆ—å®¹é‡ä½¿ç”¨æœ‰é™è¾¹ç•Œå¹¶ä¸”é¥±å’Œæ—¶ï¼Œåœ¨æ–¹æ³•execute(Runnable)æäº¤çš„æ–°ä»»åŠ¡å°†è¢«æ‹’ç»ã€‚ åœ¨ä»»ä¸€æƒ…å†µä¸‹ï¼Œ executeæ–¹æ³•è°ƒç”¨RejectedExecutionHandler.rejectedExecution(Runnable, ThreadPoolExecutor)å…¶çš„æ–¹æ³•RejectedExecutionHandler ã€‚ æä¾›äº†å››ä¸ªé¢„å®šä¹‰çš„å¤„ç†ç¨‹åºç­–ç•¥ï¼š
åœ¨é»˜è®¤çš„ThreadPoolExecutor.AbortPolicy ï¼Œå¤„ç†ç¨‹åºåœ¨æ‹’ç»æ—¶æŠ›å‡ºè¿è¡Œæ—¶RejectedExecutionException ã€‚
åœ¨ThreadPoolExecutor.CallerRunsPolicy ï¼Œè°ƒç”¨executeçš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ã€‚ è¿™æä¾›äº†ä¸€ä¸ªç®€å•çš„åé¦ˆæ§åˆ¶æœºåˆ¶ï¼Œå¯ä»¥å‡æ…¢æäº¤æ–°ä»»åŠ¡çš„é€Ÿåº¦ã€‚
åœ¨ThreadPoolExecutor.DiscardPolicy ï¼Œæ— æ³•æ‰§è¡Œçš„ä»»åŠ¡è¢«ç®€å•åœ°ä¸¢å¼ƒã€‚
åœ¨ThreadPoolExecutor.DiscardOldestPolicy ï¼Œå¦‚æœæ‰§è¡Œå™¨æ²¡æœ‰å…³é—­ï¼Œå·¥ä½œé˜Ÿåˆ—å¤´éƒ¨çš„ä»»åŠ¡ä¼šè¢«ä¸¢å¼ƒï¼Œç„¶åé‡è¯•æ‰§è¡Œï¼ˆå¯èƒ½ä¼šå†æ¬¡å¤±è´¥ï¼Œå¯¼è‡´é‡å¤æ‰§è¡Œï¼‰ã€‚
å¯ä»¥å®šä¹‰å’Œä½¿ç”¨å…¶ä»–ç±»å‹çš„RejectedExecutionHandlerç±»ã€‚ è¿™æ ·åšéœ€è¦å°å¿ƒï¼Œç‰¹åˆ«æ˜¯å½“ç­–ç•¥è®¾è®¡ä¸ºä»…åœ¨ç‰¹å®šå®¹é‡æˆ–æ’é˜Ÿç­–ç•¥ä¸‹å·¥ä½œæ—¶ã€‚
é’©å­æ–¹æ³•
æ­¤ç±»æä¾›protectedå¯beforeExecute(Thread, Runnable)å’ŒafterExecute(Runnable, Throwable)æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åœ¨æ¯ä¸ªä»»åŠ¡æ‰§è¡Œä¹‹å‰å’Œä¹‹åè°ƒç”¨ã€‚ è¿™äº›å¯ç”¨äºæ“ä½œæ‰§è¡Œç¯å¢ƒï¼› ä¾‹å¦‚ï¼Œé‡æ–°åˆå§‹åŒ– ThreadLocalsã€æ”¶é›†ç»Ÿè®¡ä¿¡æ¯æˆ–æ·»åŠ æ—¥å¿—æ¡ç›®ã€‚ æ­¤å¤–ï¼Œå¯ä»¥è¦†ç›–å·²terminatedæ–¹æ³•ä»¥æ‰§è¡Œåœ¨ Executor å®Œå…¨ç»ˆæ­¢åéœ€è¦å®Œæˆçš„ä»»ä½•ç‰¹æ®Šå¤„ç†ã€‚
å¦‚æœé’©å­ã€å›è°ƒæˆ– BlockingQueue æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œå†…éƒ¨å·¥ä½œçº¿ç¨‹å¯èƒ½ä¼šä¾æ¬¡å¤±è´¥ã€çªç„¶ç»ˆæ­¢å¹¶å¯èƒ½è¢«æ›¿æ¢ã€‚
é˜Ÿåˆ—ç»´æŠ¤
æ–¹æ³•getQueue()å…è®¸è®¿é—®å·¥ä½œé˜Ÿåˆ—ä»¥è¿›è¡Œç›‘è§†å’Œè°ƒè¯•ã€‚ å¼ºçƒˆå»ºè®®ä¸è¦å°†æ­¤æ–¹æ³•ç”¨äºä»»ä½•å…¶ä»–ç›®çš„ã€‚ æä¾›çš„ä¸¤ç§æ–¹æ³•remove(Runnable)å’Œpurgeå¯ç”¨äºåœ¨å¤§é‡æ’é˜Ÿä»»åŠ¡è¢«å–æ¶ˆæ—¶ååŠ©å­˜å‚¨å›æ”¶ã€‚
å¼€å¦
å³ä¸å†åœ¨ç¨‹åºä¸­å¼•ç”¨ï¼Œä¹Ÿæ²¡æœ‰å‰©ä½™çº¿ç¨‹éƒ½å¯ä»¥è¢«å›æ”¶ï¼ˆåƒåœ¾å›æ”¶ï¼‰æ²¡æœ‰è¢«æ˜ç¡®åœ°å…³é—­æ± ã€‚ æ‚¨å¯ä»¥é€šè¿‡è®¾ç½®é€‚å½“çš„ä¿æŒæ´»åŠ¨æ—¶é—´ã€ä½¿ç”¨é›¶æ ¸å¿ƒçº¿ç¨‹çš„ä¸‹é™å’Œ/æˆ–è®¾ç½®allowCoreThreadTimeOut(boolean)æ¥é…ç½®æ± ä»¥å…è®¸æ‰€æœ‰æœªä½¿ç”¨çš„çº¿ç¨‹æœ€ç»ˆæ­»äº¡ã€‚
æ‰©å±•ç¤ºä¾‹ã€‚ æ­¤ç±»çš„å¤§å¤šæ•°æ‰©å±•éƒ½ä¼šè¦†ç›–ä¸€ä¸ªæˆ–å¤šä¸ªå—ä¿æŠ¤çš„æŒ‚é’©æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼Œè¿™æ˜¯ä¸€ä¸ªæ·»åŠ ç®€å•æš‚åœ/æ¢å¤åŠŸèƒ½çš„å­ç±»ï¼š

~~~java
 class PausableThreadPoolExecutor extends ThreadPoolExecutor {
   private boolean isPaused;
   private ReentrantLock pauseLock = new ReentrantLock();
   private Condition unpaused = pauseLock.newCondition();

   public PausableThreadPoolExecutor(...) { super(...); }

   protected void beforeExecute(Thread t, Runnable r) {
     super.beforeExecute(t, r);
     pauseLock.lock();
     try {
       while (isPaused) unpaused.await();
     } catch (InterruptedException ie) {
       t.interrupt();
     } finally {
       pauseLock.unlock();
     }
   }

   public void pause() {
     pauseLock.lock();
     try {
       isPaused = true;
     } finally {
       pauseLock.unlock();
     }
   }

   public void resume() {
     pauseLock.lock();
     try {
       isPaused = false;
       unpaused.signalAll();
     } finally {
       pauseLock.unlock();
     }
   }
 }
~~~



### å…³äºAQSçš„è¯´æ˜

#### æ¡†æ¶åŸºç¡€

AQSï¼Œçº¿ç¨‹åŒæ­¥å™¨å…¶å®å°±æ˜¯ä¸€ä¸ªè·å–å’Œé‡Šæ”¾å…±äº«èµ„æºï¼Œä»¥åŠè·å–å…±äº«èµ„æºå¤±è´¥å¦‚ä½•å¤„ç†çš„æ¡†æ¶ï¼Œåœ¨å…¶å†…éƒ¨ç»´æŠ¤äº†ä¸¤ä¸ªé‡è¦çš„ä¸œè¥¿ï¼š

- voliatle int state(ä»£è¡¨å…±äº«èµ„æº)ï¼Œè·å–å…±äº«èµ„æºå’Œé‡Šæ”¾å…±äº«èµ„æºçš„è¿‡ç¨‹å¤§è‡´ä¸Šå°±æ˜¯å¯¹å…±äº«èµ„æºçš„ä¿®æ”¹ã€‚

  ![image-20211017235902218](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20211017235902218.png)

- ä¸€ä¸ªFIFOçš„åŒå‘é“¾è¡¨(ä»£è¡¨æŠ¢é”å¤±è´¥çš„çº¿ç¨‹çš„ä¸€ä¸ªé˜Ÿåˆ—)ï¼Œ **å…¶åŸºç¡€é€»è¾‘å°±æ˜¯æŠŠè·å–å…±äº«èµ„æºå¤±è´¥çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ç»“å°¾ï¼Œå¹¶å°†çº¿ç¨‹parkä½ã€‚é˜Ÿåˆ—å¤´éƒ¨æ˜¯ä¸€ä¸ªä»£è¡¨å ç”¨çº¿ç¨‹çš„ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹é‡Šæ”¾å…±äº«èµ„æºçš„æ—¶å€™ä¼šå”¤é†’ä»–çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹(å¦‚æœéœ€è¦å”¤é†’çš„è¯)ã€‚**

AQSå®šä¹‰äº†ä¸¤ç§èµ„æºå…±äº«æ–¹å¼ï¼š**Exclusive(ç‹¬å ï¼Œå³æŸä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å¾—é”ï¼Œæ¯”å¦‚äº’æ–¥é”ReentrantLock)ï¼Œ Share(å…±äº«ï¼Œå³æŸä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹è·å¾—é”ï¼Œ æ¯”å¦‚Semaphoreã€CountDownLatch )ã€‚**

ä¸åŒçš„çº¿ç¨‹åŒæ­¥å™¨ç«äº‰å…±äº«èµ„æºçš„æ–¹å¼ä¹Ÿä¸åŒï¼Œä½¿ç”¨AQSçš„æ—¶å€™åªè¦å®ç°å¯¹å…±äº«èµ„æºstateçš„è·å–ä¸é‡Šæ”¾å³å¯ï¼Œè‡³äºå…·ä½“çš„è·å–èµ„æºå¤±è´¥çš„çº¿ç¨‹çš„é˜Ÿåˆ—çš„ç»´æŠ¤(è·å–èµ„æºå¤±è´¥å…¥é˜Ÿåˆ—ï¼Œé‡Šæ”¾èµ„æºå‡ºé˜Ÿåˆ—å¹¶å”¤é†’ä¸‹ä¸€èŠ‚ç‚¹ï¼Œ ä¸­æ–­æˆ–è€…è·å–èµ„æºè¶…æ—¶å‡ºé˜Ÿåˆ—)äº¤ç»™AQSç»´æŠ¤å°±å¥½äº†ã€‚**æ‰€ä»¥åœ¨æœ¬ç« ä¸­åªè®²è·å–æˆåŠŸå’Œå¤±è´¥ï¼Œé‡Šæ”¾æˆåŠŸå’Œå¤±è´¥å…±äº«èµ„æºåº”è¯¥å¦‚ä½•å¤„ç†çº¿ç¨‹ï¼Œè€Œä»€ä¹ˆæ—¶å€™åº”è¯¥æˆåŠŸå’Œå¤±è´¥åº”è¯¥æ˜¯AQSå­ç±»åº”è¯¥å¤„ç†çš„ã€‚**

è‡ªå®šä¹‰çš„åŒæ­¥å™¨å®ç°ä¸»è¦å¯ä»¥å®ç°ä¸€ä¸‹é›†ä¸­æ–¹æ³•ï¼š

~~~java
// å°è¯•ä»¥ç‹¬å çš„æ–¹å¼è·å–èµ„æºï¼ŒæˆåŠŸè¿”å›trueï¼Œå¦åˆ™false
protected boolean tryAcquire(int);
// å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸé‡Šæ”¾è¿”å›trueï¼Œ å¦åˆ™false
protected boolean tryRelease(int arg);

// å°è¯•ä»¥å…±äº«å…±äº«çš„æ–¹å¼è·å–èµ„æºï¼Œ è·å–å¤±è´¥è¿”å›è´Ÿå€¼ã€‚
// å¦‚æœåœ¨å…±äº«æ¨¡å¼ä¸‹è·å–æˆåŠŸä½†åç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¸èƒ½æˆåŠŸï¼Œåˆ™ä¸ºé›¶ã€‚
// å¦‚æœåœ¨å…±äº«æ¨¡å¼ä¸‹è·å–æˆåŠŸå¹¶ä¸”åç»­èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼è·å–ä¹Ÿå¯èƒ½æˆåŠŸï¼Œåˆ™ä¸ºæ­£å€¼ã€‚
protected int tryAcquireShared(int arg);
protected boolean tryReleaseShared(int arg);

// è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºï¼Œåªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å®ç°ä»–
protected boolean isHeldExclusively();
~~~

ä¸€èˆ¬æ¥è¯´ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨è¦ä¹ˆæ˜¯ç‹¬å æ–¹æ³•ï¼Œè¦ä¹ˆæ˜¯å…±äº«æ–¹å¼ï¼Œ**ä»–ä»¬ä¹Ÿåªéœ€å®ç°tryAcquire-tryReleaseã€tryAcquireShared-tryReleaseSharedä¸­çš„ä¸€ç§å³å¯**ã€‚ä½†AQSä¹Ÿæ”¯æŒè‡ªå®šä¹‰åŒæ­¥å™¨åŒæ—¶å®ç°ç‹¬å å’Œå…±äº«ä¸¤ç§æ–¹å¼ï¼Œå¦‚ReentrantReadWriteLockã€‚



#### èŠ‚ç‚¹çŠ¶æ€è§£æ

å¯¹äºæ¯ä¸€ä¸ªç­‰å¾…è·å–èµ„æºçš„çº¿ç¨‹ï¼Œ AQSéƒ½ä¼šå°†å…¶åŒ…è£…æˆä¸€ä¸ªNodeèŠ‚ç‚¹å¹¶æŠŠå®ƒåŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚NodeèŠ‚ç‚¹ä¸­åŒ…å«äº†ç­‰å¾…çº¿ç¨‹çš„å¼•ç”¨ï¼Œè¯¥çº¿ç¨‹è·å–é”çš„æ¨¡å¼(ç‹¬å /å…±äº«)ï¼Œå½“å‰èŠ‚ç‚¹çš„å‰åèŠ‚ç‚¹çš„å¼•ç”¨ï¼Œä»¥åŠæœ€é‡è¦çš„èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ï¼Œå…±æœ‰5ç§å–å€¼CANCELLEDã€SIGNALã€CONDITIONã€PROPAGATEã€0ã€‚

- **CANCELLED**(1)ï¼šè¡¨ç¤ºå½“å‰ç»“ç‚¹å·²å–æ¶ˆè°ƒåº¦ã€‚å½“timeoutæˆ–è¢«ä¸­æ–­ï¼ˆå“åº”ä¸­æ–­çš„æƒ…å†µä¸‹ï¼‰ï¼Œä¼šè§¦å‘å˜æ›´ä¸ºæ­¤çŠ¶æ€ï¼Œè¿›å…¥è¯¥çŠ¶æ€åçš„ç»“ç‚¹å°†ä¸ä¼šå†å˜åŒ–ã€‚
- **SIGNAL**(-1)ï¼šè¡¨ç¤ºåç»­ç»“ç‚¹æ­£åœ¨æˆ–è€…é©¬ä¸Šè¢«parkä½ï¼Œå½“å‰èŠ‚ç‚¹é‡Šæ”¾èµ„æºåéœ€è¦unparkåç»­èŠ‚ç‚¹
- **CONDITION**(-2)ï¼šè¡¨ç¤ºç»“ç‚¹ç­‰å¾…åœ¨Conditionä¸Šï¼Œå½“å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†Conditionçš„signal()æ–¹æ³•åï¼ŒCONDITIONçŠ¶æ€çš„ç»“ç‚¹å°†**ä»ç­‰å¾…é˜Ÿåˆ—è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­**ï¼Œç­‰å¾…è·å–åŒæ­¥é”ã€‚
- **PROPAGATE**(-3)ï¼šè¯¥çŠ¶æ€æ˜¯åªåœ¨å…±äº«æ¨¡å¼ä¸‹ä½¿ç”¨çš„ä¸€ä¸ªä¸­é—´çŠ¶æ€ï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªacquireSharedæ“ä½œéœ€è¦æ— æ¡ä»¶çš„å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¯¥çŠ¶æ€åç»­ä¸ºä¸“é—¨è®²åˆ°ã€‚
- **0**ï¼šæ–°ç»“ç‚¹å…¥é˜Ÿæ—¶çš„é»˜è®¤çŠ¶æ€ã€‚

æ³¨æ„ï¼Œ**è´Ÿå€¼è¡¨ç¤ºç»“ç‚¹å¤„äºæœ‰æ•ˆç­‰å¾…çŠ¶æ€ï¼Œè€Œæ­£å€¼è¡¨ç¤ºç»“ç‚¹å·²è¢«å–æ¶ˆã€‚æ‰€ä»¥æºç ä¸­å¾ˆå¤šåœ°æ–¹ç”¨>0ã€<0æ¥åˆ¤æ–­ç»“ç‚¹çš„çŠ¶æ€æ˜¯å¦æ­£å¸¸**ã€‚



#### ç‹¬å æ¨¡å¼è§£æ

> ä¸»è¦æ­¥éª¤

åœ¨AQSä¸­ä»¥ç‹¬å æ¨¡å¼è·å–å’Œé‡Šæ”¾å…±äº«èµ„æºçš„æ–¹æ³•æœ‰ä»¥ä¸‹å‡ ç§ï¼š

1. acquireï¼šä»¥ç‹¬å æ–¹å¼è·å–å…±äº«èµ„æºï¼Œå¿½ç•¥ä¸­æ–­ï¼Œç›´åˆ°è·å–åˆ°å…±äº«èµ„æºæ‰è¿”å›ã€‚
2. acquireInterruptiblyï¼šä»¥ç‹¬å æ–¹å¼è·å–å…±äº«èµ„æºï¼Œè·å–åˆ°å…±äº«èµ„æºæˆ–è€…ä¸­æ–­æ‰è¿”å›ã€‚
3. tryAcquireNanosï¼šä»¥ç‹¬å æ–¹å¼è·å–å…±äº«èµ„æºï¼Œè·å–åˆ°å…±äº«èµ„æºæˆ–è€…ä¸­æ–­æˆ–è€…è¶…æ—¶è¿”å›ã€‚
4. releaseï¼šä»¥ç‹¬å æ–¹å¼é‡Šæ”¾å…±äº«èµ„æºã€‚

å‰ä¸‰ä¸ªè·å–é”çš„æ­¥éª¤éƒ½æ˜¯å¤§åŒå°å¼‚ï¼Œåªåœ¨ä¸ªåˆ«åœ°æ–¹æœ‰å·®å¼‚ã€‚

ç‹¬å æ¨¡å¼ä¸‹è·å–å…±äº«èµ„æºçš„æ­¥éª¤å¤§ä½“å¦‚ä¸‹ï¼š

1. è°ƒç”¨tryAcquireæ–¹æ³•å°è¯•è·å–èµ„æºï¼Œè·å–æˆåŠŸç›´æ¥è¿”å›
2. è·å–å¤±è´¥è°ƒç”¨addWaiterå°†å½“å‰çº¿ç¨‹åŒ…è£…æˆNodeèŠ‚ç‚¹å¹¶åŠ å…¥åˆ°åŒå‘é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚
3. è°ƒç”¨acquireQueuedæ–¹æ³•ä½¿çº¿ç¨‹å µå¡ï¼Œè¯¥å µå¡çº¿ç¨‹å°†ä¼šè¢«é‡Šæ”¾å…±äº«èµ„æºçš„çº¿ç¨‹å”¤é†’ç„¶åå†æ¬¡ç«äº‰å…±äº«èµ„æºï¼Œå¤±è´¥å†æ¬¡å µå¡ï¼Œä¸€ç›´å¾ªç¯ï¼Œç›´åˆ°è·å–åˆ°å…±äº«èµ„æºç„¶åè¿”å›ã€‚
4. å¦‚æœçº¿ç¨‹åœ¨å µå¡è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼Œ å°†ä¼šæ¸…é™¤ä¸­æ–­ä½å¹¶æ ‡è®°èµ·æ¥ã€‚å¦‚æœè·å–èµ„æºæˆåŠŸåï¼Œæœ‰æ ‡è®°çš„è¯å°±è‡ªå·±è°ƒç”¨interruptæ–¹æ³•ä¸­æ–­è‡ªå·±è¡¥ä¸€ä¸ªä¸­æ–­ä½ã€‚



> acquire(int)

ä¸‹é¢æ˜¯æºç è§£æï¼Œä¸»è¦ä»¥acquireä¸ºä¾‹ï¼Œè¯¥æ–¹æ³•æ—¶ç‹¬å æ¨¡å¼ä¸‹çº¿ç¨‹è·å–å…±äº«èµ„æºçš„é¡¶å±‚å…¥å£

~~~java
    public final void acquire(int arg) {
        if (!tryAcquire(arg) &&
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
            selfInterrupt();
    }
~~~

å‡½æ•°æµç¨‹å¦‚ä¸‹ï¼š

1. tryAcquireå°è¯•è·å–å…±äº«èµ„æºï¼Œå¦‚æœæˆåŠŸç›´æ¥è¿”å›ï¼Œè¿™é‡Œä½“ç°äº†éå…¬å¹³é”ï¼Œæ¯ä¸ªçº¿ç¨‹è·å–é”æ—¶ä¼šå°è¯•ç›´æ¥æŠ¢å åŠ å¡ä¸€æ¬¡ï¼Œè€ŒCLHé˜Ÿåˆ—ä¸­å¯èƒ½è¿˜æœ‰åˆ«çš„çº¿ç¨‹åœ¨ç­‰å¾…ã€‚
2. è·å–å…±äº«èµ„æºå¤±è´¥å°±é€šè¿‡addWaiterå°†å½“å‰çº¿ç¨‹åŒ…è£…æˆNodeèŠ‚ç‚¹å¹¶åŠ å…¥åˆ°åŒå‘é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶æ ‡è®°ä¸ºç‹¬å æ¨¡å¼ï¼Œè¿”å›æ–°æ·»åŠ çš„Node
3. è°ƒç”¨acquireQueuedï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å µå¡ï¼Œè¢«å”¤é†’ï¼Œä¸€ç›´å¾ªç¯ç›´åˆ°è·å–åˆ°å…±äº«èµ„æºï¼Œå¦‚æœè¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡è¿”å›trueï¼Œå¦åˆ™false
4. å¦‚æœacquireQueuedè¿”å›trueï¼Œè¯´æ˜è¢«ä¸­æ–­è¿‡ï¼Œæ•´ä¸ªifä¸­çš„æ¡ä»¶æˆç«‹ï¼Œè°ƒç”¨selfInterruptè‡ªå·±ä¸­æ–­è‡ªå·±è¡¥ä¸€ä¸ªä¸­æ–­ä½

**éœ€è¦æ³¨æ„çš„æ˜¯tryAcquireæ˜¯éœ€è¦å­ç±»å»å®ç°ä½•æ—¶å¯ä»¥è·å–å…±äº«èµ„æºæˆåŠŸçš„ï¼ŒAQSå¹¶ä¸è´Ÿè´£è¿™ä¸ªã€‚æ‰€ä»¥åœ¨è¿™é‡Œå¹¶ä¸è®¨è®ºï¼Œåªè¯´æ˜è·å–å¤±è´¥åå¦‚ä½•å¤„ç†ã€‚**

### çº¿ç¨‹æ± æºç 

é—®é¢˜ï¼š 

çŠ¶æ€åˆ¤æ–­

![image-20211022110755904](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20211022110755904.png)



ä¸ºä½•é‡æ–°åˆ¤æ–­

![image-20211022110856255](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20211022110856255.png)







é‡Šæ”¾å…±äº«èµ„æºçš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. è°ƒç”¨tryReleaseå°è¯•é‡Šæ”¾å…±äº«èµ„æºï¼Œå¦‚æœé‡Šæ”¾å¤±è´¥ç›´æ¥è¿”å›ã€‚
2. å¦‚æœé‡Šæ”¾å…±äº«èµ„æºæˆåŠŸï¼Œå‚çœ‹é˜Ÿåˆ—å¤´ç»“ç‚¹çš„waitStatusçœ‹æ˜¯å¦éœ€è¦å”¤é†’åç»§èŠ‚ç‚¹çš„çº¿ç¨‹ã€‚

### å¯ç›‘æ§çš„çº¿ç¨‹æ± 

https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html

https://juejin.cn/post/7074579161201229838





### çº¿ç¨‹æ± 

> åŸºæœ¬æ¦‚è¿°

```
/**
 * å½“é€šè¿‡executeæäº¤æ–¹æ³•çš„æ—¶å€™, å¦‚æœçº¿ç¨‹æ•°é‡å°äºcorePoolSize, é‚£ä¹ˆä¼šåˆ›å»ºæ–°çº¿ç¨‹æ¥å¤„ç†è¯¥è¯·æ±‚, å³ä½¿å…¶ä»–çº¿ç¨‹ç©ºé—²
 * å¦åˆ™ä¼šå°†ä»–ä»¬æ”¾åœ¨é˜Ÿåˆ—ä¸­, å¦‚æœé˜Ÿåˆ—ä¹Ÿå·²ç»æ»¡äº†, é‚£ä¹ˆä¼šåˆ›å»ºæ–°çº¿ç¨‹æ¥å¤„ç†æ–°è¯·æ±‚
 * å¦‚æœçº¿ç¨‹æ•°ç­‰äºmaximumPoolSize, é‚£ä¹ˆä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥
 *
 * å½“poolä¸­çº¿ç¨‹è¶…è¿‡corePoolSizeçš„çº¿ç¨‹, é‚£ä¹ˆå¤šä½™çš„çº¿ç¨‹å¦‚æœç©ºé—²æ—¶é—´è¶…è¿‡keepAliveTime, å°†ä¼šè¢«ç»ˆæ­¢
 *
 * é˜Ÿåˆ—ä¸€èˆ¬æœ‰ä¸‰ç§:
 *   1. SynchronousQueue,
 *   2. ArrayBlockingQueue, æœ‰ç•Œé˜Ÿåˆ—
 *   3. LinkedBlockingQueue(æ²¡æœ‰é¢„å®šä¹‰å®¹é‡çš„æƒ…å†µä¸‹), æ— ç•Œé˜Ÿåˆ—
 *
 * æ‹’ç»ç­–ç•¥æœ‰å››ç§:
 *   1. AbortPolicy, æŠ›å‡ºRejectedExecutionException
 *   2. CallerRunsPolicy, åœ¨callerçº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡
 *   3. Discard, ç›´æ¥ä¸¢å¼ƒ
 *   4. DiscardOldestPolicy, ä¸¢å¼ƒé˜Ÿåˆ—å¤´éƒ¨çš„ä»»åŠ¡
 */
```

> çº¿ç¨‹æ± å±æ€§æ ‡è¯†ä»¥åŠçŠ¶æ€æµè½¬

```java
    // intçš„åŸå­ç±»
    // é«˜3ä½: çº¿ç¨‹æ± çŠ¶æ€
    // ä½29ä½: çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¸ªæ•°
    private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
    private static final int COUNT_BITS = Integer.SIZE - 3;
    private static final int COUNT_MASK = (1 << COUNT_BITS) - 1;
    // çº¿ç¨‹æ± çš„çŠ¶æ€
    private static final int RUNNING    = -1 << COUNT_BITS;
    private static final int SHUTDOWN   =  0 << COUNT_BITS;
    private static final int STOP       =  1 << COUNT_BITS;
    private static final int TIDYING    =  2 << COUNT_BITS;
    private static final int TERMINATED =  3 << COUNT_BITS;
    // Packing and unpacking ctl
    private static int runStateOf(int c)     { return c & ~COUNT_MASK; }
    private static int workerCountOf(int c)  { return c & COUNT_MASK; }
    private static int ctlOf(int rs, int wc) { return rs | wc; }
```

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830183852132.png" alt="image-20230830183852132" style="zoom: 50%;" />

> commandçš„åŒ…è£…

æˆ‘ä»¬é€šè¿‡submitåˆ›å»ºcommandç»™çº¿ç¨‹æ± å, ä»–ä¼šåŒ…è£…ä¸ºä¸€ä¸ªRunnableFutureå¯¹è±¡, 

~~~java
public <T> Future<T> submit(Callable<T> task) {
        if (task == null) throw new NullPointerException();
        RunnableFuture<T> ftask = newTaskFor(task);
        execute(ftask);
        return ftask;
}
~~~

RunnableFutureæœ‰å¦‚ä¸‹å‡ ç§çŠ¶æ€

~~~java
    private volatile int state;
    private static final int NEW          = 0; // åˆå§‹çŠ¶æ€, ä»»åŠ¡å¯èƒ½æ²¡æœ‰æ‰§è¡Œ, ä¹Ÿå¯èƒ½æ­£åœ¨æ‰§è¡Œ
    private static final int COMPLETING   = 1; // ä»»åŠ¡å·²ç»å®Œæˆäº†, æ­£åœ¨è®¾ç½®outcome
    private static final int NORMAL       = 2; // è®¾ç½®outcomeå®Œæˆ, ä»»åŠ¡æ­£å¸¸å®Œæˆ
    private static final int EXCEPTIONAL  = 3; // è®¾ç½®outcomeå®Œæˆ, ä»»åŠ¡å‡ºç°å¼‚å¸¸, outcomeå°±æ˜¯å¼‚å¸¸
    private static final int CANCELLED    = 4; // ä»»åŠ¡å·²ç»è¢«å–æ¶ˆäº†, å¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œ, é‚£ä¹ˆä¸ä¼šæ‰§è¡Œäº†, å¦‚æœå·²ç»æ‰§è¡Œäº†, é‚£å°±è®©ä»–æ‰§è¡Œ
    private static final int INTERRUPTING = 5; // ä»»åŠ¡å·²ç»è¢«å–æ¶ˆäº†, å¦‚æœä»»åŠ¡è¿˜æ²¡æ‰§è¡Œ, é‚£ä¹ˆå°±ä¸æ‰§è¡Œäº†, å¦‚æœå·²ç»ä»”ç»†äº†, é‚£ä¹ˆä¸­æ–­ä»–
    private static final int INTERRUPTED  = 6; // ä»»åŠ¡ä¸­æ–­å®Œæ¯•
~~~



<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830190710243.png" alt="image-20230830190710243" style="zoom:25%;" />

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹RunnableFutureçš„runæ–¹æ³•

~~~java
    public FutureTask(Callable<V> callable) {
        if (callable == null)
            throw new NullPointerException();
        this.callable = callable;
        this.state = NEW;       // ensure visibility of callable
    }
	public void run() {
        // å¦‚æœå½“å‰stateä¸ä¸ºnew,
        // æˆ–è€…å½“å‰stateä¸ºnew, ä½†æ˜¯cas è®¾ç½®runnerä¸ºå½“å‰çº¿ç¨‹å¤±è´¥
        // éƒ½è¯´æ˜äº†å½“å‰taskå·²ç»æœ‰åˆ«çš„çº¿ç¨‹æ‰§è¡Œäº†
        if (state != NEW ||
                !UNSAFE.compareAndSwapObject(this, runnerOffset,
                        null, Thread.currentThread()))
            return;
        try {
            Callable<V> c = callable;
            if (c != null && state == NEW) {
                V result;
                boolean ran;
                try {
                    result = c.call(); // æ‰§è¡Œcallæ–¹æ³•, è·å¾—è¿”å›å€¼
                    ran = true; // æ ‡è®°ä¸ºæ­£å¸¸ç»“æŸ
                } catch (Throwable ex) {
                    result = null;
                    ran = false; // æ ‡è®°ä¸ºå¼‚å¸¸ç»“æŸ
                    // è®¾ç½®exä¸ºoutcome
                    // è¯¥æ–¹æ³•ä¼šå°†çŠ¶æ€ä»new -> completing, ç„¶åèµ‹å€¼outcome, ç„¶åå°†çŠ¶æ€æ”¹ä¸ºexceptional
                    setException(ex);
                }
                if (ran)
                    // æ­£å¸¸ç»“æŸ
                    // å°†çŠ¶æ€ä»new -> completing, ç„¶åèµ‹å€¼outcome, ç„¶åå°†çŠ¶æ€æ”¹ä¸ºnormal
                    set(result);
            }
        } finally {
            // runner must be non-null until state is settled to
            // prevent concurrent calls to run()
            runner = null; // é‡ç½®runner
            // state must be re-read after nulling runner to prevent
            // leaked interrupts
            int s = state;
            // åˆ¤æ–­å½“å‰ä»»åŠ¡çš„çŠ¶æ€æ˜¯å¦è¢«ä¸­æ–­, å¹¶åšå“åº”çš„å¤„ç†
            if (s >= INTERRUPTING)
                handlePossibleCancellationInterrupt(s);
        }
        
        
    // å–æ¶ˆæ‰ä»»åŠ¡, mayInterruptIfRunningè¡¨ç¤ºåœ¨å–æ¶ˆçš„æ—¶å€™, æ˜¯å¦è¦ä¸­æ–­ä»»åŠ¡
    // å¦‚æœä¸ºfalse, é‚£ä¹ˆå¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œ, å°±ä¸ä¼šæ‰§è¡Œäº†, å¦‚æœæ­£åœ¨æ‰§è¡Œ, é‚£ä¹ˆå°±è®©ä»–æ‰§è¡Œå®Œæ¯•ä½†æ˜¯ä¸èµ‹å€¼outcome
    // å¦‚æœä¸ºtrue, é‚£ä¹ˆå¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œ, å°±ä¸ä¼šæ‰§è¡Œäº†, å¦‚æœæ­£åœ¨æ‰§è¡Œ, é‚£ä¹ˆå°±ä¸­æ–­ä»–åŒæ—¶ä¸èµ‹å€¼outcome
    // å¦‚æœå½“å‰ä»»åŠ¡æ­£åœ¨å µå¡, é‚£ä¹ˆcallable.runæ–¹æ³•ä¼šæŠ›å‡ºInterruptedException
    public boolean cancel(boolean mayInterruptIfRunning) {
        // å¦‚æœstateä¸æ˜¯new, æˆ–è€…caså°†çŠ¶æ€æ”¹ä¸ºINTERRUPTING, CANCELLEDå¤±è´¥, 
        // è¯´æ˜ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œäº†, æ— æ³•å–æ¶ˆ
        // å¦‚æœmayInterruptIfRunningä¸ºfalse, é‚£ä¹ˆä»…ä»…åªæ˜¯åˆ‡æ¢äº†çŠ¶æ€, æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¼šæ­£å¸¸æ‰§è¡Œå®Œæ¯•, åªæ˜¯ä¸ä¼šèµ‹å€¼outcome
        if (!(state == NEW &&
                UNSAFE.compareAndSwapInt(this, stateOffset, NEW,
                        mayInterruptIfRunning ? INTERRUPTING : CANCELLED)))
            // è¿”å›false, è¡¨ç¤ºæ— æ³•å–æ¶ˆ
            return false;
        try {    // in case call to interrupt throws exception
            // å¦‚æœmayInterruptIfRunningä¸ºtrue, ä¸­æ–­çº¿ç¨‹
            if (mayInterruptIfRunning) {
                try {
                    Thread t = runner;
                    if (t != null)
                        t.interrupt();
                } finally { // final state
                    UNSAFE.putOrderedInt(this, stateOffset, INTERRUPTED);
                }
            }
        } finally {
            finishCompletion();
        }
        // å–æ¶ˆä»»åŠ¡æˆåŠŸ
        return true;
    }
~~~

> çº¿ç¨‹æ± çš„æ‰§è¡Œ

çº¿ç¨‹æ± å°†Runnableçš„ä»»åŠ¡åŒ…è£…æˆä¸€ä¸ªFutureTaskä¹‹å, å¼€å§‹æ‰§è¡Œä»»åŠ¡

~~~java
public void execute(Runnable command) {
        if (command == null)
            throw new NullPointerException();
        int c = ctl.get();
        // å¦‚æœworkeræ•°é‡ < corePoolSize
        if (workerCountOf(c) < corePoolSize) {
            // æ–°å»ºæ ¸å¿ƒçº¿ç¨‹å¹¶æ·»åŠ worker
            // å¹¶å‘æ“ä½œå¯èƒ½ä¼šå¯¼è‡´æ·»åŠ æ ¸å¿ƒworkerå¤±è´¥
            if (addWorker(command, true))
                return;
            c = ctl.get(); // æ·»åŠ æ ¸å¿ƒçº¿ç¨‹å¤±è´¥, è¯´æ˜æœ‰å¹¶å‘, éœ€è¦é‡æ–°è·å–ctl
        }
        // å¦‚æœçº¿ç¨‹æ± æ˜¯running, å¹¶ä¸”å¦‚æœworkeræ•°é‡ >= corePoolSize, æˆ–è€…æ·»åŠ workerå¤±è´¥
        // é‚£ä¹ˆå°†commandæ·»åŠ åˆ°queueä¸­
        if (isRunning(c) && workQueue.offer(command)) {
            int recheck = ctl.get();
            // é‡æ–°æ£€æŸ¥æ˜¯å¦ä¸ºrunning, å¦‚æœä¸æ˜¯, é‚£ä¹ˆremoveå¹¶ä¸”rejectæ‰command
            if (! isRunning(recheck) && remove(command))
                reject(command);
            // å¦‚æœè¿˜æ˜¯running, é‚£ä¹ˆè¿˜è¦æ£€æµ‹ä¸€ä¸‹workeræ˜¯å¦ä¸º0
            // å¦‚æœallowCoreThreadPool=true, é‚£ä¹ˆæ ¸å¿ƒçº¿ç¨‹ä¹Ÿä¼šæ¶ˆäº¡
            // å°±æ€•è¿›å…¥åˆ°è¿™é‡Œçš„æ—¶å€™, æ ¸å¿ƒçº¿ç¨‹é›†ä½“æ¶ˆäº¡
            else if (workerCountOf(recheck) == 0)
                addWorker(null, false);
        }
        // å¦‚æœæ·»åŠ åˆ°queueä¸­å¤±è´¥, é‚£ä¹ˆå°è¯•åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹, å¹¶æ‰§è¡Œworker
        else if (!addWorker(command, false))
            // å¦‚æœåˆ›å»ºéæ ¸å¿ƒçš„workerä¹Ÿå¤±è´¥, é‚£ä¹ˆç›´æ¥æ‹’ç»command
            reject(command);
    }
~~~

~~~java
// å¦‚æœfirstTaskä¸ä¸ºnull, é‚£ä¹ˆæ˜¯æ­£å¸¸çš„æ·»åŠ worker
    // å¦‚æœfirstTaskä¸ºnull, é‚£ä¹ˆå°±æ˜¯æ·»åŠ ä¸€ä¸ªworkeræ¥å¤„ç†queueä¸­çš„ä»»åŠ¡, é˜²æ­¢queueä¸­è¿˜æœ‰ä»»åŠ¡, ä½†æ˜¯workerå·²ç»å…¨éƒ¨ggäº†
    private boolean addWorker(Runnable firstTask, boolean core) {
        retry:
        for (int c = ctl.get();;) {
            /*
                æ¡ä»¶å¯ä»¥æ”¹å†™ä¸º
                    (runStateAtLeast(c, SHUTDOWN) && runStateAtLeast(c, STOP)) ||
                    (runStateAtLeast(c, SHUTDOWN) && firstTask != null)  ||
                    (runStateAtLeast(c, SHUTDOWN) && workQueue.isEmpty())
                ç„¶åæ”¹å†™ä¸º
                    (runStateAtLeast(c, SHUTDOWN) && runStateAtLeast(c, STOP)) ||
                    (runStateAtLeast(c, SHUTDOWN) && (firstTask != null || workQueue.isEmpty())

                (runStateAtLeast(c, SHUTDOWN) && runStateAtLeast(c, STOP)) è¡¨ç¤º
                    å¦‚æœçŠ¶æ€è‡³å°‘æ˜¯stop, é‚£ä¹ˆçŠ¶æ€å¯èƒ½æ˜¯stop tiding terminated, è¿™äº›çŠ¶æ€ä¸æ¥å—æ–°ä»»åŠ¡äº†

                (runStateAtLeast(c, SHUTDOWN) && (firstTask != null || workQueue.isEmpty())
                    å¦‚æœä¸Šé¢æƒ…å†µä¸æˆç«‹, é‚£ä¹ˆå½“å‰çŠ¶æ€å¯èƒ½æ˜¯runningå’Œstop, å¦‚æœrunStateAtLeast(c, SHUTDOWN) æˆç«‹, é‚£ä¹ˆçŠ¶æ€åªèƒ½æ˜¯shutdown
                    ä¹Ÿå°±æ˜¯è¯´å¦‚æœçŠ¶æ€æ˜¯shutdown, å¹¶ä¸”firstTaskä¸ä¸ºnullæˆ–è€…workQueueä¸æ˜¯ç©ºçš„, é‚£ä¹ˆä¸èƒ½æ·»åŠ worker
                    ä¹Ÿå°±æ˜¯è¯´å¦‚æœçŠ¶æ€æ˜¯shutdown, é‚£ä¹ˆåªæœ‰firstTaskä¸ºnull, å¹¶ä¸”queueä¸ä¸ºç©ºçš„æƒ…å†µä¸‹æ‰èƒ½æ·»åŠ worker, é˜²æ­¢queueä¸­çš„ä»»åŠ¡æ²¡æœ‰workeræ¥å¤„ç†

             */
            // å¦‚æœçŠ¶æ€è‡³å°‘æ˜¯stop, é‚£ä¹ˆä¸èƒ½æ·»åŠ worker, æˆ–è€…å¦‚æœçŠ¶æ€æ˜¯shutdown, é‚£ä¹ˆåªæœ‰firstTaskä¸ºnull, å¹¶ä¸”queueä¸ä¸ºç©ºçš„æƒ…å†µä¸‹æ‰èƒ½æ·»åŠ worker
            // !!!!!!!!!!!!!!!!!! ä¹Ÿå°±æ˜¯è¯´è¦ä¹ˆçŠ¶æ€æ˜¯running, è¦ä¹ˆçŠ¶æ€æ˜¯shutdownå¹¶ä¸”firstTaskä¸ºnull, å¹¶ä¸”queueä¸ä¸ºç©º, æ‰æœ‰å¯èƒ½è·³è¿‡è¿™ä¸ªæ¡ä»¶ !!!!!!!
            if (runStateAtLeast(c, SHUTDOWN)
                    && (runStateAtLeast(c, STOP)
                    || firstTask != null
                    || workQueue.isEmpty()))
                return false;
            for (;;) {
                // è¿™ä¸ªæ¡ä»¶åœ¨jdk1.8æ˜¯  workerCountOf(c) >= CAPACITY || workerCountOf(c) >= (core ? corePoolSize : maximumPoolSize)
                // å³å¦‚æœçº¿ç¨‹æ•°å·²ç»åˆ°è¾¾å®¹é‡ä¸Šçº¿äº†( 2^29 -1 ), é‚£ä¹ˆåˆ›å»ºå¤±è´¥
                // æˆ–è€…å¦‚æœåˆ›å»ºçš„æ˜¯æ ¸å¿ƒçº¿ç¨‹æ•°, å¹¶ä¸”workerå·²ç»å¤§äºcorePoolSizeäº†, ä¹Ÿåˆ›å»ºå¤±è´¥
                // æˆ–è€…åˆ›å»ºçš„æ˜¯éæ ¸å¿ƒçº¿ç¨‹æ•°, å¹¶ä¸”workerå·²ç»å¤§äºmaximumPoolSizeäº†, ä¹Ÿåˆ›å»ºå¤±è´¥
                if (workerCountOf(c)
                        >= ((core ? corePoolSize : maximumPoolSize) & COUNT_MASK))
                    return false;
                // å°†workeræ•°é‡+1, å¦‚æœæˆåŠŸ, é‚£ä¹ˆè·³å‡ºè‡ªæ—‹
                if (compareAndIncrementWorkerCount(c))
                    break retry;

                c = ctl.get();  // caså¤±è´¥, é‡æ–°åŠ è½½ctl

                // ä¸Šé¢å·²ç»è¯´äº†, æ‰§è¡Œåˆ°è¿™é‡Œ, è¦ä¹ˆçŠ¶æ€æ˜¯running, è¦ä¹ˆçŠ¶æ€æ˜¯shutdownå¹¶ä¸”firstTaskä¸ºnull, å¹¶ä¸”queueä¸ä¸ºç©º
                // æ‰€ä»¥å¦‚æœçŠ¶æ€è¿˜æ˜¯shutdown, é‚£ä¹ˆå°±è¦åœ¨å¤–å±‚forå¾ªç¯ä¸­è‡ªæ—‹é‡æ–°åˆ¤æ–­firstTaskå’Œqueueæ˜¯å¦æ»¡è¶³æ¡ä»¶
                // å¦‚æœçŠ¶æ€æ˜¯running, é‚£ä¹ˆåªéœ€è¦åœ¨å†…å±‚å¾ªç¯ä¸­caså°†workeræ•°é‡+1å°±å¥½äº†
                if (runStateAtLeast(c, SHUTDOWN))
                    // è¿›è¡Œå¤–å±‚cas
                    continue retry;
                // è¿›è¡Œå†…å±‚cas
            }
        }

        // æ‰§è¡Œåˆ°è¿™é‡Œ, è¦ä¹ˆstateæ˜¯running, è¦ä¹ˆstateæ˜¯shutdownå¹¶ä¸”firstTaskä¸ºnull, å¹¶ä¸”queueä¸ä¸ºç©º
        // å¹¶ä¸”å·²ç»å°†workeræ•°é‡åŠ 1äº†
        // æ¥ä¸‹æ¥å°±è¦åˆ›å»ºworkeräº†
        boolean workerStarted = false;
        boolean workerAdded = false;
        Worker w = null;
        try {
            w = new Worker(firstTask); // åˆ›å»ºworker
            final Thread t = w.thread;
            if (t != null) {
                final ReentrantLock mainLock = this.mainLock;
                mainLock.lock(); // åŠ é”, é˜²æ­¢åˆ›å»ºworkerçš„æ—¶å€™åˆ«çš„çº¿ç¨‹è°ƒç”¨shutdownç­‰æ–¹æ³•å¹²æ‰çº¿ç¨‹æ± , å¹²æ‰çº¿ç¨‹æ± éœ€è¦å…ˆè·å–é”
                try {
                    // Recheck while holding lock.
                    // Back out on ThreadFactory failure or if
                    // shut down before lock acquired.
                    int c = ctl.get();

                    // å¦‚æœçŠ¶æ€æ˜¯running, æˆ–è€…çŠ¶æ€æ˜¯shutdownå¹¶ä¸”firstTaskä¸ºnull
                    if (isRunning(c) ||
                            (runStateLessThan(c, STOP) && firstTask == null)) {
                        if (t.getState() != Thread.State.NEW)
                            throw new IllegalThreadStateException();
                        // æ·»åŠ çº¿ç¨‹åˆ°é›†åˆä¸­
                        workers.add(w);
                        workerAdded = true;
                        int s = workers.size();
                        if (s > largestPoolSize)
                            largestPoolSize = s; //è®°å½•çº¿ç¨‹æ± è¾¾åˆ°çš„æœ€å¤§çº¿ç¨‹æ•°é‡
                    }
                } finally {
                    mainLock.unlock();
                }
                if (workerAdded) {
                    t.start(); // å¯åŠ¨çº¿ç¨‹, æœ‰å¯èƒ½è¿™ä¸ªçº¿ç¨‹çš„startæ–¹æ³•å·²ç»è¢«åˆ«äººè°ƒç”¨è¿‡äº†, ä¼šæŠ¥é”™
                    workerStarted = true;
                }
            }
        } finally {
            if (! workerStarted)
                // å¦‚æœçº¿ç¨‹çš„startæ–¹æ³•è¢«åˆ«äººè°ƒç”¨è¿‡äº†,
                // é‚£ä¹ˆå°†workeræ•°é‡-1, ä»workeré›†åˆä¸­ç§»é™¤worker, å°è¯•å…³é—­çº¿ç¨‹æ± 
                addWorkerFailed(w);
        }
        return workerStarted;
    }
~~~

æˆ‘ä»¬æ¥çœ‹çœ‹workerçº¿ç¨‹åˆ°åº•æ˜¯æ€ä¹ˆæ‰§è¡Œçš„

~~~java
public void run() {
    runWorker(this);
}
final void runWorker(Worker w) {
        Thread wt = Thread.currentThread();
        Runnable task = w.firstTask; // è·å–workerçš„ä»»åŠ¡
        w.firstTask = null; // æ¸…é™¤workerçš„ä»»åŠ¡
        w.unlock(); // allow interrupts

        // çº¿ç¨‹æœ‰ä¸¤ç§æƒ…å†µä¼šé€€å‡ºè¿è¡Œ: 1. æ‹¿ä¸åˆ°ä»»åŠ¡, è‡ªåŠ¨æ¶ˆäº¡  2. æ‰§è¡Œtaskè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸
        // è¿™ä¸ªæ ‡è¯†çº¿ç¨‹æ˜¯å¦æ˜¯å› ä¸ºç”¨æˆ·çš„Exceptionè€Œé€€å‡ºè¿è¡Œçš„
        boolean completedAbruptly = true;
        try {
            // å¦‚æœtaskä¸ä¸ºç©º
            // å¦‚æœtaskä¸ºç©º, å°±ä»queueä¸­è·å–task
            while (task != null || (task = getTask()) != null) {
                w.lock();
                // If pool is stopping, ensure thread is interrupted;
                // if not, ensure thread is not interrupted.  This
                // requires a recheck in second case to deal with
                // shutdownNow race while clearing interrupt
                // å¦‚æœçº¿ç¨‹æ± çŠ¶æ€è‡³å°‘æ˜¯stop, å³stop tiding terminated, é‚£ä¹ˆè¦å¯¹çº¿ç¨‹è¿›è¡Œä¸­æ–­
                if ((runStateAtLeast(ctl.get(), STOP) ||
                        (Thread.interrupted() &&
                                runStateAtLeast(ctl.get(), STOP))) &&
                        !wt.isInterrupted())
                    wt.interrupt();
                try {
                    beforeExecute(wt, task); // æ‰§è¡Œé’©å­
                    try {
                        task.run();
                        afterExecute(task, null); // æ‰§è¡Œé’©å­
                    } catch (Throwable ex) {
                        afterExecute(task, ex); // æ‰§è¡Œé’©å­
                        throw ex;
                    }
                } finally {
                    task = null;
                    w.completedTasks++;
                    w.unlock();
                }
            }
            completedAbruptly = false; // éç”¨æˆ·å¼‚å¸¸è€Œé€€å‡ºè¿è¡Œ
        } finally {
            // æ²¡æœ‰æ‹‰åˆ°ä»»åŠ¡, è¦çº¿ç¨‹æ¶ˆäº¡,
            // å¯èƒ½æ˜¯å› ä¸ºçŠ¶æ€æ˜¯stop, ä¹Ÿå¯èƒ½æ˜¯çŠ¶æ€æ˜¯shutdownå¹¶ä¸”queueä¸ºç©ºäº†
            // ä¹Ÿæœ‰å¯èƒ½å°±æ˜¯ç®€å•çš„æ²¡æ‹¿åˆ°ä»»åŠ¡è¶…æ—¶äº†
            // ä¹Ÿæœ‰å¯èƒ½æ˜¯ç”¨æˆ·çš„ä»»åŠ¡æŠ¥é”™äº†
            processWorkerExit(w, completedAbruptly);
        }
    }
~~~

ä¸Šé¢å¯ä»¥çœ‹åˆ°, å¦‚æœä¸€ä¸ªçº¿ç¨‹æ‹‰ä¸åˆ°ä»»åŠ¡, å°±ä¼šæ¶ˆäº¡æ‰, é‚£ä¹ˆä¸‹é¢çœ‹çœ‹åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šæ‹‰å–ä¸åˆ°ä»»åŠ¡

~~~java
private Runnable getTask() {
        boolean timedOut = false; // Did the last poll() time out?

        for (;;) {
            int c = ctl.get();

            // åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€
            // å¦‚æœçŠ¶æ€è‡³å°‘æ˜¯stop, é‚£ä¹ˆä¸æ¥å—ä»»åŠ¡äº†, ç›´æ¥è¿”å›null, è®©çº¿ç¨‹æ¶ˆäº¡
            // æˆ–è€…çŠ¶æ€æ˜¯shutdownå¹¶ä¸”queueå·²ç»ç©ºäº†, è¡¨ç¤ºå¤„ç†å®Œäº†ä»»åŠ¡äº†, ä¹Ÿè¦è®©çº¿ç¨‹æ¶ˆäº¡æ‰
            if (runStateAtLeast(c, SHUTDOWN)
                    && (runStateAtLeast(c, STOP) || workQueue.isEmpty())) {
                decrementWorkerCount();
                return null;
            }

            int wc = workerCountOf(c);

            // Are workers subject to culling?
            // åˆ¤æ–­å½“å‰çº¿ç¨‹åœ¨poolä»»åŠ¡çš„æ—¶å€™æ˜¯å¦è¦è®¾ç½®è¶…æ—¶æ—¶é—´
            // å¦‚æœè®¾ç½®äº†allowCoreThreadTimeOut, æˆ–è€…workeræ•°é‡å¤§äºcorePoolSize
            // è¿™ä¸ªæ—¶å€™è¦æ˜¯æ‹‰å–ä¸åˆ°ä»»åŠ¡, çº¿ç¨‹å°±è¦æ¶ˆäº¡
            boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;

            // æ²¡çœ‹æ‡‚è¿™ä¸ªæ¡ä»¶, ä½†æ˜¯å¯ä»¥è‚¯å®š, è¶…æ—¶çš„çº¿ç¨‹ä¼šè¿”å›nullæ¶ˆäº¡
            if ((wc > maximumPoolSize || (timed && timedOut))
                    && (wc > 1 || workQueue.isEmpty())) {
                if (compareAndDecrementWorkerCount(c))
                    return null;
                continue; // è‡ªæ—‹
            }

            try {
                Runnable r = timed ?
                        workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                        workQueue.take();
                if (r != null)
                    return r;
                timedOut = true; // æ‹‰åˆ°äº†ä»»åŠ¡å°±ç›´æ¥è¿”å›äº†, è¿™é‡Œæ‹‰ä¸åˆ°ä»»åŠ¡, æ‰€ä»¥è®¾ç½®timeout, ç„¶åè‡ªæ—‹é‡æ–°
            } catch (InterruptedException retry) {
                timedOut = false;
            }
        }
    }
~~~

åŒæ—¶ä¸‹é¢çœ‹çœ‹çº¿ç¨‹æ˜¯å¦‚ä½•æ¶ˆäº¡çš„

~~~java
private void processWorkerExit(Worker w, boolean completedAbruptly) {
        // å¦‚æœæ˜¯å› ä¸ºç”¨æˆ·ä»»åŠ¡æŠ¥é”™, å¯¼è‡´çº¿ç¨‹æ¶ˆäº¡, é‚£ä¹ˆè¦çº¿ç¨‹æ•°-1
        // å¦‚æœæ˜¯getä¸åˆ°ä»»åŠ¡è€Œå¯¼è‡´çº¿ç¨‹æ¶ˆäº¡, completedAbruptly=false,
        // å¹¶ä¸”workeræ•°åœ¨getTask()æ–¹æ³•ä¸­å°±å·²ç»-1äº†, è¿™é‡Œä¸å¿…å†å‡ä¸€äº†
        if (completedAbruptly)
            decrementWorkerCount();

        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            completedTaskCount += w.completedTasks;
            workers.remove(w); // ç§»é™¤çº¿ç¨‹
        } finally {
            mainLock.unlock();
        }

        tryTerminate();

        int c = ctl.get();
        // å¦‚æœæ˜¯stop tiding terminated, é‚£ä¹ˆåªéœ€è¦ç§»é™¤çº¿ç¨‹å°±å¥½äº†
        // å¦‚æœæ˜¯running, shutdown, é‚£ä¹ˆè¦æ‰§è¡Œä¸€äº›é¢å¤–çš„åˆ¤æ–­
        if (runStateLessThan(c, STOP)) {
            // å¦‚æœçº¿ç¨‹ä¸æ˜¯ç”±äºç”¨æˆ·çš„exceptionæ¶ˆäº¡çš„
            if (!completedAbruptly) {
                // åˆ¤æ–­å½“å‰çº¿ç¨‹æ± ä¸­éœ€è¦ä¿ç•™çš„æœ€å°‘çº¿ç¨‹æ•°, å¦‚æœè¿è¡Œcore thread timeout, é‚£ä¹ˆå°±æ˜¯0
                int min = allowCoreThreadTimeOut ? 0 : corePoolSize;
                // å¦‚æœæœ€å°çº¿ç¨‹ä¸º0, å¹¶ä¸”é˜Ÿåˆ—ä¸ä¸ºç©º, é‚£ä¹ˆmin=1, è‡³å°‘éœ€è¦ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å‰©ä½™çš„ä»»åŠ¡
                if (min == 0 && ! workQueue.isEmpty())
                    min = 1;
                // åˆ¤æ–­çº¿ç¨‹æ•°æ˜¯å¦å¤§äºmin, å¦‚æœå¤§äº, é‚£ä¹ˆreturn, è®©çº¿ç¨‹æŒ‚æ‰
                if (workerCountOf(c) >= min)
                    return; // replacement not needed
            }
            // å¦‚æœæ˜¯ç”¨æˆ·å¼‚å¸¸å¯¼è‡´çš„, æˆ–è€…å½“å‰workeræ•°é‡å·²ç»å°äºmin
            // é‚£ä¹ˆè¦é‡æ–°æ·»åŠ ä¸€ä¸ªworkeræ¥è¡¥å¿
            addWorker(null, false);
        }
    }
~~~





## å¼ºå¼•ç”¨ è½¯å¼•ç”¨ å¼±å¼•ç”¨ è™šå¼•ç”¨

- å¼ºå¼•ç”¨: å½“ä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼ºå¼•ç”¨çš„æ—¶å€™, å½“å†…å­˜ç©ºé—´ä¸è¶³ï¼ŒJavaè™šæ‹Ÿæœºå®æ„¿æŠ›å‡ºOutOfMemoryErroré”™è¯¯ï¼Œä½¿ç¨‹åºå¼‚å¸¸ç»ˆæ­¢ï¼Œä¹Ÿä¸å›æ”¶è¿™ç§å¯¹è±¡ã€‚
- è½¯å¼•ç”¨: å½“ä¸€ä¸ªå¯¹è±¡åªæœ‰è½¯å¼•ç”¨çš„æ—¶å€™, åªæœ‰jvmå†…å­˜ä¸è¶³çš„æ—¶å€™æ‰ä¼šå›æ”¶è¿™ä¸ªå¯¹è±¡
- å¼±å¼•ç”¨: å½“ä¸€ä¸ªå¯¹è±¡åªæœ‰å¼±å¼•ç”¨çš„æ—¶å€™, åªè¦æœ‰gcå°±ä¼šè¢«å›æ”¶
- è™šå¼•ç”¨: ä¸å½±å“å¯¹è±¡çš„å£°æ˜å‘¨æœŸ, ä¸»è¦ç”¨æ¥è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ´»åŠ¨

## ThreadLocal

### æ¦‚è¿°

- ä½¿ç”¨æ–¹æ³•

  ~~~scala
      val threadLocal: ThreadLocal[Int] = new ThreadLocal[Int]
      threadLocal.set(10) // è®¾ç½®
      val value: Int = threadLocal.get() // è·å–
      threadLocal.remove() // è®¾ç½®å®Œæˆåéœ€è¦remove, å¦åˆ™ä¼šå†…å­˜æ³„éœ²
      ThreadLocal.withInitial(() => Random.nextInt()) // åˆ›å»ºä¸€ä¸ªThreadLocalå¯¹è±¡, å¹¶è®¾ç½®åˆå§‹å€¼
  ~~~

- åŸç†: æ¯ä¸€ä¸ªThreadå¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªThreadLocalMapå¯¹è±¡, è°ƒç”¨ThreadLocalçš„setæ–¹æ³•éƒ½ä¼šå°†thisä½œä¸ºkeyè®¾ç½®åˆ°å½“å‰çº¿ç¨‹çš„ThreadLocalMapå¯¹è±¡é‡Œé¢, æ‰€ä»¥æ¯æ¬¡è·å–éƒ½æ˜¯å½“å‰çº¿ç¨‹ä¸­ThreadLocalMapä¸­çš„å€¼, æ‰€ä»¥èƒ½å¤Ÿè¿›è¡Œçº¿ç¨‹éš”ç¦»

- ThreadLocalé€ æˆå†…å­˜æ³„éœ²çš„é—®é¢˜

  ~~~~java
  public void test(){
      ThreadLocal tl = new ThreadLocal();
      tl.set("hello");
  }
  ~~~~

  ä¸Šé¢ä»£ç å°†ä¼šé€ æˆå†…å­˜æ³„éœ², å› ä¸ºtestæ–¹æ³•ç»“æŸä¹‹å, tlå¯¹è±¡çš„å¼•ç”¨è¢«é”€æ¯, æ‰€ä»¥æˆ‘ä»¬å°±æ— æ³•é€šè¿‡tlå¯¹è±¡æ¥è·å–åˆ°helloå­—ç¬¦ä¸²äº†, ä½†æ˜¯åœ¨jvmä¸­è¿˜æ˜¯æœ‰Thread->ThreadLocalMap-> Entry -> 'hello'çš„è·¯å¾„å…³è”åˆ°helloå¯¹è±¡, å¯¼è‡´helloæ— æ³•gc, å¯¼è‡´å†…å­˜æ³„éœ²

  ä½†æ˜¯å› ä¸ºkeyæ˜¯ä¿å­˜åœ¨WeakReferenceä¸­çš„, å½“å‘ç”Ÿgcçš„æ—¶å€™keyè¢«å›æ”¶, æ‰€ä»¥å°±å¯ä»¥é€šè¿‡e.get()==nullæ¥åˆ¤æ–­å½“å‰entryæ˜¯å¦è¿‡æœŸï¼Œä»è€Œåœ¨ThreadLocalMapå†…éƒ¨é€šè¿‡ä»£ç åˆ¤æ–­æ¥æ‰‹åŠ¨é‡Šæ”¾æ‰å†…å­˜ã€‚




### åœ¨çˆ¶å­çº¿ç¨‹ä¸­ä½¿ç”¨threadLocal







### ThreadLocalæºç 

> ThreadLocalçš„ä½œç”¨

ThreadLocalç±»æä¾›äº†çº¿ç¨‹å±€éƒ¨ (thread-local) å˜é‡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥é€šè¿‡å…¶ get æˆ– setæ–¹æ³•æ¥è®¿é—®è‡ªå·±çš„ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚ThreadLocalä¸­çš„å˜é‡æ˜¯çº¿ç¨‹éš”ç¦»çš„ã€‚

```java
public class ThreadId {
    // Atomic integer containing the next thread ID to be assigned
    private static final AtomicInteger nextId = new AtomicInteger(0);

    // Thread local variable containing each thread's ID
    private static final ThreadLocal<Integer> threadId =
            new ThreadLocal<Integer>() {
                @Override protected Integer initialValue() {
                    return nextId.getAndIncrement();
                }
            };

    // Returns the current thread's unique ID, assigning it if necessary
    public static int get() {
        return threadId.get();
    }

    public static void main(String[] args) {
        for (int i = 0; i < 5; i++) {
            new Thread(new Runnable() {
                public void run() {
                    System.out.print(threadId.get());
                }
            }).start();
        }
    }
    // è¾“å‡ºç»“æœ01234
```

> ThreadLocal

ThreadLocalä¸­é‡è¦çš„æ–¹æ³•æœ‰ï¼š

- remove()æ¸…é™¤ThreadLocalä¸­ä¿å­˜çš„å˜é‡
- get() è®¾ç½®ThreadLocalä¸­ä¿å­˜çš„å˜é‡
- set(T)è·å–ThreadLocalä¸­ä¿å­˜çš„å˜é‡
- initialValue()å­ç±»å¯ä»¥è¦†ç›–è¿™ä¸ªæ–¹æ³•æ¥å¯¹ThreadLocalè®¾ç½®ä¸€ä¸ªåˆå§‹å€¼ï¼Œ é»˜è®¤ä¸ºnullã€‚

~~~java
	public void set(T value) {
    	// è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMapå¯¹è±¡
    	Thread t = Thread.currentThread();
	    ThreadLocalMap map = getMap(t);
 	   // è®¾ç½®å€¼
  	  if (map != null)
  	      map.set(this, value);
  	  else
     	   createMap(t, value);
	}
    public T get() {
        // è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMapå¯¹è±¡
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null) {
            // è·å–ThreadLocalMapä¸­å¯¹åº”çš„entryï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œä¼ å…¥çš„æ˜¯thisï¼Œä¹Ÿå°±æ˜¯è¯´ThreadLocalMapä¸­çš„keyæ˜¯ThreadLocalã€‚
            ThreadLocalMap.Entry e = map.getEntry(this);
            if (e != null) {
                @SuppressWarnings("unchecked")
                T result = (T)e.value;
                return result;
            }
        }
        // æ²¡æœ‰å¯¹åº”çš„å€¼å°±è·å–åˆå§‹å€¼ï¼Œ åˆå§‹å€¼å¯ä»¥ç»§æ‰¿TheadLocalç±»å¹¶è¦†ç›–å…¶initialValue()æ–¹æ³•æ¥è®¾ç½®
        return setInitialValue();
    }
     public void remove() {
         // è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMapå¯¹è±¡
         ThreadLocalMap m = getMap(Thread.currentThread());
         // æ¸…é™¤ThreadLocalMapä¸­keyä¸ºå½“å‰å¯¹è±¡çš„entry
         if (m != null)
             m.remove(this);
     }
	// å‡å¦‚å½“å‰TheadLocalå¯¹è±¡æ²¡æœ‰é€šè¿‡set()æ–¹æ³•è®¾ç½®å€¼å°±è°ƒç”¨get()æ–¹æ³•çš„è¯ï¼Œé‚£ThreadLocalMapå¯¹è±¡ä¸­è‚¯å®šæ— æ³•è·å¾—å¯¹åº”çš„entryï¼Œé‚£ä¹ˆget()æ–¹æ³•ä¸­å°±ä¼šè°ƒç”¨è¯¥æ–¹æ³•ã€‚
	private T setInitialValue() {
        // è·å–åˆå§‹å€¼ï¼Œé»˜è®¤çš„è¯æ˜¯nullï¼Œå¯ä»¥é€šè¿‡å­ç±»è¦†ç›–è¿™ä¸ªæ–¹æ³•ã€‚
        T value = initialValue();
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        // æƒ³ThreadLocalMapä¸­è®¾ç½®è¿™ä¸ªåˆå§‹å€¼ã€‚
        if (map != null)
            map.set(this, value);
        else
            createMap(t, value);
        return value;
    }
~~~

ç»¼ä¸Šå¯ä»¥çœ‹å‡ºï¼Œå¯¹ThreadLocalå¯¹è±¡è°ƒç”¨set/getæ–¹æ³•ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨äº†Thread.currentThread()ä¸­çš„ThreadLocalMapå¯¹è±¡ã€‚

### ThreadLocalMapæºç 

ThreadLocalMapä¸HashMapä¸åŒ(ä¸ç»§æ‰¿mapæ¥å£), ä½¿ç”¨`ç¯å½¢æ•°ç»„`ä¿å­˜entry, åˆå§‹å¤§å°16, é˜ˆå€¼2/3, æ¯æ¬¡æ‰©å®¹ä¸¤å€, ä½¿ç”¨`çº¿æ€§æ¢æµ‹æ³•`æ¥è§£å†³hashå†²çª

æ¯ä¸ªEntryéƒ½ç»§æ‰¿è‡ªWeekReference

<img src="img/é¢è¯•é¢˜/image-20220922160037211.png" alt="image-20220922160037211" style="zoom: 33%;" />

å…³é”®çš„æ˜¯ï¼Œ**æ¯ä¸€ä¸ªThreadå¯¹è±¡ä¸­ç»´æŠ¤ç€ä¸€ä¸ªThreadLocalMapå¯¹è±¡ï¼Œå½“è°ƒç”¨çš„ThreadLocalè¿›è¡Œset/getæ—¶ï¼Œæ“ä½œçš„ThreadLocalMapæ˜¯å½“å‰çº¿ç¨‹Thread.currentThread()çš„ï¼Œæ‰€ä»¥ä¿å­˜åœ¨ThreadLocalä¸­çš„å¯¹è±¡æ˜¯çº¿ç¨‹éš”ç¦»çš„ã€‚**

![image-20201105194031217](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20201105194031217.png)

ThreadLocalMapæˆå‘˜å˜é‡å¦‚ä¸‹ï¼š

```java
    //åˆå§‹å®¹é‡ â€”â€” å¿…é¡»æ˜¯2çš„å¹‚
    private static final int INITIAL_CAPACITY = 16;
    //å­˜æ”¾æ•°æ®çš„tableï¼ŒEntryç±»çš„å®šä¹‰åœ¨ä¸‹é¢åˆ†æï¼ŒåŒæ ·ï¼Œæ•°ç»„é•¿åº¦å¿…é¡»æ˜¯2çš„å¹‚
    private Entry[] table;
    // æ•°ç»„é‡Œé¢entrysçš„ä¸ªæ•°ï¼Œå¯ä»¥ç”¨äºåˆ¤æ–­tableå½“å‰ä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡è´Ÿå› å­ã€‚
    private int size = 0;
    // è¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼ï¼Œè¡¨ä½¿ç”¨é‡å¤§äºå®ƒçš„æ—¶å€™è¿›è¡Œæ‰©å®¹ã€‚
    private int threshold;
    // é•¿åº¦çš„2/3
    private void setThreshold(int len) {
        threshold = len * 2 / 3;
    }
```

å­˜å‚¨ç»“æ„Entryï¼š

```java
/**
 * Entryç»§æ‰¿WeakReferenceï¼Œå¹¶ä¸”ç”¨ThreadLocalä½œä¸ºkey.å¦‚æœkeyä¸ºnull
 * (entry.get() == null)è¡¨ç¤ºkeyä¸å†è¢«å¼•ç”¨ï¼Œè¡¨ç¤ºThreadLocalå¯¹è±¡è¢«å›æ”¶
 * å› æ­¤è¿™æ—¶å€™è¿™ä¸ªentryä¹Ÿå¯ä»¥ä»tableä»æ¸…é™¤ã€‚
 */
static class Entry extends WeakReference<ThreadLocal<?>> {
    /** The value associated with this ThreadLocal. */
    Object value;

    Entry(ThreadLocal<?> k, Object v) {
        super(k);
        value = v;
    }
}
```

**ThreadLocalMapä¸­çš„keyæ˜¯ThreadLocalå¯¹è±¡ï¼Œè¿™æ ·å½“è°ƒç”¨ThreadLocalçš„set/getæ–¹æ³•æ—¶ï¼Œä¼ å…¥thisä¾¿å¯ä»¥è·å–å¯¹åº”ä¿å­˜çš„valueã€‚**

> ThreadLocalå’ŒThreadLocalMapä¸­çš„set

å…ˆçœ‹çœ‹ThreadLocalä¸­set()æºç ã€‚

```java
    public void set(T value) {
        Thread t = Thread.currentThread();
        ThreadLocal.ThreadLocalMap map = getMap(t);
        if (map != null)
            map.set(this, value);
        else
            createMap(t, value);
    }
    
    ThreadLocal.ThreadLocalMap getMap(Thread t) {
        return t.threadLocals;
    }

    void createMap(Thread t, T firstValue) {
        t.threadLocals = new ThreadLocal.ThreadLocalMap(this, firstValue);
    }
```

- ä»£ç å¾ˆç®€å•ï¼Œè·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMapå®ä¾‹ï¼ˆä»getMap(Thread t)ä¸­å¾ˆå®¹æ˜“çœ‹å‡ºæ¥ï¼‰ã€‚
- å¦‚æœè·å–åˆ°çš„mapå®ä¾‹ä¸ä¸ºç©ºï¼Œè°ƒç”¨map.set()æ–¹æ³•ï¼Œå¦åˆ™è°ƒç”¨æ„é€ å‡½æ•° ThreadLocal.ThreadLocalMap(this, firstValue)å®ä¾‹åŒ–mapã€‚

å¯ä»¥çœ‹å‡ºæ¥çº¿ç¨‹ä¸­çš„ThreadLocalMapä½¿ç”¨çš„æ˜¯å»¶è¿Ÿåˆå§‹åŒ–ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨get()æˆ–è€…set()æ–¹æ³•çš„æ—¶å€™æ‰ä¼šè¿›è¡Œåˆå§‹åŒ–ã€‚ä¸‹é¢æ¥çœ‹çœ‹æ„é€ å‡½æ•°`ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue)` ã€‚

```java
    ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {
        //åˆå§‹åŒ–table
        table = new ThreadLocal.ThreadLocalMap.Entry[INITIAL_CAPACITY];
        //è®¡ç®—ç´¢å¼•
        int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);
        //è®¾ç½®å€¼
        table[i] = new ThreadLocal.ThreadLocalMap.Entry(firstKey, firstValue);
        size = 1;
        //è®¾ç½®é˜ˆå€¼
        setThreshold(INITIAL_CAPACITY);
    }
```

ä¸»è¦è¯´ä¸€ä¸‹è®¡ç®—ç´¢å¼•ï¼Œ`firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1)`ã€‚

- å…³äº`& (INITIAL_CAPACITY - 1)`, è¿™æ˜¯å¿«é€Ÿå–æ¨¡æ³•ï¼Œç›¸å½“äº `%INITIAL_CAPACITY` ï¼Œå‰ææ˜¯`INITIAL_CAPACITY` å¿…é¡»æ˜¯2çš„å¹‚ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºå•¥å®¹é‡å¿…é¡»ä¸º2çš„å¹‚ã€‚
- å…³äº`firstKey.threadLocalHashCode`ï¼š

```java
    private final int threadLocalHashCode = nextHashCode();
    private static int nextHashCode() {
        return nextHashCode.getAndAdd(HASH_INCREMENT);
    }
    private static AtomicInteger nextHashCode =
            new AtomicInteger();     
    private static final int HASH_INCREMENT = 0x61c88647;
```

å®šä¹‰äº†ä¸€ä¸ªAtomicIntegerç±»å‹ï¼Œæ¯æ¬¡è·å–å½“å‰å€¼å¹¶åŠ ä¸ŠHASH_INCREMENTï¼Œ`HASH_INCREMENT = 0x61c88647`,å…³äºè¿™ä¸ªå€¼å’Œ`æ–æ³¢é‚£å¥‘æ•£åˆ—`æœ‰å…³ï¼Œå…¶åŸç†è¿™é‡Œä¸å†æ·±ç©¶ï¼Œæ„Ÿå…´è¶£å¯è‡ªè¡Œæœç´¢ï¼Œå…¶**ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†è®©å“ˆå¸Œç èƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨2çš„næ¬¡æ–¹çš„æ•°ç»„é‡Œ, ä¹Ÿå°±æ˜¯`Entry[] table`ä¸­ã€‚**

åœ¨äº†è§£äº†ä¸Šé¢çš„æºç åï¼Œç»ˆäºèƒ½è¿›å…¥æ­£é¢˜äº†ï¼Œä¸‹é¢å¼€å§‹è¿›å…¥ThreadLocalMapä¸­çš„set()ã€‚

ThreadLocalMapä½¿ç”¨`çº¿æ€§æ¢æµ‹æ³•`æ¥è§£å†³å“ˆå¸Œå†²çªï¼Œçº¿æ€§æ¢æµ‹æ³•çš„åœ°å€å¢é‡di = 1, 2, ... , m-1ï¼Œå…¶ä¸­ï¼Œiä¸ºæ¢æµ‹æ¬¡æ•°ã€‚è¯¥æ–¹æ³•ä¸€æ¬¡æ¢æµ‹ä¸‹ä¸€ä¸ªåœ°å€ï¼Œç›´åˆ°æœ‰ç©ºçš„åœ°å€åæ’å…¥ï¼Œè‹¥æ•´ä¸ªç©ºé—´éƒ½æ‰¾ä¸åˆ°ç©ºä½™çš„åœ°å€ï¼Œåˆ™äº§ç”Ÿæº¢å‡ºã€‚å‡è®¾å½“å‰tableé•¿åº¦ä¸º16ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœè®¡ç®—å‡ºæ¥keyçš„hashå€¼ä¸º14ï¼Œå¦‚æœtable[14]ä¸Šå·²ç»æœ‰å€¼ï¼Œå¹¶ä¸”å…¶keyä¸å½“å‰keyä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±å‘ç”Ÿäº†hashå†²çªï¼Œè¿™ä¸ªæ—¶å€™å°†14åŠ 1å¾—åˆ°15ï¼Œå–table[15]è¿›è¡Œåˆ¤æ–­ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¿˜æ˜¯å†²çªä¼šå›åˆ°0ï¼Œå–table[0],ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°å¯ä»¥æ’å…¥ã€‚

æŒ‰ç…§ä¸Šé¢çš„æè¿°ï¼Œ`å¯ä»¥æŠŠtableçœ‹æˆä¸€ä¸ªç¯å½¢æ•°ç»„`ã€‚

å…ˆçœ‹ä¸€ä¸‹çº¿æ€§æ¢æµ‹ç›¸å…³çš„ä»£ç ï¼Œä»ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥tableå®é™…æ˜¯ä¸€ä¸ªç¯ï¼š

```java
    // è·å–ç¯å½¢æ•°ç»„çš„ä¸‹ä¸€ä¸ªç´¢å¼•
    private static int nextIndex(int i, int len) {
        return ((i + 1 < len) ? i + 1 : 0);
    }
    // è·å–ç¯å½¢æ•°ç»„çš„ä¸Šä¸€ä¸ªç´¢å¼•
    private static int prevIndex(int i, int len) {
        return ((i - 1 >= 0) ? i - 1 : len - 1);
    }
```

ThreadLocalMapçš„set()åŠå…¶set()ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š

```java
    private void set(ThreadLocal<?> key, Object value) {
        ThreadLocal.ThreadLocalMap.Entry[] tab = table;
        int len = tab.length;
        //è®¡ç®—ç´¢å¼•ï¼Œä¸Šé¢å·²ç»æœ‰è¯´è¿‡ã€‚
        int i = key.threadLocalHashCode & (len-1);

        /**
         * æ ¹æ®è·å–åˆ°çš„ç´¢å¼•è¿›è¡Œå¾ªç¯ï¼Œå¦‚æœå½“å‰ç´¢å¼•ä¸Šçš„table[i]ä¸ä¸ºç©ºï¼Œåœ¨æ²¡æœ‰returnçš„æƒ…å†µä¸‹ï¼Œ
         * å°±ä½¿ç”¨nextIndex()è·å–ä¸‹ä¸€ä¸ªï¼ˆä¸Šé¢æåˆ°åˆ°çº¿æ€§æ¢æµ‹æ³•ï¼‰ã€‚
         */
        for (ThreadLocal.ThreadLocalMap.Entry e = tab[i];
             e != null;
             e = tab[i = nextIndex(i, len)]) {
            ThreadLocal<?> k = e.get();
            //table[i]ä¸Škeyä¸ä¸ºç©ºï¼Œå¹¶ä¸”å’Œå½“å‰keyç›¸åŒï¼Œæ›´æ–°value
            if (k == key) {
                e.value = value;
                return;
            }
            /**
             * table[i]ä¸Šçš„keyä¸ºç©ºï¼Œè¯´æ˜è¢«å›æ”¶äº†ï¼ˆä¸Šé¢çš„å¼±å¼•ç”¨ä¸­æåˆ°è¿‡ï¼‰ã€‚
             * è¿™ä¸ªæ—¶å€™è¯´æ˜æ”¹table[i]å¯ä»¥é‡æ–°ä½¿ç”¨ï¼Œç”¨æ–°çš„key-valueå°†å…¶æ›¿æ¢,å¹¶åˆ é™¤å…¶ä»–æ— æ•ˆçš„entry
             */
            if (k == null) {
                replaceStaleEntry(key, value, i);
                return;
            }
        }

        //æ‰¾åˆ°ä¸ºç©ºçš„æ’å…¥ä½ç½®ï¼Œæ’å…¥å€¼ï¼Œåœ¨ä¸ºç©ºçš„ä½ç½®æ’å…¥éœ€è¦å¯¹sizeè¿›è¡ŒåŠ 1æ“ä½œ
        tab[i] = new ThreadLocal.ThreadLocalMap.Entry(key, value);
        int sz = ++size;

        /**
         * cleanSomeSlotsç”¨äºæ¸…é™¤é‚£äº›e.get()==nullï¼Œä¹Ÿå°±æ˜¯table[index] != null && table[index].get()==null
         * ä¹‹å‰æåˆ°è¿‡ï¼Œè¿™ç§æ•°æ®keyå…³è”çš„å¯¹è±¡å·²ç»è¢«å›æ”¶ï¼Œæ‰€ä»¥è¿™ä¸ªEntry(table[index])å¯ä»¥è¢«ç½®nullã€‚
         * å¦‚æœæ²¡æœ‰æ¸…é™¤ä»»ä½•entry,å¹¶ä¸”å½“å‰ä½¿ç”¨é‡è¾¾åˆ°äº†è´Ÿè½½å› å­æ‰€å®šä¹‰(é•¿åº¦çš„2/3)ï¼Œé‚£ä¹ˆè¿›è¡Œrehash()
         */
        if (!cleanSomeSlots(i, sz) && sz >= threshold)
            rehash();
    }


    /**
     * æ›¿æ¢æ— æ•ˆentry
     */
    private void replaceStaleEntry(ThreadLocal<?> key, Object value,
                                   int staleSlot) {
        ThreadLocal.ThreadLocalMap.Entry[] tab = table;
        int len = tab.length;
        ThreadLocal.ThreadLocalMap.Entry e;

        /**
         * æ ¹æ®ä¼ å…¥çš„æ— æ•ˆentryçš„ä½ç½®ï¼ˆstaleSlotï¼‰,å‘å‰æ‰«æ
         * ä¸€æ®µè¿ç»­çš„entry(è¿™é‡Œçš„è¿ç»­æ˜¯æŒ‡ä¸€æ®µç›¸é‚»çš„entryå¹¶ä¸”table[i] != null),
         * ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ— æ•ˆentryï¼Œæˆ–è€…æ‰«æå®Œä¹Ÿæ²¡æ‰¾åˆ°
         */
        int slotToExpunge = staleSlot;//ä¹‹åç”¨äºæ¸…ç†çš„èµ·ç‚¹
        for (int i = prevIndex(staleSlot, len);
             (e = tab[i]) != null;
             i = prevIndex(i, len))
            if (e.get() == null)
                slotToExpunge = i;

        /**
         * å‘åæ‰«æä¸€æ®µè¿ç»­çš„entry
         */
        for (int i = nextIndex(staleSlot, len);
             (e = tab[i]) != null;
             i = nextIndex(i, len)) {
            ThreadLocal<?> k = e.get();

            /**
             * å¦‚æœæ‰¾åˆ°äº†keyï¼Œå°†å…¶ä¸ä¼ å…¥çš„æ— æ•ˆentryæ›¿æ¢ï¼Œä¹Ÿå°±æ˜¯ä¸table[staleSlot]è¿›è¡Œæ›¿æ¢
             */
            if (k == key) {
                e.value = value;

                tab[i] = tab[staleSlot];
                tab[staleSlot] = e;

                //å¦‚æœå‘å‰æŸ¥æ‰¾æ²¡æœ‰æ‰¾åˆ°æ— æ•ˆentryï¼Œåˆ™æ›´æ–°slotToExpungeä¸ºå½“å‰å€¼i
                if (slotToExpunge == staleSlot)
                    slotToExpunge = i;
                cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);
                return;
            }

            /**
             * å¦‚æœå‘å‰æŸ¥æ‰¾æ²¡æœ‰æ‰¾åˆ°æ— æ•ˆentryï¼Œå¹¶ä¸”å½“å‰å‘åæ‰«æçš„entryæ— æ•ˆï¼Œåˆ™æ›´æ–°slotToExpungeä¸ºå½“å‰å€¼i
             */
            if (k == null && slotToExpunge == staleSlot)
                slotToExpunge = i;
        }

        /**
         * å¦‚æœæ²¡æœ‰æ‰¾åˆ°key,ä¹Ÿå°±æ˜¯è¯´keyä¹‹å‰ä¸å­˜åœ¨tableä¸­
         * å°±ç›´æ¥æœ€å¼€å§‹çš„æ— æ•ˆentryâ€”â€”tab[staleSlot]ä¸Šç›´æ¥æ–°å¢å³å¯
         */
        tab[staleSlot].value = null;
        tab[staleSlot] = new ThreadLocal.ThreadLocalMap.Entry(key, value);

        /**
         * slotToExpunge != staleSlot,è¯´æ˜å­˜åœ¨å…¶ä»–çš„æ— æ•ˆentryéœ€è¦è¿›è¡Œæ¸…ç†ã€‚
         */
        if (slotToExpunge != staleSlot)
            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);
    }

    /**
     * è¿ç»­æ®µæ¸…é™¤
     * æ ¹æ®ä¼ å…¥çš„staleSlot,æ¸…ç†å¯¹åº”çš„æ— æ•ˆentryâ€”â€”table[staleSlot],
     * å¹¶ä¸”æ ¹æ®å½“å‰ä¼ å…¥çš„staleSlot,å‘åæ‰«æä¸€æ®µè¿ç»­çš„entry(è¿™é‡Œçš„è¿ç»­æ˜¯æŒ‡ä¸€æ®µç›¸é‚»çš„entryå¹¶ä¸”table[i] != null),
     * å¯¹å¯èƒ½å­˜åœ¨hashå†²çªçš„entryè¿›è¡Œrehashï¼Œå¹¶ä¸”æ¸…ç†é‡åˆ°çš„æ— æ•ˆentry.
     *
     * @param staleSlot keyä¸ºnull,éœ€è¦æ— æ•ˆentryæ‰€åœ¨çš„tableä¸­çš„ç´¢å¼•
     * @return è¿”å›ä¸‹ä¸€ä¸ªä¸ºç©ºçš„soltçš„ç´¢å¼•ã€‚
     */
    private int expungeStaleEntry(int staleSlot) {
        ThreadLocal.ThreadLocalMap.Entry[] tab = table;
        int len = tab.length;

        // æ¸…ç†æ— æ•ˆentryï¼Œç½®ç©º
        tab[staleSlot].value = null;
        tab[staleSlot] = null;
        //sizeå‡1ï¼Œç½®ç©ºåtableçš„è¢«ä½¿ç”¨é‡å‡1
        size--;

        ThreadLocal.ThreadLocalMap.Entry e;
        int i;
        /**
         * ä»staleSlotå¼€å§‹å‘åæ‰«æä¸€æ®µè¿ç»­çš„entry
         */
        for (i = nextIndex(staleSlot, len);
             (e = tab[i]) != null;
             i = nextIndex(i, len)) {
            ThreadLocal<?> k = e.get();
            //å¦‚æœé‡åˆ°keyä¸ºnull,è¡¨ç¤ºæ— æ•ˆentryï¼Œè¿›è¡Œæ¸…ç†.
            if (k == null) {
                e.value = null;
                tab[i] = null;
                size--;
            } else {
                //å¦‚æœkeyä¸ä¸ºnull,è®¡ç®—ç´¢å¼•
                int h = k.threadLocalHashCode & (len - 1);
                /**
                 * è®¡ç®—å‡ºæ¥çš„ç´¢å¼•â€”â€”hï¼Œä¸å…¶ç°åœ¨æ‰€åœ¨ä½ç½®çš„ç´¢å¼•â€”â€”iä¸ä¸€è‡´ï¼Œç½®ç©ºå½“å‰çš„table[i]
                 * ä»hå¼€å§‹å‘åçº¿æ€§æ¢æµ‹åˆ°ç¬¬ä¸€ä¸ªç©ºçš„slotï¼ŒæŠŠå½“å‰çš„entryæŒªè¿‡å»ã€‚
                 */
                if (h != i) {
                    tab[i] = null;
                    while (tab[h] != null)
                        h = nextIndex(h, len);
                    tab[h] = e;
                }
            }
        }
        //ä¸‹ä¸€ä¸ªä¸ºç©ºçš„soltçš„ç´¢å¼•ã€‚
        return i;
    }

    /**
     * å¯å‘å¼çš„æ‰«ææ¸…é™¤ï¼Œæ‰«ææ¬¡æ•°ç”±ä¼ å…¥çš„å‚æ•°nå†³å®š
     * @param i ä»iå‘åå¼€å§‹æ‰«æï¼ˆä¸åŒ…æ‹¬iï¼Œå› ä¸ºç´¢å¼•ä¸ºiçš„Slotè‚¯å®šä¸ºnullï¼‰
     * @param n æ§åˆ¶æ‰«ææ¬¡æ•°ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¸º log2(n) ï¼Œ
     * å¦‚æœæ‰¾åˆ°äº†æ— æ•ˆentryï¼Œä¼šå°†né‡ç½®ä¸ºtableçš„é•¿åº¦len,è¿›è¡Œæ®µæ¸…é™¤ã€‚
     * map.set()ç‚¹ç”¨çš„æ—¶å€™ä¼ å…¥çš„æ˜¯å…ƒç´ ä¸ªæ•°ï¼ŒreplaceStaleEntry()è°ƒç”¨çš„æ—¶å€™ä¼ å…¥çš„æ˜¯tableçš„é•¿åº¦len
     *
     * @return true if any stale entries have been removed.
     */
    private boolean cleanSomeSlots(int i, int n) {
        boolean removed = false;
        ThreadLocal.ThreadLocalMap.Entry[] tab = table;
        int len = tab.length;
        do {
            i = nextIndex(i, len);
            ThreadLocal.ThreadLocalMap.Entry e = tab[i];
            if (e != null && e.get() == null) {
                //é‡ç½®nä¸ºlen
                n = len;
                removed = true;
                //ä¾ç„¶è°ƒç”¨expungeStaleEntryæ¥è¿›è¡Œæ— æ•ˆentryçš„æ¸…é™¤
                i = expungeStaleEntry(i);
            }
        } while ( (n >>>= 1) != 0);//æ— ç¬¦å·çš„å³ç§»åŠ¨ï¼Œå¯ä»¥ç”¨äºæ§åˆ¶æ‰«ææ¬¡æ•°åœ¨log2(n)
        return removed;
    }
    private void rehash() {
        //å…¨æ¸…ç†
        expungeStaleEntries();

        /**
         * threshold = 2/3 * len
         * æ‰€ä»¥threshold - threshold / 4 = 1en/2
         * è¿™é‡Œä¸»è¦æ˜¯å› ä¸ºä¸Šé¢åšäº†ä¸€æ¬¡å…¨æ¸…ç†æ‰€ä»¥sizeå‡å°ï¼Œéœ€è¦è¿›è¡Œåˆ¤æ–­ã€‚
         * åˆ¤æ–­çš„æ—¶å€™æŠŠé˜ˆå€¼è°ƒä½äº†ã€‚
         */
        if (size >= threshold - threshold / 4)
            resize();
    }
    /**
     * æ‰©å®¹ï¼Œæ‰©å¤§ä¸ºåŸæ¥çš„2å€ï¼ˆè¿™æ ·ä¿è¯äº†é•¿åº¦ä¸º2çš„å†¥ï¼‰
     */
    private void resize() {
        ThreadLocal.ThreadLocalMap.Entry[] oldTab = table;
        int oldLen = oldTab.length;
        int newLen = oldLen * 2;
        ThreadLocal.ThreadLocalMap.Entry[] newTab = new ThreadLocal.ThreadLocalMap.Entry[newLen];
        int count = 0;

        for (int j = 0; j < oldLen; ++j) {
            ThreadLocal.ThreadLocalMap.Entry e = oldTab[j];
            if (e != null) {
                ThreadLocal<?> k = e.get();
                //è™½ç„¶åšè¿‡ä¸€æ¬¡æ¸…ç†ï¼Œä½†åœ¨æ‰©å®¹çš„æ—¶å€™å¯èƒ½ä¼šåˆå­˜åœ¨key==nullçš„æƒ…å†µã€‚
                if (k == null) {
                    //è¿™é‡Œè¯•è¯•å°†e.valueè®¾ç½®ä¸ºnull
                    e.value = null; // Help the GC
                } else {
                    //åŒæ ·é€‚ç”¨çº¿æ€§æ¢æµ‹æ¥è®¾ç½®å€¼ã€‚
                    int h = k.threadLocalHashCode & (newLen - 1);
                    while (newTab[h] != null)
                        h = nextIndex(h, newLen);
                    newTab[h] = e;
                    count++;
                }
            }
        }
        //è®¾ç½®æ–°çš„é˜ˆå€¼
        setThreshold(newLen);
        size = count;
        table = newTab;
    }

    /**
     * å…¨æ¸…ç†ï¼Œæ¸…ç†æ‰€æœ‰æ— æ•ˆentry
     */
    private void expungeStaleEntries() {
        ThreadLocal.ThreadLocalMap.Entry[] tab = table;
        int len = tab.length;
        for (int j = 0; j < len; j++) {
            ThreadLocal.ThreadLocalMap.Entry e = tab[j];
            if (e != null && e.get() == null)
                //ä½¿ç”¨è¿ç»­æ®µæ¸…ç†
                expungeStaleEntry(j);
        }
    }
```

> ThreadLocalå’ŒThreadLocalMapä¸­çš„get

ThreadLocalMapä¸­çš„getEntry()åŠå…¶ç›¸å…³

åŒæ ·çš„å¯¹äºThreadLocalMapä¸­çš„getEntry()ä¹Ÿä»ThreadLocalçš„get()æ–¹æ³•å…¥æ‰‹ã€‚

ThreadLocalä¸­çš„get()

```java
public T get() {
    //åŒsetæ–¹æ³•ç±»ä¼¼è·å–å¯¹åº”çº¿ç¨‹ä¸­çš„ThreadLocalMapå®ä¾‹
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null) {
        ThreadLocalMap.Entry e = map.getEntry(this);
        if (e != null) {
            @SuppressWarnings("unchecked")
            T result = (T)e.value;
            return result;
        }
    }
    //ä¸ºç©ºè¿”å›åˆå§‹åŒ–å€¼
    return setInitialValue();
}
/**
 * åˆå§‹åŒ–è®¾å€¼çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«å­ç±»è¦†ç›–ã€‚
 */
protected T initialValue() {
   return null;
}

private T setInitialValue() {
    //è·å–åˆå§‹åŒ–å€¼ï¼Œé»˜è®¤ä¸ºnull(å¦‚æœæ²¡æœ‰å­ç±»è¿›è¡Œè¦†ç›–)
    T value = initialValue();
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    //ä¸ä¸ºç©ºä¸ç”¨å†åˆå§‹åŒ–ï¼Œç›´æ¥è°ƒç”¨setæ“ä½œè®¾å€¼
    if (map != null)
        map.set(this, value);
    else
        //ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ï¼ŒcreateMapåœ¨ä¸Šé¢ä»‹ç»set()çš„æ—¶å€™æœ‰ä»‹ç»è¿‡ã€‚
        createMap(t, value);
    return value;
}
```

ThreadLocalMapä¸­çš„getEntry()

```java
    private ThreadLocal.ThreadLocalMap.Entry getEntry(ThreadLocal<?> key) {
        //æ ¹æ®keyè®¡ç®—ç´¢å¼•ï¼Œè·å–entry
        int i = key.threadLocalHashCode & (table.length - 1);
        ThreadLocal.ThreadLocalMap.Entry e = table[i];
        if (e != null && e.get() == key)
            return e;
        else
            return getEntryAfterMiss(key, i, e);
    }

    /**
     * é€šè¿‡ç›´æ¥è®¡ç®—å‡ºæ¥çš„keyæ‰¾ä¸åˆ°å¯¹äºçš„valueçš„æ—¶å€™é€‚ç”¨è¿™ä¸ªæ–¹æ³•.
     */
    private ThreadLocal.ThreadLocalMap.Entry getEntryAfterMiss(ThreadLocal<?> key, int i, ThreadLocal.ThreadLocalMap.Entry e) {
        ThreadLocal.ThreadLocalMap.Entry[] tab = table;
        int len = tab.length;

        while (e != null) {
            ThreadLocal<?> k = e.get();
            if (k == key)
                return e;
            if (k == null)
                //æ¸…é™¤æ— æ•ˆçš„entry
                expungeStaleEntry(i);
            else
                //åŸºäºçº¿æ€§æ¢æµ‹æ³•å‘åæ‰«æ
                i = nextIndex(i, len);
            e = tab[i];
        }
        return null;
    }
```

ThreadLocalMapä¸­çš„remove()

```java
    private void remove(ThreadLocal<?> key) {
        ThreadLocal.ThreadLocalMap.Entry[] tab = table;
        int len = tab.length;
        //è®¡ç®—ç´¢å¼•
        int i = key.threadLocalHashCode & (len-1);
        //è¿›è¡Œçº¿æ€§æ¢æµ‹ï¼ŒæŸ¥æ‰¾æ­£ç¡®çš„key
        for (ThreadLocal.ThreadLocalMap.Entry e = tab[i];
             e != null;
             e = tab[i = nextIndex(i, len)]) {
            if (e.get() == key) {
                //è°ƒç”¨weakrefrenceçš„clear()æ¸…é™¤å¼•ç”¨
                e.clear();
                //è¿ç»­æ®µæ¸…é™¤
                expungeStaleEntry(i);
                return;
            }
        }
    }
```

remove()åœ¨æœ‰ä¸Šé¢äº†è§£åå¯ä»¥è¯´æä¸ºç®€å•äº†ï¼Œå°±æ˜¯æ‰¾åˆ°å¯¹åº”çš„table[],è°ƒç”¨weakrefrenceçš„clear()æ¸…é™¤å¼•ç”¨ï¼Œç„¶åå†è°ƒç”¨expungeStaleEntry()è¿›è¡Œæ¸…é™¤ã€‚

> Entryä½¿ç”¨å¼±å¼•ç”¨çš„åŸå› ä¸å†…å­˜æ³„æ¼

~~~java
public void test(){
    ThreadLocal tl = new ThreadLocal();
    tl.set("hello");
}
~~~

ä¸Šé¢è°ƒç”¨teståï¼Œä¼šå¾€å½“å‰çº¿ç¨‹çš„threadLocalMapä¸­æ·»åŠ ä¸€ä¸ªâ€œhelloâ€ã€‚ä½†æ˜¯**å½“testæ–¹æ³•ç»“æŸåï¼Œtlå¯¹è±¡çš„å¼•ç”¨è¢«é”€æ¯ï¼Œé‚£ä¹ˆä¹Ÿå°±æ— æ³•é€šè¿‡tlæ¥è·å–threadLocalMapä¸­çš„â€œhelloâ€è¿™ä¸ªå­—ç¬¦ä¸²äº†ã€‚tlå¯¹åº”çš„entryä¼šä¸€è‡´ä¿å­˜åœ¨entry[]æ•°ç»„ä¸­ï¼Œè¿™å°±é€ æˆäº†å†…å­˜æ³„æ¼ã€‚**

ä½†æ˜¯å› ä¸ºEntryæ˜¯ç»§æ‰¿WeakReferenceçš„ï¼Œè¿™å°±å¯¼è‡´å½“tlå¯¹è±¡çš„å¼•ç”¨è¢«é”€æ¯çš„æ—¶å€™ï¼Œå› ä¸ºthreadLocalMapä¸­çš„Entry[]æ•°ç»„åªæ˜¯æŒæœ‰tlçš„å¼±å¼•ç”¨ï¼Œå½“å †å†…å­˜ä¸å¤Ÿæ—¶ï¼Œä¼šgcå›æ”¶tlå¯¹è±¡ï¼Œè¿™æ ·å¯¹åº”çš„entryè°ƒç”¨çš„getæ–¹æ³•è¿”å›çš„æ˜¯nullï¼Œä»è€Œå¯ä»¥åˆ¤æ–­è¯¥tlå¯¹è±¡å·²ç»è¢«å›æ”¶äº†ã€‚ï¼ˆgcåªæ˜¯å¯¹entryçš„keyè¿›è¡Œå›æ”¶ï¼Œå³tlå¯¹è±¡ï¼Œè€Œä¸æ˜¯å¯¹entryå¯¹è±¡å›æ”¶ï¼Œå› ä¸ºentryç±»æ˜¯å°†keyä¿å­˜åœ¨å¼±å¼•ç”¨ä¸­ï¼‰ä½¿ç”¨å¼±å¼•ç”¨çš„è¯å¯ä»¥å°†entryä¸­è¿‡æœŸçš„keyé€šè¿‡gcè¿›è¡Œå›æ”¶ï¼Œä½†æ˜¯entryå’Œentryä¸­çš„valueæ˜¯ä¸ä¼šå›æ”¶çš„ã€‚**ä¹Ÿå°±æ˜¯è¯´å³ä½¿ä½¿ç”¨äº†å¼±å¼•ç”¨ä¹Ÿä¸èƒ½é˜²æ­¢å†…å­˜æ³„æ¼ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡entryçš„keyæ˜¯ä¸æ˜¯nullæ¥åˆ¤æ–­è¿™ä¸ªentryæ˜¯ä¸æ˜¯è¿‡æœŸçš„ï¼Œä»è€Œæ‰‹åŠ¨é‡Šæ”¾æ‰ä»–ã€‚**

äº‹å®ä¸Šï¼Œåœ¨ThreadLocalMapçš„set/getä¸­ä¹Ÿä¼šé€šè¿‡e.get()==nullæ¥åˆ¤æ–­å½“å‰entryæ˜¯å¦è¿‡æœŸï¼Œä»è€Œæ‰‹åŠ¨é‡Šæ”¾æ‰è¿™ä¸ªentryã€‚

![img](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16045025138073.png)![img](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16045025774716.png)

![image-20201105205929710](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20201105205929710.png)

![img](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16045033491830.png)

> ä½¿ç”¨ä¸­æ³¨æ„çš„ç‚¹

- ä½¿ç”¨å®ŒThreadLocalè°ƒç”¨removeæ–¹æ³•æ¸…é™¤ThreadLocalMapä¸­çš„å€¼ã€‚

- ThreadLocalå¯¹è±¡æ¨èä½¿ç”¨staticï¼Œå› ä¸ºstaticå¯¹è±¡è™½ç„¶æ˜¯ç±»æ‰€æœ‰çš„ï¼Œä½†æ˜¯å› ä¸ºæ˜¯é€šè¿‡ThreadLocalè·å–çš„ä¸åŒThreadä¸­çš„ThreadLocalMapçš„valueï¼Œæ‰€ä»¥ThreadLocalæ˜¯çº¿ç¨‹éš”ç¦»çš„ã€‚



## TransmittableThreadLocal

### äº§ç”Ÿçš„é—®é¢˜

åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸­, å¦‚æœå¸Œæœ›çˆ¶çº¿ç¨‹ä¸­çš„ThreadLocalèƒ½å¤Ÿä¼ é€’ç»™å­çº¿ç¨‹, é‚£ä¹ˆå¯ä»¥ä½¿ç”¨InheritableThreadLocal

æ¯ä¸ªThreadå¯¹è±¡éƒ½æœ‰ä¸€ä¸ª`inheritableThreadLocalMap`å±æ€§, åœ¨new Threadçš„æ—¶å€™, å­çº¿ç¨‹ä¼šæŠŠçˆ¶çº¿ç¨‹ä¸­çš„`inheritableThreadLocalMap`æ‹·è´åˆ°è‡ªå·±çš„`inheritableThreadLocalMap`ä¸Šé¢,  æ‰€ä»¥åœ¨å­çº¿ç¨‹ä¸­å¯ä»¥è·å–åˆ°å’Œçˆ¶çº¿ç¨‹ä¸­ä¸€æ ·çš„å†…å®¹

ä½†æ˜¯å¦‚æœæ˜¯åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„æƒ…å†µä¸‹, è¿™ç§æ–¹å¼å°±ä¸èƒ½ä½¿ç”¨äº†, ç”±æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨alibabaæä¾›çš„`TransmittableThreadLocal`ç±»

~~~xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>transmittable-thread-local</artifactId>
    <version>2.14.4</version>
</dependency>
~~~



```java
@Test
public void test() {
    ThreadLocal<String> threadLocal = new ThreadLocal<>();
    threadLocal.set("hello");

    InheritableThreadLocal<Object> inheritableThreadLocal = new InheritableThreadLocal<>();
    inheritableThreadLocal.set("world");

    Thread thread = new Thread(() -> {
        System.out.println(threadLocal.get()); // null
        System.out.println(inheritableThreadLocal.get()); // world
    });
    thread.start();
}
```

### TransmittableThreadLocalçš„ä½¿ç”¨

1. TransmittableThreadLocalç»§æ‰¿è‡ª`inheritableThreadLocalMap`, æ‰€ä»¥å¯ä»¥åƒ`inheritableThreadLocalMap`é‚£ä¹ˆä½¿ç”¨

   ~~~java
   @Test
       public void transmittableThreadLocalTest() {
   
           TransmittableThreadLocal<String> threadLocal = new TransmittableThreadLocal<>();
           // åœ¨ä¸»çº¿ç¨‹ä¸­è®¾ç½®TransmittableThreadLocalçš„å€¼
           threadLocal.set("Hello, World!");
           // åœ¨æ–°çº¿ç¨‹ä¸­è·å–TransmittableThreadLocalçš„å€¼
           Thread thread = new Thread(() -> {
               String value = threadLocal.get();
               System.out.println("TransmittableThreadLocal value in new thread: " + value);
           });
           thread.start();
       }
   ~~~

2. å¦‚æœè¦åœ¨çº¿ç¨‹æ± ä¸­ä½¿ç”¨`TransmittableThreadLocal`, éœ€è¦å°†runnableæˆ–è€…callableçš„taskåŒ…è£…èµ·æ¥

   ~~~java
   @Test
       public void test2() throws InterruptedException {
           ExecutorService executorService = Executors.newFixedThreadPool(2);
           TransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();
           // åœ¨ä¸»çº¿ç¨‹ä¸­è®¾ç½®TransmittableThreadLocalçš„å€¼
           context.set("Hello, World!");
           // åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œä»»åŠ¡
           // TtlRunnable.get()ä¼šå¯¹å½“å‰taskè¿›è¡ŒåŒ…è£…, ä¿å­˜å½“å‰çº¿ç¨‹çš„TransmittableThreadLocal
           // ç„¶ååœ¨çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡çš„å¼€å§‹, æŠŠTransmittableThreadLocalè®¾ç½®åˆ°æ‰§è¡Œçº¿ç¨‹ä¸­
           executorService.execute(TtlRunnable.get(() -> {
               String value = context.get();
               System.out.println(value);
           }));
           // ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ
           executorService.shutdown();
           executorService.awaitTermination(1, TimeUnit.SECONDS);
       }
   ~~~

   å³ä½¿æ˜¯åŒä¸€ä¸ª`Runnable`ä»»åŠ¡å¤šæ¬¡æäº¤åˆ°çº¿ç¨‹æ± æ—¶ï¼Œæ¯æ¬¡æäº¤æ—¶éƒ½éœ€è¦é€šè¿‡ä¿®é¥°æ“ä½œï¼ˆå³`TtlRunnable.get(task)`ï¼‰ä»¥æŠ“å–è¿™æ¬¡æäº¤æ—¶çš„`TransmittableThreadLocal`ä¸Šä¸‹æ–‡çš„å€¼ï¼›å³å¦‚æœåŒä¸€ä¸ªä»»åŠ¡ä¸‹ä¸€æ¬¡æäº¤æ—¶ä¸æ‰§è¡Œä¿®é¥°è€Œä»ç„¶ä½¿ç”¨ä¸Šä¸€æ¬¡çš„`TtlRunnable`ï¼Œåˆ™æäº¤çš„ä»»åŠ¡è¿è¡Œæ—¶ä¼šæ˜¯ä¹‹å‰ä¿®é¥°æ“ä½œæ‰€æŠ“å–çš„ä¸Šä¸‹æ–‡ã€‚

3. å¦‚æœä¸æƒ³æ¯æ¬¡éƒ½å¯¹taskè¿›è¡ŒåŒ…è£…, é‚£ä¹ˆä¹Ÿå¯ä»¥é€‰æ‹©å¯¹çº¿ç¨‹æ± è¿›è¡ŒåŒ…è£…, ä¹‹åå°±å¯ä»¥ç›´æ¥æäº¤ä»»åŠ¡äº†

   **åŸç†å°±æ˜¯åŒ…è£…åçš„ExecutorServiceçš„submitæ–¹æ³•ä¸­, ä¼šå¸®æˆ‘ä»¬è°ƒç”¨TtlRunnable.get()æ¥å¯¹taskè¿›è¡ŒåŒ…è£…**

   ~~~java
   	@Test
       public void test3() {
           ExecutorService executorService = Executors.newFixedThreadPool(2);
           // å¯¹çº¿ç¨‹æ± è¿›è¡ŒåŒ…è£…
           executorService = TtlExecutors.getTtlExecutorService(executorService);
           TransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();
           // åœ¨çˆ¶çº¿ç¨‹ä¸­è®¾ç½®
           context.set("value-set-in-parent");
   
           executorService.submit(() -> {
               System.out.println(context.get()); // value-set-in-parent
           });
       }
   ~~~

   é€šè¿‡å·¥å…·ç±»[`TtlExecutors`](https://github.com/alibaba/transmittable-thread-local/blob/master/ttl-core/src/main/java/com/alibaba/ttl3/executor/TtlExecutors.java)å®Œæˆï¼Œæœ‰ä¸‹é¢çš„æ–¹æ³•ï¼š

   - `getTtlExecutor`ï¼šä¿®é¥°æ¥å£`Executor`
   - `getTtlExecutorService`ï¼šä¿®é¥°æ¥å£`ExecutorService`
   - `getTtlScheduledExecutorService`ï¼šä¿®é¥°æ¥å£`ScheduledExecutorService`

4. å¦‚æœä¸æƒ³å¯¹çº¿ç¨‹æ± è¿›è¡ŒåŒ…è£…, è¿˜å¯ä»¥ä½¿ç”¨java agentæ¥ä¿®é¥°jdkçº¿ç¨‹æ± çš„å®ç°ç±»

   ~~~shell
   java -jar -javaagent:path/to/transmittable-thread-local-2.x.y.jar ...
   ~~~

   ä¹‹åå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨çº¿ç¨‹æ± äº†

   ~~~java
   TransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();
   context.set("value-set-in-parent");
   
   // ## 2. åº”ç”¨é€»è¾‘ï¼Œåç»­æµç¨‹ä¸šåŠ¡è°ƒç”¨æ¡†æ¶ä¸‹å±‚é€»è¾‘ ##
   ExecutorService executorService = Executors.newFixedThreadPool(3);
   
   Runnable task = new RunnableTask();
   Callable call = new CallableTask();
   executorService.submit(task);
   executorService.submit(call);
   
   // ## 3. æ¡†æ¶ä¸‹å±‚é€»è¾‘ ##
   // Taskæˆ–æ˜¯Callä¸­å¯ä»¥è¯»å–ï¼Œå€¼æ˜¯"value-set-in-parent"
   String value = context.get();
   ~~~

   è¯¥java agentä¼šä¿®æ”¹`java.util.concurrent.ThreadPoolExecutor`, `java.util.concurrent.ScheduledThreadPoolExecutor`, `java.util.concurrent.ForkJoinTask`, `java.util.TimerTask`

   `TTL Agent`ä¸å…¶å®ƒ`Agent`ï¼ˆå¦‚`Skywalking`ã€`Promethues`ï¼‰é…åˆä½¿ç”¨æ—¶ä¸ç”Ÿæ•ˆ,  éœ€è¦å°†java agentæ”¾åœ¨æœ€å‰é¢

   ~~~java
   java -javaagent:path/to/transmittable-thread-local-2.x.y.jar \
        -javaagent:path/to/skywalking-agent.jar \
        -jar your-app.jar
   ~~~

   



## å…³äºWeekReferenceçš„è¯´æ˜

https://www.jianshu.com/p/964fbc30151a

WeakReferenceå¦‚å­—é¢æ„æ€ï¼Œå¼±å¼•ç”¨ï¼Œ **å½“ä¸€ä¸ªå¯¹è±¡ä»…ä»…è¢«weak referenceï¼ˆå¼±å¼•ç”¨ï¼‰æŒ‡å‘, è€Œæ²¡æœ‰ä»»ä½•å…¶ä»–strong referenceï¼ˆå¼ºå¼•ç”¨ï¼‰æŒ‡å‘çš„æ—¶å€™, å¦‚æœè¿™æ—¶GCè¿è¡Œ, é‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±ä¼šè¢«å›æ”¶ï¼Œä¸è®ºå½“å‰çš„å†…å­˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œè¿™ä¸ªå¯¹è±¡éƒ½ä¼šè¢«å›æ”¶ã€‚**

> è®¤è¯†WeakReferenceç±»

WeakReferenceç»§æ‰¿Referenceï¼Œå…¶ä¸­åªæœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š

```java
public class WeakReference<T> extends Reference<T> {
    public WeakReference(T referent) { super(referent); }
    public WeakReference(T referent, ReferenceQueue<? super T> q) { 
        super(referent, q); 
    }
}
```

WeakReference(T referent)ï¼šreferentå°±æ˜¯è¢«å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œå¯ä»¥å¦‚ä¸‹ä½¿ç”¨ï¼Œå¹¶ä¸”é€šè¿‡get()æ–¹æ³•æ¥è·å–è¢«å¼•ç”¨å¯¹è±¡ã€‚

```java
WeakReference<Apple> appleWeakReference = new WeakReference<>(apple);
Apple apple2 = appleWeakReference.get();
```

WeakReference(T referent, ReferenceQueue<? super T> q)ï¼šä¸ä¸Šé¢çš„æ„é€ æ–¹æ³•æ¯”è¾ƒï¼Œå¤šäº†ä¸ªReferenceQueueï¼Œ**åœ¨å¯¹è±¡è¢«å›æ”¶åï¼Œä¼šæŠŠå¼±å¼•ç”¨å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯WeakReferenceå¯¹è±¡æˆ–è€…å…¶å­ç±»çš„å¯¹è±¡ï¼Œæ”¾å…¥é˜Ÿåˆ—ReferenceQueueä¸­ï¼Œæ³¨æ„ä¸æ˜¯è¢«å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œè¢«å¼±å¼•ç”¨çš„å¯¹è±¡å·²ç»è¢«å›æ”¶äº†ã€‚**

> ä½¿ç”¨WeakReference

ä¸‹é¢æ˜¯ä½¿ç”¨ç»§æ‰¿WeakReferenceçš„æ–¹å¼æ¥ä½¿ç”¨è½¯å¼•ç”¨ï¼Œå¹¶ä¸”ä¸ä½¿ç”¨ReferenceQueueã€‚

```java
public class Apple {
    private String name;
    public Apple(String name) {
        this.name = name;
    }
    /**
     * è¦†ç›–finalizeï¼Œåœ¨å›æ”¶çš„æ—¶å€™ä¼šæ‰§è¡Œã€‚
     * @throws Throwable
     */
    @Override
    protected void finalize() throws Throwable {
        super.finalize();
        System.out.println("Appleï¼š " + name + " finalizeã€‚");
    }
}
```

ç»§æ‰¿WeakReferenceçš„Salad

```java
public class Salad extends WeakReference<Apple> {
    public Salad(Apple apple) {super(apple);}
}
```

Clentè°ƒç”¨å’Œè¾“å‡º

```java
public class Client {
    public static void main(String[] args) {
        Salad salad = new Salad(new Apple("çº¢å¯Œå£«"));
        //é€šè¿‡WeakReferenceçš„get()æ–¹æ³•è·å–Apple
        System.out.println("Apple:" + salad.get());
        System.gc();
        try {
            //ä¼‘çœ ä¸€ä¸‹ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™åŠ ä¸Šè™šæ‹Ÿæœºå‚æ•°-XX:+PrintGCDetailsï¼Œè¾“å‡ºgcä¿¡æ¯ï¼Œç¡®å®šgcå‘ç”Ÿäº†ã€‚
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        //å¦‚æœä¸ºç©ºï¼Œä»£è¡¨è¢«å›æ”¶äº†
        if (salad.get() == null) {
            System.out.println("clear Apple");
        }
    }
}
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```rust
Apple:Apple{name='çº¢å¯Œå£«'}, hashCode:1846274136
[GC (System.gc()) [PSYoungGen: 3328K->496K(38400K)] 3328K->504K(125952K), 0.0035102 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[Full GC (System.gc()) [PSYoungGen: 496K->0K(38400K)] [ParOldGen: 8K->359K(87552K)] 504K->359K(125952K), [Metaspace: 2877K->2877K(1056768K)], 0.0067965 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
Appleï¼š çº¢å¯Œå£« finalizeã€‚
clear Appleã€‚
```

>  ReferenceQueueçš„ä½¿ç”¨

```java
public class Client2 {
    public static void main(String[] args) {
        ReferenceQueue<Apple> appleReferenceQueue = new ReferenceQueue<>();
        WeakReference<Apple> appleWeakReference = new WeakReference<Apple>(new Apple("é’è‹¹æœ"), appleReferenceQueue);
        WeakReference<Apple> appleWeakReference2 = new WeakReference<Apple>(new Apple("æ¯’è‹¹æœ"), appleReferenceQueue);

        System.out.println("=====gcè°ƒç”¨å‰=====");
        Reference<? extends Apple> reference = null;
        while ((reference = appleReferenceQueue.poll()) != null ) {
            //ä¸ä¼šè¾“å‡ºï¼Œå› ä¸ºæ²¡æœ‰å›æ”¶è¢«å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œå¹¶ä¸ä¼šåŠ å…¥é˜Ÿåˆ—ä¸­
            System.out.println(reference);
        }
        System.out.println(appleWeakReference.get());
        System.out.println(appleWeakReference2.get());

        System.out.println("=====è°ƒç”¨gc=====");
        System.gc();
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        System.out.println("=====gcè°ƒç”¨å=====");

        //ä¸‹é¢ä¸¤ä¸ªè¾“å‡ºä¸ºnull,è¡¨ç¤ºå¯¹è±¡è¢«å›æ”¶äº†
        System.out.println(appleWeakReference.get());
        System.out.println(appleWeakReference2.get());

        //è¾“å‡ºç»“æœï¼Œå¹¶ä¸”å°±æ˜¯ä¸Šé¢çš„appleWeakReferenceã€appleWeakReference2ï¼Œå†æ¬¡è¯æ˜å¯¹è±¡è¢«å›æ”¶äº†
        Reference<? extends Apple> reference2 = null;
        while ((reference2 = appleReferenceQueue.poll()) != null ) {
            //å¦‚æœä½¿ç”¨ç»§æ‰¿çš„æ–¹å¼å°±å¯ä»¥åŒ…å«å…¶ä»–ä¿¡æ¯äº†
            System.out.println("appleReferenceQueueä¸­ï¼š" + reference2);
        }
    }
}
```

ç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š

```csharp
=====gcè°ƒç”¨å‰=====
Apple{name='é’è‹¹æœ'}, hashCode:1627674070
Apple{name='æ¯’è‹¹æœ'}, hashCode:1360875712
=====è°ƒç”¨gc=====
Appleï¼š æ¯’è‹¹æœ finalize
Appleï¼š é’è‹¹æœ finalize
=====gcè°ƒç”¨å=====
null
null
appleReferenceQueueä¸­ï¼šjava.lang.ref.WeakReference@6e0be858
appleReferenceQueueä¸­ï¼šjava.lang.ref.WeakReference@61bbe9ba
```

å¯ä»¥çœ‹åˆ°åœ¨é˜Ÿåˆ—ä¸­ï¼ˆReferenceQueueï¼‰ï¼Œè°ƒç”¨gcä¹‹å‰æ˜¯æ²¡æœ‰å†…å®¹çš„ï¼Œè°ƒç”¨gcä¹‹åï¼Œå¯¹è±¡è¢«å›æ”¶äº†ï¼Œå¹¶ä¸”å¼±å¼•ç”¨å¯¹è±¡appleWeakReferenceå’ŒappleWeakReference2è¢«æ”¾å…¥äº†é˜Ÿåˆ—ä¸­ã€‚

## synchrioizedåŒæ­¥é”åŸç†å’Œé”çš„å‡çº§

https://juejin.cn/post/6844903726545633287

https://www.bilibili.com/video/BV168411e7wr/?spm_id_from=333.999.0.0&vd_source=f79519d2285c777c4e2b2513f5ef101a

é”çš„çŠ¶æ€ä¿å­˜åœ¨å¯¹è±¡å¤´çš„mark workä¸­, æœ‰å››ç§, å¦‚ä¸‹å›¾

(æ— é”å’Œåå‘é”çš„ç¬¬57ä½è¡¨ç¤ºæ˜¯å¦å¼€å¯åå‘é”, ä¸‹å›¾æœ‰ç‚¹é—®é¢˜)

æ— é”: 001, å½“å‰é”æ²¡æœ‰çº¿ç¨‹æŒæœ‰, å¦‚æœçº¿ç¨‹æ¥æŒæœ‰è¿™ä¸ªé”çš„æ—¶å€™, ä¼šç›´æ¥è½¬å˜ä¸ºè½»é‡çº§é”

åå‘é”: 101, è¡¨ç¤ºå½“å‰å¯¹è±¡å·²ç»å¼€å¯äº†åå‘é”, æ­¤æ—¶å¦‚æœæ˜¯åˆå§‹çŠ¶æ€, çº¿ç¨‹idä¸º0

è½»é‡çº§é”: 00, åˆç§°è‡ªæ—‹é”

é‡é‡çº§é”: 10, å µå¡

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230901234920526.png" alt="image-20230901234920526" style="zoom:50%;" />

åœ¨jvmå¯åŠ¨çš„å‰4ç§’, æ­¤æ—¶åˆ›å»ºçš„å¯¹è±¡çš„mark worké»˜è®¤éƒ½æ˜¯001, ä¸å¯ç”¨åå‘é”, å› æ­¤è¿™ä¸ªæ—¶å€™jvmå†…éƒ¨é”çš„ç«äº‰å¾ˆæ¿€çƒˆ, å¼€å¯åå‘é”æ²¡ä»€ä¹ˆæ„ä¹‰. å¦‚æœçº¿ç¨‹å¯¹è¿™äº›å¯¹è±¡åŠ é”, ä¼šç›´æ¥å‡çº§ä¸ºè½»é‡çº§é”

åœ¨4ç§’å, åˆ›å»ºçš„å¯¹è±¡çš„mark workä¸º101, å¼€å¯åå‘é”, ä½†æ˜¯æ­¤æ—¶çº¿ç¨‹id=0, æ²¡æœ‰åå‘çš„çº¿ç¨‹, æ­¤æ—¶åˆç§°ä¸ºåŒ¿ååå‘

> åå‘é”çš„è·å–å’Œå‡çº§

1. å½“è¯¥å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å¾—é”çš„æ—¶å€™ï¼Œå‘ç°æ˜¯åŒ¿ååå‘çŠ¶æ€ï¼Œåˆ™ä¼šç”¨CASæŒ‡ä»¤ï¼Œå°†`mark word`ä¸­çš„thread idç”±0æ”¹æˆå½“å‰çº¿ç¨‹Idã€‚å¦‚æœæˆåŠŸï¼Œåˆ™ä»£è¡¨è·å¾—äº†åå‘é”ï¼Œç»§ç»­æ‰§è¡ŒåŒæ­¥å—ä¸­çš„ä»£ç 

2. å½“è¢«åå‘çš„çº¿ç¨‹å†æ¬¡è¿›å…¥åŒæ­¥å—æ—¶ï¼Œå‘ç°é”å¯¹è±¡åå‘çš„å°±æ˜¯å½“å‰çº¿ç¨‹ï¼Œé‚£ä¹ˆç›´æ¥æ‰§è¡ŒåŒæ­¥å—

3. å½“å…¶ä»–çº¿ç¨‹è¿›å…¥åŒæ­¥å—æ—¶ï¼Œå‘ç°å·²ç»æœ‰åå‘çš„çº¿ç¨‹äº†ï¼Œåˆ™ä¼šè¿›å…¥åˆ°**æ’¤é”€åå‘é”**çš„é€»è¾‘é‡Œï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¼šåœ¨`safepoint`ä¸­å»æŸ¥çœ‹åå‘çš„çº¿ç¨‹æ˜¯å¦è¿˜å­˜æ´»ï¼Œå¦‚æœå­˜æ´»ä¸”è¿˜åœ¨åŒæ­¥å—ä¸­åˆ™å°†é”å‡çº§ä¸ºè½»é‡çº§é”ï¼ŒåŸåå‘çš„çº¿ç¨‹ç»§ç»­æ‹¥æœ‰é”ï¼Œå½“å‰çº¿ç¨‹åˆ™èµ°å…¥åˆ°é”å‡çº§çš„é€»è¾‘é‡Œï¼›

   å¦‚æœåå‘çš„çº¿ç¨‹å·²ç»ä¸å­˜æ´»æˆ–è€…ä¸åœ¨åŒæ­¥å—ä¸­ï¼Œåˆ™å°†å¯¹è±¡å¤´çš„`mark word`æ”¹ä¸ºæ— é”çŠ¶æ€ï¼ˆunlockedï¼‰ï¼Œä¹‹åå†å‡çº§ä¸ºè½»é‡çº§é”ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯, åå‘é”å¹¶ä¸ä¼šä¸»åŠ¨æ’¤é”€, å³ä½¿æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—ä¹‹åä¹Ÿä¸ä¼šå°†thread idæ”¹ä¸º0, éœ€è¦å½“å…¶ä»–çº¿ç¨‹è¿‡æ¥ç«äº‰çš„æ—¶å€™, å‘ç°thread idä¸æ˜¯è‡ªå·±, é‚£ä¹ˆä¼šåœ¨å®‰å…¨ç‚¹çš„æ—¶å€™è¿›è¡Œåå‘é”çš„æ’¤é”€

> è½»é‡çº§é”

åˆç§°è‡ªæ—‹é”

çº¿ç¨‹åœ¨æ‰§è¡ŒåŒæ­¥å—ä¹‹å‰ï¼ŒJVMä¼šå…ˆåœ¨å½“å‰çš„çº¿ç¨‹çš„æ ˆå¸§ä¸­åˆ›å»ºä¸€ä¸ª`Lock Record`ï¼Œç„¶åå°†å¯¹è±¡å¤´çš„mark wordå¤åˆ¶ä¸€ä»½åˆ°å…¶ä¸­ï¼ˆå®˜æ–¹ç§°ä¹‹ä¸º`Displaced Mark Word`ï¼‰ä»¥åŠä¸€ä¸ªæŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆã€‚ä¸‹å›¾å³è¾¹çš„éƒ¨åˆ†å°±æ˜¯ä¸€ä¸ª`Lock Record`ã€‚

![image-20230902000911829](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20230902000911829.png)



#### åŠ é”è¿‡ç¨‹

1.åœ¨çº¿ç¨‹æ ˆä¸­åˆ›å»ºä¸€ä¸ª`Lock Record`ï¼Œå°†å…¶`obj`ï¼ˆå³ä¸Šå›¾çš„Object referenceï¼‰å­—æ®µæŒ‡å‘é”å¯¹è±¡ã€‚

2.ç›´æ¥é€šè¿‡CASæŒ‡ä»¤å°†`Lock Record`çš„åœ°å€å­˜å‚¨åœ¨å¯¹è±¡å¤´çš„`mark word`ä¸­ï¼Œå¦‚æœå¯¹è±¡å¤„äºæ— é”çŠ¶æ€åˆ™ä¿®æ”¹æˆåŠŸï¼Œä»£è¡¨è¯¥çº¿ç¨‹è·å¾—äº†è½»é‡çº§é”ã€‚å¦‚æœå¤±è´¥ï¼Œè¿›å…¥åˆ°æ­¥éª¤4ã€‚

3.å¦‚æœæ˜¯å½“å‰çº¿ç¨‹å·²ç»æŒæœ‰è¯¥é”äº†ï¼Œä»£è¡¨è¿™æ˜¯ä¸€æ¬¡é”é‡å…¥ã€‚è®¾ç½®`Lock Record`ç¬¬ä¸€éƒ¨åˆ†ï¼ˆ`Displaced Mark Word`ï¼‰ä¸ºnullï¼Œèµ·åˆ°äº†ä¸€ä¸ªé‡å…¥è®¡æ•°å™¨çš„ä½œç”¨ã€‚ç„¶åç»“æŸã€‚

4.å¦‚æœçº¿ç¨‹ç«äº‰è½»é‡çº§é”å¤±è´¥, é‚£ä¹ˆå°±ä¼šå¼€å§‹è‡ªæ—‹, å¦‚æœè‡ªæ—‹è¶…è¿‡ä¸€å®šæ¬¡æ•°è¿˜æ²¡æœ‰è·å–åˆ°é”, é‚£ä¹ˆå°±éœ€è¦å‡çº§ä¸ºé‡é‡çº§é”

#### è§£é”è¿‡ç¨‹

1.éå†çº¿ç¨‹æ ˆ,æ‰¾åˆ°æ‰€æœ‰`obj`å­—æ®µç­‰äºå½“å‰é”å¯¹è±¡çš„`Lock Record`ã€‚

2.å¦‚æœ`Lock Record`çš„`Displaced Mark Word`ä¸ºnullï¼Œä»£è¡¨è¿™æ˜¯ä¸€æ¬¡é‡å…¥ï¼Œå°†`obj`è®¾ç½®ä¸ºnullåcontinueã€‚

3.å¦‚æœ`Lock Record`çš„`Displaced Mark Word`ä¸ä¸ºnullï¼Œåˆ™åˆ©ç”¨CASæŒ‡ä»¤å°†å¯¹è±¡å¤´çš„`mark word`æ¢å¤æˆä¸º`Displaced Mark Word`ã€‚å¦‚æœæˆåŠŸï¼Œåˆ™continueï¼Œå¦åˆ™è†¨èƒ€ä¸ºé‡é‡çº§é”

> é‡é‡çº§é”

é‡é‡çº§é”æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é”ï¼Œå…¶åˆ©ç”¨æ“ä½œç³»ç»Ÿåº•å±‚çš„åŒæ­¥æœºåˆ¶å»å®ç°Javaä¸­çš„çº¿ç¨‹åŒæ­¥ã€‚

é‡é‡çº§é”çš„çŠ¶æ€ä¸‹ï¼Œå¯¹è±¡çš„`mark word`ä¸ºæŒ‡å‘ä¸€ä¸ªå †ä¸­monitorå¯¹è±¡çš„æŒ‡é’ˆã€‚

ä¸€ä¸ªmonitorå¯¹è±¡åŒ…æ‹¬è¿™ä¹ˆå‡ ä¸ªå…³é”®å­—æ®µï¼šcxqï¼ˆä¸‹å›¾ä¸­çš„ContentionListï¼‰ï¼ŒEntryList ï¼ŒWaitSetï¼Œownerã€‚

å…¶ä¸­cxq ï¼ŒEntryList ï¼ŒWaitSetéƒ½æ˜¯ç”±ObjectWaiterçš„é“¾è¡¨ç»“æ„ï¼ŒowneræŒ‡å‘æŒæœ‰é”çš„çº¿ç¨‹ã€‚



![image-20230902001734475](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20230902001734475.png)



å½“ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å¾—é”æ—¶ï¼Œå¦‚æœè¯¥é”å·²ç»è¢«å ç”¨ï¼Œåˆ™ä¼šå°†è¯¥çº¿ç¨‹å°è£…æˆä¸€ä¸ªObjectWaiterå¯¹è±¡æ’å…¥åˆ°cxqçš„é˜Ÿåˆ—å°¾éƒ¨ï¼Œç„¶åæš‚åœå½“å‰çº¿ç¨‹ã€‚å½“æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”å‰ï¼Œä¼šå°†cxqä¸­çš„æ‰€æœ‰å…ƒç´ ç§»åŠ¨åˆ°EntryListä¸­å»ï¼Œå¹¶å”¤é†’EntryListçš„é˜Ÿé¦–çº¿ç¨‹ã€‚

å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨åŒæ­¥å—ä¸­è°ƒç”¨äº†`Object#wait`æ–¹æ³•ï¼Œä¼šå°†è¯¥çº¿ç¨‹å¯¹åº”çš„ObjectWaiterä»EntryListç§»é™¤å¹¶åŠ å…¥åˆ°WaitSetä¸­ï¼Œç„¶åé‡Šæ”¾é”ã€‚å½“waitçš„çº¿ç¨‹è¢«notifyä¹‹åï¼Œä¼šå°†å¯¹åº”çš„ObjectWaiterä»WaitSetç§»åŠ¨åˆ°EntryListä¸­ã€‚



#### synchronized

1. synchronizedå…³é”®å­—**ä¸èƒ½**è¢«ç»§æ‰¿ å³çˆ¶ç±»æ–¹æ³•æ˜¯åŒæ­¥æ–¹æ³• å­ç±»æ–¹æ³•ç»§æ‰¿åé»˜è®¤ä¸æ˜¯åŒæ­¥æ–¹æ³•
2. synchronized**ä¸èƒ½**ä¿®é¥°æ¥å£æ–¹æ³• å› ä¸ºæ¥å£æ˜¯ç‰¹æ®Šçš„æŠ½è±¡ç±» ä¸èƒ½æ–°å»ºå®ä¾‹ å®ä¾‹é”åº”å½’å®ç°å…¶çš„ç±»æ‰€æœ‰
3. synchronized**ä¸èƒ½**ä¿®é¥°æ„é€ æ–¹æ³•ï¼ˆä½†å¯åœ¨å†…éƒ¨ä½¿ç”¨synchronizedä»£ç å—æ¥åŒæ­¥
4. å¯¹æˆå‘˜æ–¹æ³•ä¿®é¥° -> synchronized(this)
5. å¯¹é™æ€æ–¹æ³•ä¿®é¥° -> synchronized(ClassA.class)
6. å°è¯•è·å–è¯¥å¯¹è±¡é”çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œå¹¶ä¸å½±å“å…¶ä»–çº¿ç¨‹ä¸è·å–é”çš„æ“ä½œï¼Œæ‰€ä»¥è¦åœ¨æ¶‰åŠåŒæ­¥é‡æ“ä½œçš„æ‰€æœ‰åœ°æ–¹é‡‡ç”¨åŒæ­¥æ–¹æ³•ï¼ˆå¦‚åŠ é”ï¼‰ï¼Œå¦åˆ™å¼•èµ·çº¿ç¨‹å®‰å…¨é—®é¢˜å‡ ä¹æ˜¯å¿…ç„¶çš„ã€‚
7. å¯é‡è¿›å…¥, åœ¨çˆ¶å­ç±»ç»§æ‰¿çš„æƒ…å†µä¸‹ä¹Ÿæ”¯æŒ.

## synchronizedåŸç†

#### å¤šçº¿ç¨‹çŠ¶æ€

#### å¸¸ç”¨æ–¹æ³•

> sleep

å¼ºåˆ¶å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¼‘çœ ï¼ˆï¼‰ï¼Œä½†æ˜¯ä¸ä¼šé‡Šæ”¾é”ï¼Œä¸éœ€è¦åœ¨åŒæ­¥å—ä¸­è°ƒç”¨ï¼Œå½“å‰çº¿ç¨‹sleepæ—¶å¦‚æœ

> yield

é‡Šæ”¾çº¿ç¨‹æ‰€å æœ‰çš„CPUèµ„æºï¼Œä»è€Œè®©å…¶ä»–çº¿ç¨‹æœ‰æœºä¼šè¿è¡Œï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯æŸä¸ªç‰¹å®šçš„çº¿ç¨‹èƒ½å¤Ÿè·å¾—CPUèµ„æºã€‚è°èƒ½è·å¾—CPUå®Œå…¨å–å†³äºè°ƒåº¦å™¨ï¼Œåœ¨æœ‰äº›æƒ…å†µä¸‹è°ƒç”¨yieldæ–¹æ³•çš„çº¿ç¨‹ç”šè‡³ä¼šå†æ¬¡å¾—åˆ°CPUèµ„æºã€‚æ‰€ä»¥ï¼Œä¾èµ–äºyieldæ–¹æ³•æ˜¯ä¸å¯é çš„ï¼Œå®ƒåªèƒ½å°½åŠ›è€Œä¸ºã€‚yield()å¹¶ä¸é‡Šæ”¾é”ã€‚

> sleepä¸yieldçš„åŒºåˆ«

- sleepè®©å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æš‚åœä¸€æ®µæ—¶é—´ï¼Œå¹¶**è¿›å…¥é˜»å¡çŠ¶æ€**ï¼Œåˆ™å¯ä»¥é€šè¿‡è°ƒç”¨Threadç±»çš„é™æ€sleep()æ–¹æ³•æ¥å®ç°ã€‚å½“å‰çº¿ç¨‹è°ƒç”¨sleep()æ–¹æ³•è¿›å…¥é˜»å¡çŠ¶æ€åï¼Œåœ¨å…¶ç¡çœ æ—¶é—´å†…ï¼Œè¯¥çº¿ç¨‹ä¸ä¼šè·å¾—æ‰§è¡Œçš„æœºä¼šï¼Œè€Œ**å…¶å®ƒä»»ä½•ä¼˜å…ˆçº§çš„çº¿ç¨‹éƒ½å¯ä»¥å¾—åˆ°æ‰§è¡Œçš„æœºä¼š**ï¼Œå³ä½¿ç³»ç»Ÿä¸­æ²¡æœ‰å…¶å®ƒå¯æ‰§è¡Œçš„çº¿ç¨‹ï¼Œå¤„äºsleep()çš„çº¿ç¨‹ä¹Ÿä¸ä¼šæ‰§è¡Œï¼Œsleep()æ˜¯ç”¨æ¥æš‚åœçº¿ç¨‹çš„æ‰§è¡Œã€‚

  yield()æ–¹æ³•æ˜¯ä¸€ä¸ªå’Œsleep()æ–¹æ³•æœ‰ç‚¹ç›¸ä¼¼çš„æ–¹æ³•ï¼Œå®ƒä¹Ÿæ˜¯Threadç±»æä¾›çš„ä¸€ä¸ªé™æ€æ–¹æ³•ã€‚å¯ä»¥è®©å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æš‚åœï¼Œä½†å®ƒä¸ä¼šé˜»å¡è¯¥çº¿ç¨‹ï¼Œåªæ˜¯**å°†è¯¥çº¿ç¨‹è½¬å…¥å°±ç»ªçŠ¶æ€**ã€‚yeild()åªæ˜¯è®©å½“å‰çº¿ç¨‹æš‚åœä¸€ä¸‹ï¼Œ**è®©ç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦å™¨é‡æ–°è°ƒåº¦ä¸€æ¬¡**ï¼Œå®Œå…¨å¯èƒ½çš„æƒ…å†µæ˜¯ï¼šå½“æŸä¸ªçº¿ç¨‹è°ƒç”¨äº†yield()çº¿ç¨‹æš‚åœä¹‹åï¼Œçº¿ç¨‹è°ƒåº¦å™¨åˆå°†å…¶è°ƒåº¦å‡ºæ¥é‡æ–°æ‰§è¡Œã€‚
  å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨äº†yield()æ–¹æ³•æš‚åœä¹‹åï¼Œ**åªæœ‰ä¼˜å…ˆçº§ä¸å½“å‰çº¿ç¨‹ç›¸åŒï¼Œæˆ–è€…ä¼˜å…ˆçº§æ¯”å½“å‰çº¿ç¨‹æ›´é«˜çš„å¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹æ‰ä¼šè·å¾—æ‰§è¡Œæœºä¼š**ã€‚

- sleep()æ–¹æ³•çš„å£°æ˜æŠ›å‡ºäº†InterruptedExceptionå¼‚å¸¸ï¼Œæ‰€ä»¥è°ƒç”¨sleep()æ–¹æ³•æ—¶è¦ä¹ˆæ•æ‰å¼‚å¸¸ï¼Œè¦ä¹ˆæŠ›å‡ºè¯¥å¼‚å¸¸ã€‚

- sleep()æ–¹æ³•æ¯”yield()æ–¹æ³•å…·æœ‰æ›´å¥½çš„å¯ç§»åŠ¨æ€§ï¼Œæ‰€ä»¥å»ºè®®ä¸è¦ä½¿ç”¨yield()æ–¹æ³•æ¥æ§åˆ¶å¹¶å‘çº¿ç¨‹çš„æ‰§è¡Œ



> æš‚åœçº¿ç¨‹suspend(åºŸå¼ƒ)å’Œresume(åºŸå¼ƒ)

> åœæ­¢çº¿ç¨‹stop

> ä¸­æ–­çº¿ç¨‹interrupt

è°ƒç”¨interruptæ–¹æ³•ä»…ä»…æ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰“äº†ä¸€ä¸ªåœæ­¢çš„æ ‡è®°ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„åœæ­¢çº¿ç¨‹ã€‚çº¿ç¨‹ä¸­æ–­å¹¶ä¸ä¼šç«‹å³ç»ˆæ­¢çº¿ç¨‹ï¼Œè€Œæ˜¯é€šçŸ¥ç›®æ ‡çº¿ç¨‹ï¼Œæœ‰äººå¸Œæœ›ä½ ç»ˆæ­¢ã€‚è‡³äºç›®æ ‡çº¿ç¨‹æ”¶åˆ°é€šçŸ¥åä¼šå¦‚ä½•å¤„ç†ï¼Œåˆ™å®Œå…¨ç”±ç›®æ ‡çº¿ç¨‹è‡ªè¡Œå†³å®šã€‚

~~~java
public boolean Thread.isInterrupted() //åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­
public static boolean Thread.interrupted() //åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¹¶æ¸…é™¤å½“å‰ä¸­æ–­çŠ¶æ€
~~~

è¿™ä¸¤ä¸ªæ–¹æ³•ä½¿å¾—å½“å‰çº¿ç¨‹èƒ½å¤Ÿæ„ŸçŸ¥åˆ°æ˜¯å¦è¢«ä¸­æ–­äº†ï¼ˆé€šè¿‡æ£€æŸ¥æ ‡å¿—ä½ï¼‰ã€‚å¦åˆ™å½“å‰çº¿ç¨‹æ˜¯ä¸ä¼šç®¡è¿™ä¸ªæ ‡å¿—ä½çš„ï¼Œä¹Ÿå°±ä¸ä¼šè¢«ä¸­æ–­äº†ã€‚

~~~java
@Override
public void run() {
    super.run();
    for(int i = 0; i <= 200000; i++) {
        //åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­
        if(Thread.currentThread().isInterrupted()){
            //å¤„ç†ä¸­æ–­é€»è¾‘
            break;
        }
        System.out.println("i=" + i);
    }
}
~~~

Thread.sleep() æ–¹æ³•ä¼šæŠ›å‡ºä¸€ä¸ª InterruptedException å¼‚å¸¸ï¼Œå½“çº¿ç¨‹è¢« sleep() ä¼‘çœ æ—¶ï¼Œå¦‚æœè¢«ä¸­æ–­ï¼Œè¿™ä¼šå°±æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚
ï¼ˆæ³¨æ„ï¼šThread.sleep() æ–¹æ³•ç”±äºä¸­æ–­è€ŒæŠ›å‡ºçš„å¼‚å¸¸ï¼Œæ˜¯ä¼šæ¸…é™¤ä¸­æ–­æ ‡è®°çš„ã€‚ï¼‰

> wait, notify, notifyAlls

wait()æ–¹æ³•ä½¿å½“å‰çº¿ç¨‹è¿›è¡Œç­‰å¾…ï¼Œå¹¶é˜»å¡åœ¨å½“å‰ä»£ç å¤„ç›´åˆ°æ¥åˆ°é€šçŸ¥æˆ–è€…è¢«ä¸­æ–­ä¸ºæ­¢ã€‚åœ¨è°ƒç”¨wait()æ–¹æ³•ä¹‹å‰ï¼Œçº¿ç¨‹å¿…é¡»è·å¾—è°ƒç”¨wait()æ–¹æ³•çš„å¯¹è±¡çš„å¯¹è±¡çº§åˆ«é”ï¼Œå³åªèƒ½åœ¨åŒæ­¥å—æˆ–è€…åŒæ­¥æ–¹æ³•ä¸­è°ƒç”¨wait()æ–¹æ³•ã€‚å¦‚æœè°ƒç”¨waitæ—¶æ²¡æœ‰è·å¾—è¯¥å¯¹è±¡çš„é”ï¼Œåˆ™æŠ›å‡ºIllegalMonitorStateExceptionã€‚æ‰§è¡Œwait()åï¼Œå½“å‰çº¿ç¨‹é‡Šæ”¾é”ã€‚æ¥åˆ°é€šçŸ¥åï¼Œåœ¨wait()è¿”å›å‰ï¼Œçº¿ç¨‹éœ€è¦ä¸å…¶ä»–çº¿ç¨‹ç«äº‰é‡æ–°è·å¾—é”ã€‚

wait(long)æ–¹æ³•ä¸wait()ç±»ä¼¼ï¼Œä½†è¶…è¿‡è®¾å®šæ—¶é—´è‡ªåŠ¨å”¤é†’ã€‚

å½“çº¿ç¨‹waitçŠ¶æ€æ—¶ï¼Œè°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„interrupt()æ–¹æ³•å‡ºç°InterruptedExceptionå¼‚å¸¸ã€‚

notify()ä¹Ÿè¦åœ¨åŒæ­¥æ–¹æ³•ä¸­ï¼Œå³è°ƒç”¨æ—¶å½“å‰çº¿ç¨‹å¿…é¡»è·å¾—è°ƒç”¨å¯¹è±¡çš„å¯¹è±¡çº§åˆ«é”ã€‚æ²¡æœ‰æŒæœ‰é”æŠ›å‡ºIllegalMonitorStateExceptionã€‚è¯¥æ–¹æ³•ç”¨æ¥é€šçŸ¥é‚£äº›å¯èƒ½ç­‰å¾…è¯¥å¯¹è±¡çš„å¯¹è±¡é”çš„å…¶ä»–çº¿ç¨‹ã€‚å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œçº¿ç¨‹è§„åˆ’å™¨éšæœºæŒ‘é€‰ä¸€ä¸ªå‘ˆwaitçŠ¶æ€çš„çº¿ç¨‹ï¼Œå¯¹å…¶å‘å‡ºnotifyã€‚æ‰§è¡Œnotify()åï¼Œå½“å‰çº¿ç¨‹ä¸ä¼šç«‹åˆ»é‡Šæ”¾è¯¥å¯¹è±¡é”ï¼Œè¦ç­‰åˆ°é€€å‡ºsynchronizedä»£ç å—åæ‰ä¼šé‡Šæ”¾é”ã€‚å½“ç¬¬ä¸€ä¸ªè·å¾—è¯¥å¯¹è±¡é”çš„waitçº¿ç¨‹è¿è¡Œå®Œæ¯•ï¼Œä»–ä¼šæ˜¯å¦æ‰è¯¥å¯¹è±¡é”ï¼Œæ­¤æ—¶å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰å†æ¬¡ä½¿ç”¨notifyè¯­å¥ï¼Œåˆ™å³ä¾¿è¯¥å¯¹è±¡å·²ç»ç©ºé—²ï¼Œå…¶ä»–waitçŠ¶æ€çš„çº¿ç¨‹ä¾æ—§é˜»å¡çŸ¥é“è¯¥å¯¹è±¡å‘å‡ºnotifyæˆ–è€…notifyAllã€‚

è‹¥notifyæ—¶ï¼Œæ²¡æœ‰waitçš„çº¿ç¨‹ï¼Œè¯¥notifyå°†è¢«å¿½ç•¥ã€‚

notifyAll()ä¸notify()ç±»ä¼¼ï¼Œåªæ˜¯å”¤é†’æ‰€æœ‰waitçš„çº¿ç¨‹ã€‚

å› çº¿ç¨‹è°ƒåº¦çš„éšæœºæ€§ï¼Œè‹¥å…ˆçº¿ç¨‹Aå…ˆè°ƒç”¨notify()ä¹‹åçº¿ç¨‹Bæ‰è¿›å…¥wait()çŠ¶æ€ï¼Œå°†ä¼šå¯¼è‡´çº¿ç¨‹Bæ°¸ä¹…waitã€‚

> waitä¸sleepçš„åŒºåˆ«

- waitéœ€è¦åœ¨åŒæ­¥å—ä¸­è°ƒç”¨ï¼Œ é‡Šæ”¾é”ã€‚sleepä¸éœ€è¦å†åŒæ­¥å—ä¸­è°ƒç”¨ï¼Œä¸é‡Šæ”¾é”ã€‚
- waitéœ€è¦notifyå”¤é†’ï¼Œè€Œsleepå¯ä»¥è‡ªåŠ¨é†’æ¥ã€‚
- sleepæ˜¯é™æ€æ–¹æ³•ï¼Œwaitæ˜¯å¯¹è±¡æ–¹æ³•.

> join



#### çº¿ç¨‹ä¸­æ–­











## ReentrantLock

> Condition

> å…¬å¹³é”, å…ˆè¿›å…ˆå‡º

## Lockç±»

```
ReentrantReadWriteLock.ReadLock
ReentrantReadWriteLock.WriteLock
```





# åˆ†å¸ƒå¼

## åˆ†å¸ƒå¼å”¯ä¸€id

https://www.bilibili.com/video/BV1Mu41177ra/?vd_source=f79519d2285c777c4e2b2513f5ef101a

ä½¿ç”¨åˆ†å¸ƒå¼å”¯ä¸€idæœ‰ä¸‰ç§åŠæ³•

1. æ•°æ®åº“è‡ªå¢

   - åœ¨å•æœºçš„æƒ…å†µä¸‹è¿è½¬å¾ˆå¥½, ä½†æ˜¯å¦‚æœmysqlæ˜¯åˆ†å¸ƒå¼æ¶æ„,  é‚£ä¹ˆä½¿ç”¨mysqlè‡ªå¢ç»„ä»¶çš„èŒƒå›´åˆ†åŒºçš„è¯, ä¼šé€ æˆå°¾éƒ¨çƒ­ç‚¹(å†™å®Œä¸€ä¸ªåº“åœ¨å†™å¦å¤–ä¸€ä¸ªåº“)

     å…¶å®è‡ªå¢ç»„ä»¶çš„æ’å…¥æ•ˆç‡éå¸¸é«˜, æ‰€ä»¥å˜é€šçš„æ–¹å¼æ˜¯ä¸ä½¿ç”¨è‡ªå¢ä¸»é”®åšæ•°æ®åˆ†ç‰‡, è€Œä½¿ç”¨ä¸šåŠ¡çš„ç”¨æˆ·idåšæ•°æ®åˆ†ç‰‡, è¿™æ ·æ¯ä¸ªç”¨æˆ·çš„æ•°æ®éƒ½é›†ä¸­åœ¨ä¸€ä¸ªåº“, æ›´å†…èš

   - ä¸¤å¼ æ•°æ®è¡¨åˆå¹¶çš„æ—¶å€™å¯èƒ½ä¼šäº§ç”Ÿä¸»é”®å†²çª

2. UUID

   æ ¼å¼ä¸º: xxxxxxxxâ€”xxxxâ€”xxxxâ€”xxxxâ€”xxxxxxxxxxxx

   32ä¸ªåå…­è¿›åˆ¶æ•°, 128bit

   uuidæœ‰å¾ˆå¤šç‰ˆæœ¬, ä¸åŒç‰ˆæœ¬çš„ç”Ÿæˆè§„åˆ™ä¸ä¸€æ ·, ä½†æ˜¯å¤§ä½“ä¸Šæ˜¯ä½¿ç”¨æ—¶é—´, macåœ°å€, éšæœºæ•°ç­‰ç”Ÿæˆ

   - å…¨å±€å”¯ä¸€æ€§æœ€å¥½

   - æ ¼å¼å¤ªé•¿äº†, æµªè´¹ç©ºé—´

   - ä¸æ˜¯æœ‰åºçš„, åœ¨æ’å…¥åˆ°mysqlä¸­, ä¼šé€ æˆä¸»é”®ç´¢å¼•é‡æ’å’Œç£ç›˜ç¢ç‰‡

     (å¦‚ä¸‹å›¾, ä¸€ä¸ªé¡µ16k, æ¯æ¡æ•°æ®5k, é‚£ä¹ˆä¸€ä¸ªé¡µæœ€å¤š3æ¡æ•°æ®, å¦‚æœè¦æŠŠid=5çš„æ•°æ®å†™å…¥, éœ€è¦å°†id=5çš„æ•°æ®ä»page10ç§»åŠ¨åˆ°page28ä¸­, ç„¶åå†å°†id=4çš„æ•°æ®å†™å…¥åˆ°page10ä¸­, ç„¶åæ›´æ–°page15æŒ‡å‘page28çš„æŒ‡é’ˆ)

     <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230818173658755.png" alt="image-20230818173658755" style="zoom:25%;" />

   

3. é›ªèŠ±ç®—æ³•

   å ç”¨62bit

   ![image-20230818175001458](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20230818175001458.png)

   - ä¸¥é‡ä¾èµ–æœºå™¨çš„æ—¶é’Ÿ, å¦‚æœå‘ç”Ÿæ—¶é’Ÿå›æ‹¨, å¯èƒ½ä¼šç”Ÿæˆé‡å¤id

     å¯ä»¥ä½¿ç”¨**å¤šæ—¶é’Ÿ**, å³ä¿ç•™ä¸Šä¸€æ¬¡ç”Ÿæˆæ—¶é—´, å¦‚æœå‘ç”Ÿå›æ‹¨, å°†å½“å‰è·å–çš„æ—¶é—´ä¸ä¸Šæ¬¡æ—¶é—´æ¯”è¾ƒ, å³å¯æ£€æµ‹å‡ºæ—¶é’Ÿå›æ‹¨, åˆ‡æ¢åˆ°å¦å¤–çš„æ—¶é’Ÿå³å¯.

   - 41ä½æ—¶é—´æˆ³èƒ½ä½¿ç”¨69å¹´, åˆ°2039å¹´å°±å¤±æ•ˆäº†, å»ºè®®æ—¶é—´æˆ³å‡å»ä¸Šçº¿æ—¶çš„æ—¶é—´æˆ³, è¿™æ ·å°±å¯ä»¥ä½¿ç”¨69å¹´äº†

## æ¥å£å¹‚ç­‰

> ä»€ä¹ˆæ—¶å€™éœ€è¦å¹‚ç­‰

1. å‰ç«¯é‡å¤æäº¤

   ç”¨æˆ·åœ¨æ–°å¢é¡µé¢å¿«é€Ÿç‚¹å‡»å¤šæ¬¡, é€ æˆå¾ˆå¤šé‡å¤çš„è®¢å•

2. æ¶ˆæ¯é‡å¤æ¶ˆè´¹

   mqå°†æ¶ˆæ¯ç»™æ¶ˆè´¹è€…æ¶ˆè´¹, ä½†æ˜¯æ¶ˆè´¹å®Œè¿”å›ackç»™mqæ—¶ç½‘ç»œä¸­æ–­, è¿™æ—¶å€™mqä¼šé‡å¤å‘ç»™æ¶ˆè´¹ç«¯è¿›è¡Œæ¶ˆè´¹

3. é¡µé¢å›é€€å†æ¬¡æäº¤

   ç”¨æˆ·ä¸‹å•å®Œæˆå, ç‚¹å‡»è¿”å›æŒ‰é’®è¿”å›ä¸Šä¸€ä¸ªé¡µé¢, é‡æ–°ç‚¹å‡»ä¸‹å•æŒ‰é’®, å¦‚æœæ²¡æœ‰å¹‚ç­‰, ä¹Ÿä¼šé€ æˆé‡å¤ä¸‹å•çš„é—®é¢˜

4. å¾®æœåŠ¡ç›¸äº’è°ƒç”¨

   åˆ†å¸ƒå¼ç³»ç»Ÿä¸­, é€šè¿‡prcæˆ–è€…feignè¿›è¡Œè°ƒç”¨, å¦‚æœç½‘ç»œæ³¢åŠ¨, feignä¼šè§¦å‘é‡è¯•æœºåˆ¶, æ‰€ä»¥æˆ‘ä»¬è¦ä¿è¯æ¥å£å¹‚ç­‰

> å¦‚ä½•å®ç°å¹‚ç­‰

å®ç°å¹‚ç­‰, å…³é”®è¦è¯†åˆ«ä¸¤ä¸ªä¸€æ¨¡ä¸€æ ·çš„æäº¤, ä»–åˆ°åº•æ˜¯é‡å¤æäº¤, è¿˜æ˜¯ä¸åŒçš„æäº¤, æ¯”å¦‚ä¸‹å•ä¸­, ç”¨æˆ·å°±æ˜¯ä¹°äº†ä¸€æ¨¡ä¸€æ ·çš„ä¸œè¥¿, æ‰€æœ‰å‚æ•°éƒ½æ˜¯ä¸€æ ·çš„, è¦è¯†åˆ«ä»–åˆ°åº•æ˜¯ä¸‹å•æŒ‰é’®å¿«é€Ÿç‚¹å‡», è¿˜æ˜¯å°±æ˜¯ä¹°äº†ä¸€æ ·çš„ä¸œè¥¿

1. å‰ç«¯æäº¤æŒ‰é’®disable

2. é€šè¿‡æ•°æ®åº“å”¯ä¸€ç´¢å¼•ä¿è¯, 

   - å¯ä»¥åœ¨è¦æäº¤çš„è¡¨ä¸­æ·»åŠ ä¸€ä¸ªå”¯ä¸€å­—æ®µ, å‰ç«¯å‘é€è¯·æ±‚å‰, å…ˆè¯·æ±‚ä¸€ä¸ªæµæ°´å·, è¿™ä¸ªå¯ä»¥æ˜¯é›ªèŠ±ç®—æ³•ç”Ÿæˆ, ç„¶åå°†è¿™ä¸ªæµæ°´å·ä¸€èµ·å‘é€åˆ°åç«¯, å¹¶æ’å…¥åˆ°å­—æ®µä¸­, å¦‚æœå·²ç»å¤„ç†è¿‡äº†ä¼šæ’å…¥å¤±è´¥
   - ä¸“é—¨å¼„ä¸€ä¸ªé˜²é‡è¡¨, å°†å”¯ä¸€æµæ°´å·æ’å…¥åˆ°é˜²é‡è¡¨ä¸­, æ¯æ¬¡å¤„ç†ä¹‹å‰æŸ¥ä¸€ä¸‹è¿™ä¸ªæµæ°´å·æœ‰æ²¡æœ‰

3. é€šè¿‡redis token

   è¿˜æ˜¯å‰ç«¯å…ˆè¯·æ±‚ä¸€ä¸ªå”¯ä¸€æµæ°´å·, åç«¯å°†ä»–æ”¾åˆ°redisä¸­, å‰ç«¯å°†æµæ°´å·ä¸€èµ·å¸¦è¿‡æ¥, åç«¯æ¥æ”¶åˆ°å…ˆæŸ¥è¯¢redisä¸­æœ‰æ²¡æœ‰æµæ°´å·, å¦‚æœæœ‰åˆ æ‰, ç„¶åå¤„ç†ä¸šåŠ¡, å¦‚æœæ²¡æœ‰, è¯´æ˜å·²ç»å¤„ç†è¿‡äº†

   è¿™ç§æ–¹æ¡ˆæœ‰ä¸€å®šå±é™©æ€§

   - å…ˆåˆ é™¤tokenè¿˜æ˜¯å…ˆæ‰§è¡Œä¸šåŠ¡

     - å…ˆæ‰§è¡Œä¸šåŠ¡ååˆ é™¤token, é‚£ä¹ˆåˆ†å¸ƒå¼ç¯å¢ƒä¸‹è¿˜æ˜¯æœ‰å¯èƒ½é‡å¤
     - å…ˆåˆ é™¤tokenåæ‰§è¡Œä¸šåŠ¡, å¦‚æœä¸šåŠ¡è°ƒç”¨å¤±è´¥, å‰ç«¯é‡æ–°å‘é€è¯·æ±‚è¿˜æ˜¯ä¼šå¤±è´¥
     - ç»¼ä¸Šè¦å…ˆåˆ é™¤token, åæ‰§è¡Œä¸šåŠ¡, å¦‚æœä¸šåŠ¡è°ƒç”¨å¤±è´¥, è¦é‡æ–°è¯·æ±‚token

   - tokençš„è·å–, æ¯”è¾ƒ, åˆ é™¤ä¸æ˜¯åŸå­æ€§çš„, éœ€è¦ä½¿ç”¨luaè„šæœ¬

     ~~~LUA
     if redis.call('get', KEYS[1]) == ARGV[1]
     	then return redis.call('del', KEYS[1])
     else 
         return 0
     end
     ~~~





# JVM

#### jvmå†…å­˜ç»“æ„

1. ç¨‹åºè®¡æ•°å™¨: çº¿ç¨‹ç§æœ‰, å½“å‰çº¿ç¨‹æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨
2. javaè™šæ‹Ÿæœºæ ˆ: çº¿ç¨‹ç§æœ‰, æ‰§è¡Œæ–¹æ³•çš„æ—¶å€™åˆ›å»ºçš„æ ˆå¸§
3. æœ¬åœ°æ–¹æ³•æ ˆ: çº¿ç¨‹ç§æœ‰, æ‰§è¡Œnativeæ–¹æ³•æ—¶åˆ›å»ºçš„æ ˆå¸§
4. javaå †: å­˜æ”¾å®ä¾‹å¯¹è±¡
5. no-heapéå †:
   - code cache: jitå°†å­—èŠ‚ç è½¬æ¢ä¸ºæ±‡ç¼–, ä¿å­˜åœ¨è¿™é‡Œ
   - metaspace: å­˜å‚¨å·²ç»åŠ è½½çš„ç±»ä¿¡æ¯, å¸¸é‡, é™æ€å˜é‡,  è¿˜æœ‰è¿è¡Œæ—¶å¸¸é‡æ± 
6. ç›´æ¥å†…å­˜: äººå¦‚å…¶å



#### å†…å­˜å‚æ•°

- -Xms20m, è®¾ç½®å †æœ€å°20m

- -Xmx20m, è®¾ç½®å †æœ€å¤§20m

- -XX:+PrintGCDetails  åœ¨gcçš„æ—¶å€™æ‰“å°æ—¥å¿—

- -Xmn10m,  æ–°ç”Ÿä»£10m, å‰©ä½™çš„ä¸ºè€å¹´ä»£

- -XX:NewRatio=2, æ–°ç”Ÿä»£å’Œè€å¹´ä»£æ¯”ä¾‹ä¸º1:2

- -XX:SurvivorRatio=8, è®¾ç½®æ–°ç”Ÿä»£ä¸­edenå’ŒSurvivorçš„æ¯”ä¾‹

- -XX:+HeapDumpOnOutOfMemoryError

- jps æŸ¥çœ‹javaçš„è¿›ç¨‹å·

  ![image-20230825152101569](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20230825152101569.png)

- jmap -dump:file=a 26050,    dumpæ–‡ä»¶, aè¡¨ç¤ºæ–‡ä»¶åç§°, 26050è¡¨ç¤ºè¦dumpçš„javaè¿›ç¨‹



#### å¼•ç”¨çš„ç±»åˆ«

1. å¼ºå¼•ç”¨: åªè¦å¼•ç”¨è¿˜åœ¨å¯¹è±¡å°±ä¸ä¼šè¢«å›æ”¶

   ~~~java
   List list = new ArrayList();
   ~~~

2. è½¯å¼•ç”¨: åœ¨å†…å­˜æº¢å‡ºä¹‹å‰, ä¼šå¯¹è¿™äº›å¯¹è±¡è¿›è¡Œgc, å¦‚æœè¿˜æ˜¯ä¸å¤Ÿå°±æŠ¥é”™

   ~~~java
       @Test
       public void test() {
           String hello = new String("hello");
           SoftReference<String> softReference = new SoftReference<>(hello);
           hello = null;
   
           String world = new String("world");
           WeakReference<String> weakReference = new WeakReference<>(world);
           world = null;
           
           System.gc();
           System.out.println(softReference.get()); // hello
           System.out.println(weakReference.get()); // null
       }
   ~~~

   

3. å¼±å¼•ç”¨:  åªè¦æ‰§è¡Œgc, ä¸ç®¡å†…å­˜å¤Ÿä¸å¤Ÿéƒ½å›æ”¶ä»–ä»¬

4. è™šå¼•ç”¨: ä¸å½±å“ç”Ÿå­˜æ—¶é—´, åªæ˜¯åœ¨gcçš„æ—¶å€™ä¼šæ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥

#### åˆ¤æ–­å¯¹è±¡æ˜¯å¦éœ€è¦å›æ”¶çš„ç®—æ³•

1. å¼•ç”¨è®¡æ•°æ³•

   ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨, å½“æœ‰åœ°æ–¹å¼•ç”¨ä»–æ—¶å°±åŠ 1, å½“å¼•ç”¨å¤±æ•ˆæ—¶å°±å‡ä¸€

   å¾ˆéš¾è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜

2. å¯è¾¾æ€§ç®—æ³•

   ä»GC Roots(è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å˜é‡, æœ¬åœ°æ–¹æ³•æ ˆä¸­å¼•ç”¨çš„å˜é‡, æ–¹æ³•åŒºçš„å¸¸é‡, ç±»çš„é™æ€å±æ€§)å¼€å§‹å‘ä¸‹æœç´¢, å½“ä¸€ä¸ªå¯¹è±¡ä¸å¯è¾¾æ—¶, è¯´æ˜å¯ä»¥gcäº†

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230825152851318.png" alt="image-20230825152851318" style="zoom:25%;" />

#### åƒåœ¾æ¸…é™¤ç®—æ³•

1. æ ‡è®°æ¸…é™¤ç®—æ³•

   å…ˆæ ‡è®°å¤„æ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡, ç„¶åç»Ÿä¸€å›æ”¶

   ç¼ºç‚¹æ˜¯æ ‡è®°å’Œæ¸…é™¤æ•ˆç‡éƒ½ä¸é«˜, è€Œä¸”äº§ç”Ÿå†…å­˜ç¢ç‰‡å¯¼è‡´æ²¡æœ‰è¿ç»­ç©ºé—´åˆ†é…å¤§å¯¹è±¡è€Œä¸å¾—ä¸è¿›è¡Œå¦ä¸€æ¬¡gc

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230825234526266.png" alt="image-20230825234526266" style="zoom:50%;" />

2. æ ‡è®°æ•´ç†ç®—æ³•

   å…ˆæ ‡è®°æ‰€æœ‰è¦æ¸…ç†çš„å¯¹è±¡, ç„¶åè®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½å‘ä¸€ç«¯ç§»åŠ¨, ç›´æ¥æ¸…ç†æ‰è¾¹ç•Œå¤–çš„å†…å­˜

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230825234730428.png" alt="image-20230825234730428" style="zoom:50%;" />

3. å¤åˆ¶ç®—æ³•

   å°†å†…å­˜åˆ†ä¸ºä¸¤å—åœ°æ–¹,  æ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—, å½“ä¸€å—ç”¨å®Œä»¥å, å°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—ä¸Šé¢, ç„¶ååœ¨æ¸…ç†æ‰åŸæ¥ä¸Šé¢çš„æ‰€æœ‰å¯¹è±¡

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230825235234815.png" alt="image-20230825235234815" style="zoom:50%;" />

4. åˆ†å¸¦æ”¶é›†ç®—æ³•

   å°†javaå †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£, æ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•, è€å¹´ä»£ä½¿ç”¨æ ‡è®°æ¸…ç†æˆ–è€…æ ‡è®°æ•´ç†ç®—æ³•



#### å†…å­˜çš„åˆ†é…å’Œå›æ”¶ç­–ç•¥

> å†…å­˜ç©ºé—´å’Œä½¿ç”¨çš„åƒåœ¾ç®—æ³•

å †å†…å­˜ä½¿ç”¨åˆ†ä»£æ”¶é›†ç®—æ³•, è¢«åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£, é»˜è®¤æ¯”ä¾‹ä¸º1:2

åœ¨**æ–°ç”Ÿä»£ä¸­ä½¿ç”¨å¤åˆ¶ç®—æ³•**, **è€å¹´ä»£ä¸­æ ‡è®°æ•´ç†ç®—æ³•**

å…¶ä¸­æ–°ç”Ÿä»£åˆåˆ†æˆ**edenå’Œ2ä¸ªsurvivoråŒº, ä»–ä»¬åˆ†åˆ«æ˜¯survivor fromåŒºå’Œsurvivor toåŒº**

**edenå’Œsurvivorçš„æ¯”ä¾‹é»˜è®¤ä¸ºä¸º8:1**

> æ–°ç”Ÿä»£

å‘ç”Ÿåœ¨æ–°ç”Ÿä»£çš„gcè¢«ç§°ä¸ºminorGC

å‘ç”Ÿæ—¶æœº: åœ¨åˆ†é…å¯¹è±¡çš„æ—¶å€™æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´

 

**æ–°ç”Ÿä»£å¯ç”¨çš„åŒºåŸŸæ˜¯edenåŒºå’Œ1ä¸ªsurvivoråŒº**, å¯¹è±¡ä¼šä¼˜å…ˆåˆ†é…åœ¨edenä¸­(è¿ç»­å†…å­˜ç©ºé—´çš„javaå¯¹è±¡, æ¯”å¦‚bety[]ä¼šç›´æ¥åˆ†é…åœ¨è€å¹´åŒº), å½“edenä¸­æ²¡æœ‰è¶³å¤Ÿç©ºé—´æ—¶, ä¼šè¿›è¡Œä¸€æ¬¡MinorGC

å½“åƒåœ¾å›æ”¶çš„æ—¶å€™, ä¼šä½¿ç”¨å¤åˆ¶ç®—æ³•, å°†edenåŒºå’Œå…¶ä¸­ä¸€ä¸ªsurvivoråŒºå­˜æ´»çš„å¯¹è±¡æ‹·è´åˆ°å¦å¤–ä¸€ä¸ªsurvivoråŒºåŸŸä¸­, å¦‚æœsurvivorä¸å¤Ÿ, é‚£ä¹ˆä¼šé€šè¿‡æ‹…ä¿æœºåˆ¶å°†**è¿™äº›å­˜æ´»çš„å¯¹è±¡å…¨éƒ¨**æå‰ç§»å…¥è€å¹´ä»£

> è€å¹´ä»£

å‘ç”Ÿåœ¨è€å¹´ä»£çš„gcç§°ä¸ºFullGC/MajorGC

å‘ç”Ÿçš„æ—¶æœº: 

- åœ¨å‘ç”ŸMinorGCä¹‹å‰, è€å¹´åŒºè¿ç»­ç©ºé—´å°äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡ç©ºé—´(é˜²æ­¢æ–°ç”Ÿä»£å…¨éƒ¨æ™‹å‡åˆ°è€å¹´ä»£, æˆ–è€…ç©ºé—´æ‹…ä¿å¤±è´¥)å¹¶ä¸”è¿ç»­ç©ºé—´å°äºå†æ¬¡æ™‹å‡å¯¹è±¡çš„å¹³å‡å¤§å°,  é‚£ä¹ˆå°±ä¼šå‘ç”ŸFullGC

> å¯¹è±¡å¦‚ä½•åˆ°è€å¹´ä»£

- æ–°ç”Ÿä»£çš„å¯¹è±¡æ¯ç†¬è¿‡ä¸€ä¸ªminorGC, å¹´é¾„å°±å¢åŠ 1å², åˆ°äº†15å²(-XX:MaxTenuringThreshold=15)æ—¶è¢«ç§»åŠ¨åˆ°è€å¹´ä»£

- å½“Survivorä¸­æŸä¸€å¹´é¾„çš„æ‰€æœ‰å¯¹è±¡æ€»å’Œå¤§äºSurvivorç©ºé—´çš„ä¸€åŠ, ä¼šæŠŠå¹´é¾„å¤§äºç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡ç›´æ¥ç§»å…¥è€å¹´ä»£, æ— éœ€ç­‰å¾…åˆ°MaxTenuringThreshold
- ç©ºé—´æ‹…ä¿æœºåˆ¶
- å¤§å¯¹è±¡ç›´æ¥åˆ†é…åœ¨è€å¹´åŒº

> ä¸ºä»€ä¹ˆè¦ä¸¤ä¸ªsurvivoråŒºåŸŸ

å‡å¦‚åªæœ‰ä¸€ä¸ªsurvivoråŒºåŸŸ, å¼€å§‹åˆ†é…å¯¹è±¡åœ¨eden, è¿›è¡Œgcåå¤åˆ¶åˆ°survivoråŒºåŸŸ, é‚£ä¹ˆä¸‹æ¬¡å†æ¬¡gcçš„æ—¶å€™, å¦‚æœåœ¨survivoråŒºåŸŸä½¿ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•, é‚£ä¹ˆè¿™ä¸ªåŒºåŸŸå°±ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡, å¦‚æœä½¿ç”¨æ ‡è®°æ•´ç†ç®—æ³•çš„è¯, æ•ˆç‡åˆå¤ªæ…¢äº†

æ‰€æœ‰å¼„ä¸¤ä¸ªsurvivor, è¿™æ ·edenå’Œ1ä¸ªsurvivoréƒ½å¯ä»¥ä½¿ç”¨å¤åˆ¶ç®—æ³•å°†å¯¹è±¡å¼„åˆ°å¦å¤–ä¸€ä¸ªsurvivoråŒºåŸŸ

#### åƒåœ¾æ”¶é›†å™¨

jdk9æœåŠ¡ç«¯é»˜è®¤ä½¿ç”¨G1

jdk8é»˜è®¤ä½¿ç”¨Parallel Scavenge + Parallel Old

> æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†å™¨

1. Serial(-XX:UseSerialGC) **stop the world**

   å•çº¿ç¨‹, å¤åˆ¶ç®—æ³•, é€‚åˆå°å†…å­˜çš„æƒ…å†µ(å†…å­˜ä¸å¤§, stop the worldæ—¶é—´æ®µ)

   ![img](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/v2-66b0d885dfbcc5ed9b3bd586ed68a3d7_1440w.webp)

2. ParNew(-XX:+UseParNewGC) **stop the world**

   Serialçš„å¤šçº¿ç¨‹ç‰ˆæœ¬

   ![img](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/v2-cc5603528be1a73aad9c1045f65ef5d3_1440w.webp)

3. Parallel Scavenge(-XX:+UseParallelGC) **stop the world**

   å’ŒParNewå¾ˆåƒ, ä½†æ˜¯å¯ä»¥æ§åˆ¶åƒåœ¾å›æ”¶çš„æ—¶é—´

   -XX:MaxGCPauseMillisè®¾ç½®åƒåœ¾å›æ”¶çš„æœ€å¤§åœé¡¿æ—¶é—´, å•ä½æ¯«ç§’, åœé¡¿è¶Šå°, å›æ”¶çš„æ—¶é—´å°±è¶Šå°

   -XX:GCTimeRatioè®¾ç½®åƒåœ¾æ”¶é›†æ—¶é—´å æ¯”çš„è®¡ç®—å› å­, å½“è®¾ç½®æˆ15ï¼Œé‚£å°±æ˜¯ 1 / (1+15) = 0.0625ï¼Œå°±æ˜¯å…è®¸æœ€å¤§åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„6.25%ï¼Œå½“è®¾ç½®æˆ99çš„æ—¶å€™ï¼Œå°±æ˜¯ 1 / (1+99) = 0.01ï¼Œä¹Ÿå°±æ˜¯å…è®¸æœ€å¤§åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„1%

> è€å¹´ä»£åƒåœ¾æ”¶é›†å™¨

1. Serial Old(-XX:+UseSerialOldGC)

   Serialçš„è€å¹´ä»£ç‰ˆæœ¬, å•çº¿ç¨‹, stop the world, æ ‡è®°æ•´ç†ç®—æ³•

   ![image-20230826212734470](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20230826212734470.png)

2. Parallel Old(-XX:+UseParallelOldGC)

   Parallel Scavengeçš„è€å¹´ä»£ç‰ˆæœ¬, æ ‡è®°æ•´ç†ç®—æ³•

   ![img](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/v2-7928f5c712387383f5ee9f8f95c0e136_1440w.webp)

3. CMS(-XX:+UseConcMarkSweepGC)

   å¤šçº¿ç¨‹, ä½åœé¡¿, **æ ‡è®°æ¸…é™¤**ç®—æ³•ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡

   å››ä¸ªæ­¥éª¤:

   1. åˆå§‹æ ‡è®°: stop the world, æ ‡è®°GCRootsç›´æ¥å…³è”åˆ°çš„å¯¹è±¡, é€Ÿåº¦å¾ˆå¿«
   2. å¹¶å‘æ ‡è®°: å¯¹GCRoots Tracing, 
   3. é‡æ–°æ ‡è®°: stop the world, ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·ç¨‹åºè¿è¡Œå¯¼è‡´å˜åŠ¨çš„å¯¹è±¡çš„æ ‡è®°è®°å½•, åœé¡¿æ—¶é—´ä¼šæ¯”æ­¥éª¤1é•¿ä¸€ç‚¹
   4. å¹¶å‘æ¸…é™¤: å¤šçº¿ç¨‹æ¸…é™¤

   ![img](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/v2-9e12c593a997818d5d21c42354bcdc31_1440w.webp)

4. Garbage First(G1)

   g1æ”¹å˜äº†javaå †å†…å­˜è€å¹´ä»£å’Œæ–°ç”Ÿä»£çš„å¸ƒå±€æ–¹å¼, è€Œæ˜¯å°†æ–°ç”Ÿä»£åˆ†ä¸ºå¾ˆå¤šç›¸åŒå¤§å°çš„åŒºåŸŸ(Region), æ–°ç”Ÿä»£è€å¹´ä»£ä¸åœ¨å›ºå®š, æ¯ä¸ªRegionéƒ½å¯ä»¥æ ¹æ®æƒ…å†µæ‰®æ¼”Eden, Survivor, è€å¹´ä»£, HumongousåŒºåŸŸ

   å¤§å¯¹è±¡ä¼šè¢«å­˜å‚¨åˆ°HumongousåŒºåŸŸï¼ŒG1å¤§å¤šæ•°æƒ…å†µä¸‹ä¼šæŠŠè¿™ä¸ªåŒºåŸŸå½“ä½œè€å¹´ä»£æ¥çœ‹å¾…ã€‚å¦‚æœå¯¹è±¡å ç”¨ç©ºé—´è¶…è¿‡Regionçš„å®¹é‡ï¼Œå°±ä¼šå­˜æ”¾åˆ°Nä¸ªè¿ç»­çš„ Humongous Region ä¸­ã€‚

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/v2-52e1c25b4f4ff09ab599a1e5b28ea6a2_1440w.webp" alt="img" style="zoom: 33%;" />

   å››ä¸ªæ­¥éª¤ï¼š

   1. åˆå§‹æ ‡è®°
      Stop The World, åªæ ‡è®° GC Roots èƒ½ç›´æ¥å…³è”çš„å¯¹è±¡ï¼Œæ—¶é—´å¾ˆçŸ­

   2. å¹¶å‘æ ‡è®°
      ä»GC Rootå¼€å§‹, æ‰¾å‡ºå­˜æ´»çš„å¯¹è±¡ã€‚è¿™ä¸ªæ­¥éª¤è€—æ—¶è¾ƒé•¿ï¼Œä½†ç”¨æˆ·çº¿ç¨‹å¯ä»¥å’ŒGCçº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚
   3. æœ€ç»ˆæ ‡è®°
      Stop The World, å¤„ç†å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œç”¨æˆ·çº¿ç¨‹ç»§ç»­è¿è¡Œäº§ç”Ÿçš„å¼•ç”¨å˜åŠ¨
   4. ç­›é€‰å›æ”¶
      Stop The World, ä½¿ç”¨çš„æ˜¯å¤åˆ¶ç®—æ³•, å›æ”¶ä½¿ç”¨çš„æ˜¯**å¤åˆ¶ç®—æ³•**ï¼ŒæŠŠéœ€è¦å›æ”¶çš„è¿™äº›Regioné‡Œå­˜æ´»çš„å¯¹è±¡ï¼Œå¤åˆ¶åˆ°ç©ºé—²çš„Regionä¸­ï¼Œç„¶åæ¸…ç†æ‰æ—§Regionå…¨éƒ¨ç©ºé—´, å› ä¸ºéœ€è¦ç§»åŠ¨å­˜æ´»çš„å¯¹è±¡ï¼Œæ‰€ä»¥ä¸å¯é¿å…çš„è¦æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œè¿™ä¸ªæ­¥éª¤æ”¯æŒå¤šæ¡çº¿ç¨‹å¹¶è¡Œå›æ”¶

   ![img](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/v2-d7583c40c53f1bf11acebf18449654fc_1440w.webp)



#### visualvmçš„ä½¿ç”¨

https://www.cnblogs.com/krock/p/14419459.html

https://www.cnblogs.com/wade-xu/p/4369094.html

1. åœ¨https://visualvm.github.io/download.htmlä¸‹è½½vmsual

2. åœ¨visualvmä¸­å®‰è£… å¦‚ä¸‹å‡ ä¸ª æ’ä»¶

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830183202855.png" alt="image-20230830183202855" style="zoom:33%;" />

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830144827405.png" alt="image-20230830144827405" style="zoom:25%;" />

3. ä½¿ç”¨ä¸€ä¸‹ä»£ç ä½œä¸ºå®ä¾‹ï¼Œ å¹¶æ·»åŠ vmå‚æ•°

   ~~~java
   public static void main(String[] args)
           throws InterruptedException, XMLSignatureException, NoSuchAlgorithmException {
           // xmså †æœ€å°æ•° xmxå †æœ€å¤§æ•° xmnæ–°ç”Ÿä»£æ•° SurvivorRatio edenå’ŒSurvivorçš„æ¯”ä¾‹
           // å¯åŠ¨æ—¶æ·»åŠ -Xms20m -Xmx20m -Xmn10m -XX:SurvivorRatio=8 -XX:+PrintGCDetails
   
           ArrayList<Thread> threads = new ArrayList<>();
           for (int i = 0; i < 3; i++) {
               Thread thread = new Thread(() -> {
                   while (true) {
                       byte[] bytes = new byte[1024];
                       for (int j = 0; j < 1000000; j++) {
                           String hash = "35454B055CC325EA1AF2126E27707052";
                           String password = "ILoveJava";
                           MessageDigest md = null;
                           try {
                               md = MessageDigest.getInstance("MD5");
                           } catch (NoSuchAlgorithmException e) {
                               throw new RuntimeException(e);
                           }
                           md.update(password.getBytes());
                           byte[] digest = md.digest();
                           String myHash = DatatypeConverter.printHexBinary(digest).toUpperCase();
                       }
                       try {
                           Thread.sleep(500);
                       } catch (InterruptedException e) {
                           throw new RuntimeException(e);
                       }
                   }
               });
               thread.setName("thread-" + i);
               thread.start();
               threads.add(thread);
           }
   
           System.out.println("hello");
   
       }
   ~~~

4. åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ·»åŠ çš„vmå‚æ•°

   <img src="img/é¢è¯•é¢˜/image-20230830145105811.png" alt="image-20230830145105811" style="zoom:25%;" />

   

5. é€šè¿‡visual GCæŸ¥çœ‹å†…å­˜æƒ…å†µ

   https://blog.csdn.net/qq_28369007/article/details/105857310#Graphs%E7%AA%97%E5%8F%A3

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830150732047.png" alt="image-20230830150732047" style="zoom:25%;" />

6. é€šè¿‡ThreadsæŸ¥çœ‹çº¿ç¨‹çš„çŠ¶æ€ä¸æ‰§è¡Œæ—¶é—´

   https://blog.csdn.net/luo15242208310/article/details/121370797

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830164109644.png" alt="image-20230830164109644" style="zoom:25%;" />

7. é€šè¿‡Sample->cpu -> cpu samplesæŸ¥çœ‹æ¯ä¸ªçº¿ç¨‹çš„è°ƒç”¨æ ˆ, ä»¥åŠæ¯ä¸ªæ–¹æ³•çš„å ç”¨æ—¶é—´

   é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥æŸ¥çœ‹åˆ°åº•æ˜¯å“ªä¸ªæ–¹æ³•ç‰¹åˆ«å ç”¨æ—¶é—´

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830173602088.png" alt="image-20230830173602088" style="zoom:25%;" />

8. é€šè¿‡sample->cpu->thread cpu timeæŸ¥çœ‹æ¯ä¸ªçº¿ç¨‹å ç”¨äº†å¤šå°‘cpuæ—¶é—´, è¿™æ ·å¯ä»¥æ‰¾åˆ°æ­£åœ¨æ‰§è¡Œå¤§ä»»åŠ¡çš„çº¿ç¨‹

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830173836705.png" alt="image-20230830173836705" style="zoom:25%;" />

9. é€šè¿‡Sample -> memory -> heap histogram æŸ¥çœ‹å †å†…å­˜ä¸­å„ä¸ªç±»å®ä¾‹æ‰€å ç”¨çš„å†…å­˜å¤§å°

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830174018738.png" alt="image-20230830174018738" style="zoom:25%;" />

   

10. é€šè¿‡Sample -> memory -> per thead allocationsæŸ¥çœ‹æ¯ä¸ªçº¿ç¨‹åˆ›å»ºçš„å¯¹è±¡å ç”¨å †å†…å­˜çš„å¤§å°å’Œç™¾åˆ†æ¯”

    ![image-20230830174250024](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20230830174250024.png)

#### çº¿ç¨‹dump

1. ç”Ÿæˆçº¿ç¨‹dump

   - idea

     ![image-20230830203808240](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20230830203808240.png)

   - é€šè¿‡visual vm

     <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830220253273.png" alt="image-20230830220253273" style="zoom: 25%;" />

   - jstackæŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹åœ¨æŸä¸€æ—¶åˆ»çš„çŠ¶æ€å’Œè°ƒç”¨æ ˆ

     jstack pid

     jstack pid >> a.txt è¾“å‡ºåˆ°æ–‡ä»¶

#### å †å†…å­˜dump

1. jmap -dump:file=filename pid ç›´æ¥dumpåˆ°æ–‡ä»¶ä¸­

2. jmap -heap pid æ‰“å°å†…å­˜ä¿¡æ¯

3. é€šè¿‡visula vm

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830221347034.png" alt="image-20230830221347034" style="zoom:33%;" />

#### cpuå ç”¨è¿‡é«˜è§£å†³

1. é€šè¿‡topå‘½ä»¤, æŸ¥çœ‹cpuå ç”¨è¿‡é«˜çš„è¿›ç¨‹

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830221816172.png" alt="image-20230830221816172" style="zoom:50%;" />

2. é€šè¿‡`ps H -eo pid, tid, %cpu | grep pid`æ¥æŸ¥çœ‹è¿›ç¨‹ä¸‹é¢æœ‰å“ªäº›çº¿ç¨‹, å·²ç»çº¿ç¨‹çš„cpuä½¿ç”¨æƒ…å†µ

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230830221959157.png" alt="image-20230830221959157" style="zoom:33%;" />

3. é€šè¿‡jstackæ¥æŸ¥çœ‹çº¿ç¨‹dump, jstackæ˜¾ç¤ºæ‰€æœ‰çº¿ç¨‹çš„è°ƒç”¨æ ˆ, ä½†æ˜¯tidæ˜¯åå…­è¿›åˆ¶çš„, æ‰€ä»¥éœ€è¦å°†ä¸Šé¢é€šè¿‡psæ‰¾åˆ°çš„çº¿ç¨‹idè½¬æ¢ä¸º16è¿›åˆ¶ä¹‹å,  å†å»çº¿ç¨‹dumpä¸­æ‰¾å¯¹åº”çš„çº¿ç¨‹æ ˆ



# é›†åˆ

#### ArrayListä»‹ç»

- çº¿ç¨‹ä¸å®‰å…¨
- åº•å±‚ä½¿ç”¨æ•°ç»„æ¥å®ç°, æœ‰åº, èƒ½å¤Ÿè¿›è¡Œéšæœºè¯»å†™, æ·»åŠ ä¿®æ”¹å¿«, æ’å…¥åˆ é™¤æ…¢(éœ€è¦ç§»åŠ¨å…ƒç´ )
- å…ƒç´ å¯ä»¥ä¸ºnull
- åˆå§‹å®¹é‡ä¸º10, æ•°ç»„ä¸å¤Ÿç”¨çš„æ—¶å€™æ‰©å®¹å®¹é‡å˜æˆåŸæ¥çš„1.5å€, æœ€å¤§å®¹é‡ä¸ºInt.Max
- æ‰©å®¹1.5å€çš„åŸå› åœ¨äº, æ‰©å®¹éœ€è¦åˆ†é…æ¯”åŸæ¥æ•°ç»„æ›´å¤§çš„è¿ç»­åœ°å€ç©ºé—´, å¦‚æœåˆå§‹å®¹é‡10,æ‰©å®¹2å€çš„è¯, æ¯æ¬¡éœ€è¦åˆ†é…çš„è¿ç»­ç©ºé—´æ˜¯10, 20, 40, 80, 160. ä½ ä¼šå‘ç°ç¬¬ä¸‰æ¬¡åˆ†é…éœ€è¦40è¿ç»­ç©ºé—´, è€Œå‰ä¸¤æ¬¡åˆ†é…çš„æ€»çš„è¿ç»­ç©ºé—´ä¸º30, ä¸èƒ½é‡ç”¨åŸæ¥çš„è¿ç»­ç©ºé—´. å¦‚æœæ˜¯1.5å€çš„è¯æ¯æ¬¡éœ€è¦åˆ†é…10 15 22 33 49, åœ¨ç¬¬ä¸‰æ¬¡åˆ†é…çš„æ—¶å€™éœ€è¦22, è€Œå‰ä¸¤æ¬¡åˆ†é…çš„è¿ç»­åœ°å€ç©ºé—´ä¸º25, å¯ä»¥é‡ç”¨ä¹‹å‰åˆ†é…çš„è¿ç»­ç©ºé—´, åœ¨ç¬¬äº”æ¬¡åˆ†é…çš„æ—¶å€™éœ€è¦49, è€Œå‰ä¸¤æ¬¡åˆ†é…çš„è¿ç»­ç©ºé—´ä¸º22+33=55, ä¹Ÿå¯ä»¥é‡ç”¨ç©ºé—´
- åœ¨è°ƒç”¨ArrayListè¿­ä»£å™¨å, åªèƒ½é€šè¿‡iterator.removeæ¥ä¿®æ”¹ç»“æ„äº†(ArrayList.add, removeæ–¹æ³•å°†ä¸èƒ½å†ä½¿ç”¨), å¦åˆ™å°†ä¿å­˜ConcurrentModificationException

#### Vector

- çº¿ç¨‹å®‰å…¨

- åº•å±‚ä½¿ç”¨æ•°ç»„

- æ‰€æœ‰çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•éƒ½åŠ äº†synchronizedå…³é”®å­—, æ•ˆç‡æ…¢

- æ¯æ¬¡æ‰©å®¹å˜æˆåŸæ¥çš„2å€

  ![image-20220907231805715](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20220907231805715.png)

  ![image-20220907231829177](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20220907231829177.png)

  ![image-20220907232024291](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20220907232024291.png)

#### ä¸ºä»€ä¹ˆArrayListçº¿ç¨‹ä¸å®‰å…¨

https://blog.csdn.net/u012859681/article/details/78206494

ArrayListæ·»åŠ å…ƒç´ éœ€è¦å¦‚ä¸‹æ­¥éª¤:

1. åˆ¤æ–­å®¹é‡æ˜¯å¦è¶³å¤Ÿ, ä¸è¶³å°±æ‰©å®¹
2. èµ‹å€¼
3. size++

~~~java
public boolean add(E e) {
        ensureCapacityInternal(size + 1);  // ç¡®ä¿å®¹é‡
        elementData[size++] = e;
        return true;
    }
private void ensureExplicitCapacity(int minCapacity) {
        modCount++;

        // å®¹é‡ä¸è¶³å°±ç¿»å€
        if (minCapacity - elementData.length > 0)
            grow(minCapacity);
    }
~~~

å¯èƒ½å‡ºç°å¦‚ä¸‹æƒ…å†µ: 

1. ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ¤æ–­å®¹é‡å……è¶³, éƒ½ä¸æ‰©å®¹, ç„¶åç¬¬ä¸€ä¸ªæ·»åŠ å®Œæ¯•å, ç¬¬äºŒä¸ªæ·»åŠ å¯èƒ½å¯¼è‡´æ•°ç»„è¶Šç•Œ
2. èµ‹å€¼é˜¶æ®µä¸¤ä¸ªçº¿ç¨‹éƒ½å¯èƒ½å–sizeè¿›è¡Œèµ‹å€¼, å¯¼è‡´åä¸€ä¸ªçº¿ç¨‹çš„å€¼è¦†ç›–å‰ä¸€ä¸ªçº¿ç¨‹çš„å€¼
3. size++çº¿ç¨‹ä¸å®‰å…¨

#### éœ€è¦çº¿ç¨‹å®‰å…¨çš„Listæ€ä¹ˆåŠ

1. ä½¿ç”¨Vector

2. ä½¿ç”¨Collectors.synchronizedList()æ–¹æ³•ä¼ å…¥ä¸€ä¸ªArrayList, åŸç†æ˜¯è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªList, è¯¥Listæ‰€æœ‰çš„å¢åˆ æ”¹æ–¹æ³•éƒ½ä¼šæ·»åŠ synchronizedå…³é”®å­—, ç„¶åè°ƒç”¨ArrayListå¯¹åº”æ–¹æ³•

   Collectors.synchronizedList()å’ŒVectorå®ç°åŒæ­¥çš„æ–¹å¼éƒ½å·®ä¸å¤š, ä½†æ˜¯è¿˜æ˜¯**æ¨èä½¿ç”¨Collectors.synchronizedList()**, å› ä¸ºè¯¥æ–¹æ³•å¯ä»¥åŒ…è£…ä»»ä½•ä»¥List, å¯ä»¥ä¿ç•™Listçš„åŸæ¥çš„ç‰¹æ€§, æ¯”è¾ƒé€šç”¨

   ![image-20220907232215213](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20220907232215213.png)

   Collectors.synchronizedList()è¿”å›çš„Listçš„Iteratoræ²¡æœ‰åšåŒæ­¥å¤„ç†, éœ€è¦ç”¨æˆ·è‡ªå·±åšåŒæ­¥

   ~~~java
   public Iterator<E> iterator() {
       return list.iterator(); // Must be manually synched by user!
   }
   
   final Iterator<String> iterator = list.iterator();
   synchronized (list) {
       while (iterator.hasNext()) {
           final String next = iterator.next();
           System.out.println(next);
       }
   }
   ~~~

3. ä½¿ç”¨CopyOnWriteList



#### LinkedList

- ç»§æ‰¿äº†List, Deque(åŒç«¯é˜Ÿåˆ—)æ¥å£, å¯ä»¥å½“åšé˜Ÿåˆ—å’Œæ ˆæ¥ä½¿ç”¨
- åº•å±‚ä½¿ç”¨åŒå‘é“¾è¡¨æ¥å®ç°
- å¤´å°¾æ“ä½œå¿«, éšæœºè¯»å†™æ…¢(å› ä¸ºéœ€è¦ä¸€æ­¥ä¸€æ­¥è¿›è¡Œéå†)
- å†…éƒ¨å…ƒç´ å¯ä»¥ä¸ºnull
- çº¿ç¨‹ä¸å®‰å…¨



#### ArrayDeque

- å®ç°çš„Dequeæ¥å£, æ²¡æœ‰å®ç°Listæ¥å£
- åº•å±‚ä½¿ç”¨å¾ªç¯æ•°ç»„å®ç°
- æ¯æ¬¡æ‰©å®¹ä¸º2å€, åˆå§‹å®¹é‡ä¸º16
- çº¿ç¨‹ä¸å®‰å…¨
- å…ƒç´ ä¸èƒ½ä¸ºnull
- åœ¨éœ€è¦ä½¿ç”¨é˜Ÿåˆ—å’Œæ ˆçš„æ—¶å€™æ¨èä½¿ç”¨ArrayDequeè€ŒéLinkedListå› ä¸º
  - æ•°ç»„çš„å¯»å€æ•ˆç‡æ¯”é“¾è¡¨é«˜
  - LinkedLitæ¯æ¬¡addéƒ½éœ€è¦åˆ›å»ºNodeå¯¹è±¡, è¿™ä¸ªè¿‡ç¨‹ä¼šè§¦å‘å¯¹è±¡åˆ›å»º, æ¯”è¾ƒæ…¢





#### HashMap

- çº¿ç¨‹ä¸å®‰å…¨
- keyå’Œvalueéƒ½å¯ä»¥ä¸ºnull, å¦‚æœkeyä¸ºnull, hashä¸º0, æ°¸è¿œå­˜æ”¾åœ¨ç¬¬ä¸€ä¸ªæ¡¶ä¸­
- åˆå§‹å®¹é‡16, æœ€å¤§å®¹é‡2^30, è´Ÿè½½å› å­0.75, è¾¾åˆ°å®¹é‡çš„0.75ä¹‹åæ‰©å®¹ä¸ºåŸæ¥çš„ä¸¤å€
- åº•å±‚ä½¿ç”¨çš„æ˜¯æ•°ç»„åŠ é“¾è¡¨çš„æ•°æ®ç»“æ„, å½“é“¾è¡¨é•¿åº¦è¾¾åˆ°8å¹¶ä¸”æ•°ç»„é•¿åº¦å¤§äº64ä»¥åå°†ä¼šè½¬åŒ–ä¸ºçº¢é»‘æ ‘, å½“çº¢é»‘æ ‘çš„èŠ‚ç‚¹å°äº6ä¸ªçš„æ—¶å€™å°†ä¼šæŠŠçº¢é»‘æ ‘é€€åŒ–æˆé“¾è¡¨, æ ‘åŒ–é˜ˆå€¼æ˜¯8è€Œé€€åŒ–é˜ˆå€¼æ˜¯6æ˜¯å› ä¸ºå¦‚æœä¸¤è€…ç›¸åŒ, é‚£ä¹ˆé¢‘ç¹çš„å¢åˆ æ“ä½œæœ‰å¯èƒ½å¯¼è‡´åå¤çš„é€€åŒ–å’Œæ ‘åŒ–. 

- putæ–¹æ³•çš„æ­¥éª¤: 
  1. è®¡ç®—keyçš„hash, å¯¹æ•°ç»„é•¿åº¦å–ä½™, è·å–åˆ°éœ€è¦æ’å…¥çš„æ•°ç»„ä¸‹æ ‡
  2. å¦‚æœè¯¥æ•°ç»„ä½ç½®ä¸ºnull, ç›´æ¥æ”¾å…¥, å¦‚æœæ”¾å…¥åæ•°ç»„å…ƒç´ è¶…è¿‡é˜ˆå€¼, éœ€è¦å¯¹æ•°ç»„æ‰©å®¹
  3. å¦‚æœæ•°ç»„ä½ç½®æœ‰å…ƒç´ , åˆ¤æ–­è¯¥ä½ç½®ä¸Šçš„å­˜å‚¨çš„æ˜¯TreeNode(TreeNodeç»§æ‰¿è‡ªEntry)
     - å¦‚æœæ˜¯TreeNodeè¯´æ˜å½“å‰èŠ‚ç‚¹ç»„æˆçš„æ˜¯çº¢é»‘æ ‘, è°ƒç”¨çº¢é»‘æ ‘çš„æ–¹æ³•æ’å…¥åˆ°å¯¹åº”ä½ç½®
     - å½“å‰èŠ‚ç‚¹ç»„æˆçš„æ˜¯é“¾è¡¨, æ’å…¥åˆ°é“¾è¡¨çš„å°¾ç«¯, å¦‚æœæ’å…¥èŠ‚ç‚¹ä¹‹åé“¾è¡¨é•¿åº¦è¶…è¿‡8å°±å°†å½“å‰é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘
- æ‰©å®¹çš„æ­¥éª¤:
  1. 
- åœ¨è°ƒç”¨HashMapçš„ä»»ä½•è¿­ä»£å™¨å, éƒ½åªèƒ½é€šè¿‡iterator.removeæ¥ä¿®æ”¹ç»“æ„äº†(å³ä¸èƒ½æ·»åŠ , ä¹Ÿä¸èƒ½è°ƒç”¨HashMap.removeæ¥è¿›è¡Œåˆ é™¤), å¦åˆ™å°†ä¿å­˜ConcurrentModificationException
- HashMapè¦æ±‚equalsçš„å¯¹è±¡è¿”å›ç›¸åŒçš„hashcode, å› ä¸ºåœ¨hashmapæŸ¥æ‰¾çš„æ—¶å€™ä¼šå»ç›¸åŒhashcodeçš„æ¡¶ä¸­è°ƒç”¨equalsæ–¹æ³•åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦equals, è¿™å°±è¦æ±‚equalsç›¸åŒçš„å¯¹è±¡çš„hashcodeä¸€æ ·

>  ä¸ºä»€ä¹ˆHashMapæ‰©å®¹ä¸º2å€

1. éœ€è¦æ³¨æ„åˆ°åœ¨è·å–keyçš„æ•°ç»„ä¸‹æ ‡çš„æ—¶å€™, ä½¿ç”¨keyçš„hashå¯¹æ•°ç»„é•¿åº¦å–ä½™ä½¿ç”¨çš„æ–¹æ³•æ˜¯(n - 1) & hash, è¿™é‡Œçš„næ˜¯æ•°ç»„é•¿åº¦. 

   å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼çš„åŸå› æ˜¯hashmapæ¯æ¬¡æ‰©å®¹2å€, æ‰€ä»¥næ°¸è¿œæ˜¯2çš„å¹‚, åœ¨äºŒè¿›åˆ¶æ˜¯æ°¸è¿œæ˜¯é«˜ä½ä¸º1, å…¶ä½™ä½æ˜¯0. ä¸‹é¢ä»¥n=16ä½ä¾‹:

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220909134831758.png" alt="image-20220909134831758" style="zoom:50%;" />

   (n-1) & hashç›¸å½“äºæŠŠhashçš„é«˜ä½æŠ¹å»äº†, ä½¿ç”¨è¿™ç§æ–¹å¼æ±‚ä½™èƒ½å¤ŸåŠ é€Ÿè®¡ç®—

2. åœ¨æ‰©å®¹çš„æ—¶å€™, éœ€è¦å¯¹å·²ç»hashåˆ†å¸ƒåˆ°æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ é‡æ–°è®¡ç®—hashå€¼ï¼Œåˆ†é…åˆ°æ–°çš„æ•°ç»„ä¸­ã€‚éœ€è¦å·¨å¤§çš„è®¡ç®—èµ„æºã€‚è€Œå¦‚æœå®¹é‡æ˜¯2çš„å¹‚çš„è¯ï¼Œ ä¸Šå›¾ä¸­n=16ï¼Œç¿»å€åæ•°ç»„é•¿åº¦ä¸º32ï¼Œ è¿›è¡Œé‡hash

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220909135942439.png" alt="image-20220909135942439" style="zoom:50%;" />

   ä¼šå‘ç°é‡hashçš„ä½ç½®è¦ä¹ˆæ˜¯åŸæ¥ä½ç½®, è¦ä¹ˆæ˜¯åŸæ¥ä½ç½®+åŸæ¥æ•°ç»„é•¿åº¦. è¿™æ ·å°±å‡å°‘äº†è®¡ç®—é‡å’Œä½ç§»é‡. (åŸç†å°±æ˜¯ç¿»å€åç›¸å½“äºn-1çš„é«˜ä½æ·»åŠ äº†ä¸€ä¸ª1, é‚£ä¹ˆè¿›è¡Œ&è¿è¡Œçš„æ—¶å€™, ä½ä½è¿ç®—ç»“æœä¸å˜, é«˜ä½è¿ç®—çš„ç»“æœè¦ä¹ˆæ˜¯0(åŸä½ç½®), è¦ä¹ˆæ˜¯1(åŸä½ç½®+åŸé•¿åº¦))

#### LinkedHashMap

LinkedHashMapå’ŒHashMapçš„åŒºåˆ«åœ¨äº, åœ¨è¿­ä»£æ•°æ®çš„æ—¶å€™LinkedHashMapæ˜¯æŒ‰ç…§å…ƒç´ æ·»åŠ çš„é¡ºåºæ¥è¿­ä»£æ•°ç»„çš„, è€ŒHashMapçš„è¿­ä»£æ˜¯æŒ‰ç…§å­˜å‚¨çš„é¡ºåº.

å®ç°åŸç†æ˜¯: LinkedHashMapç»§æ‰¿HashMap, å¹¶ä¸”ä»–çš„Entryæ¯”HashMap.Entryå¯¹ä¸¤ä¸ªå±æ€§, ç”¨ä»¥è®°å½•å½“å‰èŠ‚ç‚¹ä¸Šä¸€ä¸ªæ·»åŠ çš„èŠ‚ç‚¹å’Œä¸‹ä¸€ä¸ªæ·»åŠ çš„èŠ‚ç‚¹. è¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªé“¾è¡¨, è¿­ä»£çš„æ—¶å€™åªè¦è¿­ä»£before, afterè¿™ä¸ªé“¾è¡¨å°±å¥½äº†

~~~java
static class Entry<K,V> extends HashMap.Node<K,V> {
        Entry<K,V> before, after;
        Entry(int hash, K key, V value, Node<K,V> next) {
            super(hash, key, value, next);
        }
    }
~~~



#### HashSetå’ŒLinkedHashSet

HashSetå’ŒLinkedHashSetçš„åŒºåˆ«: LinkedHashSetçš„è¿­ä»£æ˜¯æŒ‰ç…§æ·»åŠ é¡ºåºçš„, è€ŒHashSetä¸æ˜¯. 

HashSetå†…éƒ¨æ˜¯ä½¿ç”¨çš„HashMapæ¥å®ç°çš„, å³æ‰€æœ‰æ·»åŠ è¿›HashSetä¸­çš„æ•°æ®éƒ½ä¼šæ·»åŠ è¿›HashMap, å¹¶ä¸”entry.value éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡

~~~java
private transient HashMap<E,Object> map;
private static final Object PRESENT = new Object();
public boolean add(E e) {
        return map.put(e, PRESENT)==null;
}
~~~

LinkedHashSetçš„å®ç°åŸç†ä¸HashSetç±»ä¼¼, åªä¸è¿‡ä¸Šé¢çš„mapç±»å‹æ˜¯ä¸€ä¸ªLinkedHashMap



#### TreeMapå’ŒTreeSet

TreeMapå’ŒHashMapçš„åŒºåˆ«åœ¨äºTreeMapè¿­ä»£çš„æ—¶å€™æ˜¯æŒ‰ç…§keyçš„å¤§å°æ¥æ’åºçš„

TreeMapå†…éƒ¨ä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯çº¢é»‘æ ‘



#### CopyOnWriteArrayListå’ŒCopyOnWriteArraySet

CopyOnWriteArrayList:

- getæ“ä½œæ— é”, ä½†æ˜¯è·å–çš„æ˜¯è€ç‰ˆæœ¬çš„æ•°æ®

- addæ“ä½œä¼šåŠ é”, å¹¶ä¸”å¤åˆ¶æ•°æ®ä¸€ä»½, å¯¹å¤åˆ¶çš„æ•°æ®è¿›è¡Œä¿®æ”¹, ç„¶åé‡æ–°è®¾ç½®å¼•ç”¨
- ä¼˜ç‚¹æ˜¯é€‚åˆè¯»å¤šå†™å°‘çš„ç¯å¢ƒ
- ç¼ºç‚¹æ˜¯å¦‚æœæ·»åŠ æ“ä½œé¢‘ç¹, æˆ–è€…ä¿å­˜çš„æ•°æ®å¤ªå¤§, å¤åˆ¶å†…å­˜ä¼šå ç”¨å¾ˆå¤§ç©ºé—´, é€ æˆgc

CopyOnWriteArraySet:

- åº•å±‚æ˜¯CopyOnWriteArraySet
- åœ¨addçš„æ—¶å€™ä¼šå¾ªç¯éå†Listçœ‹æœ‰æ²¡æœ‰é‡å¤çš„å…ƒç´ , å¦‚æœæœ‰å°±ä¸åŠ å…¥

~~~java
    public E get(int index) {
        return get(getArray(), index);
    }
	public void add(int index, E element) {
        final ReentrantLock lock = this.lock; // åŠ é”
        lock.lock();
        try {
            Object[] elements = getArray(); // è·å–æ•°æ®
            int len = elements.length;
            if (index > len || index < 0)
                throw new IndexOutOfBoundsException("Index: "+index+
                                                    ", Size: "+len);
            Object[] newElements;
            int numMoved = len - index;
            if (numMoved == 0)
                newElements = Arrays.copyOf(elements, len + 1); // è¿›è¡Œå¤åˆ¶
            else {
                newElements = new Object[len + 1];
                System.arraycopy(elements, 0, newElements, 0, index);
                System.arraycopy(elements, index, newElements, index + 1,
                                 numMoved);
            }
            newElements[index] = element; // æ·»åŠ å…ƒç´ 
            setArray(newElements); // é‡æ–°è®¾ç½®æ•°æ®
        } finally {
            lock.unlock();
        }
    }
~~~



#### ConcurrentHashMap

https://www.bilibili.com/video/BV17i4y1x71z

- ConcurrentHashMapçš„é»˜è®¤å¤§å°ä¸º16, æ‰©å®¹å› å­ä¸º0.75, æ¯æ¬¡æ‰©å®¹2å€

- **ConcurrentHashMapçš„keyå’Œvalueéƒ½ä¸èƒ½ä¸ºnull**

  å› ä¸ºåœ¨HashMapä¸­, ä½ å¯ä»¥é€šè¿‡map.containsKeyæ¥åˆ¤æ–­ä¸€ä¸ªkeyæ˜¯å¦å­˜åœ¨, å¦‚æœå­˜åœ¨å°±getä»–

  ä½†æ˜¯åœ¨ConcurrentHashMapä¸­, å› ä¸ºä»–æ˜¯å¹¶å‘çš„, 

  ä½ ç”¨containsKeyåˆ¤æ–­ä¸€ä¸ªkey, å¦‚æœå­˜åœ¨, ä½ å»getçš„æ—¶å€™å¯èƒ½æ— æ³•getåˆ°,å› ä¸ºåˆ«çš„çº¿ç¨‹å¯èƒ½åœ¨containå’Œgetä¹‹é—´å°±æŠŠè¿™ä¸ªkeyåˆ é™¤äº†, è¿™ä¸ªæ—¶å€™ä»–è¿”å›null, ä½ å¯èƒ½å°±ä¼šå¥‡æ€ª, åˆ°åº•æ˜¯valueæ˜¯null, è¿˜æ˜¯å°±æ²¡æœ‰è¿™ä¸ªkey

  æ‰€ä»¥ä¸ºäº†é¿å…æ­§ä¹‰, ä¸å‡†keyå’Œvalueä¸ºnull, å½“getè¿”å›nullçš„æ—¶å€™, æ˜ç¡®è¡¨ç¤ºä»–æ²¡æœ‰è¿™ä¸ªkey

- ä»–æœ‰ä¸€ä¸ªé‡è¦å±æ€§sizeCtl:

  - 0: è¡¨ç¤ºæ•°ç»„æœªåˆå§‹åŒ–(table==null), æ•°å€¼åˆå§‹å®¹é‡16

    æ•´æ•°: å¦‚æœæ•°ç»„æœªåˆå§‹åŒ–, é‚£ä¹ˆä»–å°±æ˜¯åˆå§‹å®¹é‡

    â€‹		å¦‚æœå·²ç»åˆå§‹åŒ–, é‚£ä¹ˆä»–å°±æ˜¯æ‰©å®¹é˜ˆå€¼

  - -1: æ­£åœ¨åˆå§‹åŒ–

  - -n: æ­¤æ—¶æœ‰n-1ä¸ªçº¿ç¨‹æ­£åœ¨å…±åŒå®Œæˆæ•°ç»„çš„æ‰©å®¹æ“ä½œ

- ConcurrentHashMapä¸­çš„é“¾è¡¨å¦‚æœé•¿åº¦è¶…è¿‡8, ä½†æ˜¯æ€»å®¹é‡å°äº64çš„æ—¶å€™, ä¼šä¼˜å…ˆæ‰©å®¹

  åªæœ‰å½“é“¾è¡¨é•¿åº¦è¶…è¿‡8, å¹¶ä¸”å®¹é‡å¤§äº64, æ‰ä¼šå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘

- åœ¨æ·»åŠ èŠ‚ç‚¹çš„æ—¶å€™, å¦‚æœtable[i] == null, é‚£ä¹ˆä¼šç›´æ¥é€šè¿‡caså°†nodeæ’å…¥

  å¦‚æœtable[i] != null, é‚£ä¹ˆä¼šsynchronized (table[i])æ¥é”ä½ä»–, è¿›è¡ŒåŒæ­¥æ’å…¥

- tableæ˜¯ConcurrentHashMapçš„åº•å±‚ç»“æ„(æ•°ç»„), table[i]æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹

  1. å¦‚æœtable[i]çš„hashå¤§äº0, é‚£ä¹ˆæ­¤æ—¶table[i]æ˜¯NodeèŠ‚ç‚¹, æ­¤æ—¶table[i]æ˜¯é“¾è¡¨çš„å¤´ç»“ç‚¹

  2. å¦‚æœtable[i]çš„hash=-1, é‚£ä¹ˆæ­¤æ—¶ä»–æ˜¯MovedèŠ‚ç‚¹, æ­¤æ—¶tableæ­£åœ¨æ‰©å®¹

  3. å¦‚æœtable[i]çš„hash=-2, é‚£ä¹ˆæ­¤æ—¶table[i]æ˜¯TreeBin, çº¢é»‘æ ‘

  4. å¦‚æœtable[i]çš„hash=-3, é‚£ä¹ˆæ­¤æ—¶table[i]æ˜¯ReservedèŠ‚ç‚¹

     <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20230824223235996.png" alt="image-20230824223235996" style="zoom:33%;" />

> ConcurrentHashMap è®¡æ•°åŸç†

æ’å…¥ä¹‹åä¼šå°†countåŠ 1, å®ƒä½¿ç”¨çš„æ˜¯LongAdderçš„æ–¹å¼æ¥åŠ 1çš„, å³baseCountå’Œä¸€ä¸ªCounterCellæ•°ç»„æ¥ç»„æˆä¸€ä¸ªLongAdder, åœ¨å¼€å§‹çš„ä½¿ç”¨ä½¿ç”¨casåœ¨baseCountä¸ŠåŠ 1, å¦‚æœäº§ç”Ÿç«äº‰, å°±éšæœºé€‰ä¸€ä¸ªCounterCell, å¯¹ä»–çš„valueæ¥åŠ 1, æ‰€æœ‰æ€»çš„countå°±æ˜¯baseCountå’Œæ‰€æœ‰CounterCell.valueçš„å’Œ

è¿™æ ·å¯ä»¥å°±æœ‰å°†casçš„ç«äº‰åˆ†æ•£åˆ°å¤šä¸ªå€¼ä¸Šé¢

> ConcurrentHashMapæ‰©å®¹è¿‡ç¨‹

- åœ¨åŠ 1ä¹‹å, ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹, æ‰©å®¹çš„åŸç†åˆ›å»ºä¸€ä¸ªä¸¤å€çš„æ•°ç»„, ç„¶åå°†åŸå§‹tableåˆ†ä¸ºä¸€æ®µä¸€æ®µçš„, æ¯ä¸ªçº¿ç¨‹éƒ½è´Ÿè´£ä¸€æ®µé•¿åº¦çš„æ•°ç»„çš„è¿ç§»,

- è¿ç§»çš„æ–¹å‘æ˜¯ä»åå¾€å‰è¿ç§»çš„

- æ¯æ®µçš„é•¿åº¦ä¸º**max(length/8/cpu, 16)**, å½“ä¸€ä¸ªçº¿ç¨‹è¿›æ¥ä¹‹å, ä¼šè®¡ç®—å‡ºè‡ªå·±éœ€è¦è´Ÿè´£è¿ç§»çš„èµ·å§‹å’Œç»“æŸçš„ä¸‹æ ‡, ç„¶åå¼€å§‹è¿ç§»æ•°æ®åˆ°æ–°çš„æ•°ç»„

å¦‚ä¸‹å›¾æ‰€ç¤º, ä¸€ä¸ªé•¿åº¦ä¸º35çš„æ•°ç»„è¿›è¡Œè¿ç§»,  å…¶ä¸­è“è‰²èŠ‚ç‚¹è¡¨ç¤ºNodeèŠ‚ç‚¹, æ©™è‰²èŠ‚ç‚¹è¡¨ç¤ºBinTreeçº¢é»‘æ ‘èŠ‚ç‚¹, ç´«è‰²èŠ‚ç‚¹è¡¨ç¤ºForwardingèŠ‚ç‚¹, è¯¥èŠ‚ç‚¹è¡¨ç¤ºå½“å‰æ¡¶å·²ç»è¿ç§»å®Œæ¯•



transferIndexè¡¨ç¤ºå½“å‰çº¿ç¨‹ä»è¿™ä¸ªä½ç½®å¼€å§‹è®¡ç®—è‡ªå·±çš„è´Ÿè´£çš„è¿™æ®µæ¡¶çš„å¼€å§‹èŠ‚ç‚¹å’Œç»“æŸèŠ‚ç‚¹

iè¡¨ç¤ºå½“å‰è¿ç§»çš„æ¡¶çš„ä¸‹æ ‡, boundè¡¨ç¤ºç»“æŸçš„ä¸‹æ ‡



å¼€å§‹æ˜¯transferIndex=35=length, bound=i=0

![image-20230824223354766](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20230824223354766.png)

è®¡ç®—ä»»åŠ¡å, transferIndex=bound=transferIndex-16=35-16=19, i=transferIndex-1=34, å³å½“å‰çº¿ç¨‹è´Ÿè´£34~19è¿™æ®µæ¡¶çš„æ•°æ®è¿ç§»

![image-20230824223427047](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20230824223427047.png)

å½“åˆ«çš„çº¿ç¨‹è¿›å…¥åˆ°æ‰©å®¹çš„ä»£ç å, ä¼šè¿›è¡Œè¾…åŠ©è¿ç§»æ•°æ®, å³ä»transferIndexå¼€å§‹åˆå¾€å‰æ•°16ä¸ªæ ¼å­, ç„¶åå¯¹è¿™æ®µæ•°æ®è¿›è¡Œè¿ç§»

å½“å‰çº¿ç¨‹é”ä½table[i], ç„¶åå¯¹è¿™ä¸ªæ¡¶è¿›è¡Œè¿ç§», å½“table[i]è¿ç§»å®Œä¹‹å, å°†ForwardingNodeçš„ä¸€ä¸ªå®ä¾‹èµ‹å€¼ç»™table[i]

![image-20230824223449652](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/image-20230824223449652.png)



### javaé˜Ÿåˆ—

####  Queue

~~~java
public interface Queue<E> extends Collection<E>
~~~

è®¾è®¡ç”¨äºæ•°æ®å¤„ç†ä¹‹å‰å®¹çº³æ•°æ®çš„é›†åˆã€‚ é™¤äº†åŸºæœ¬çš„Collectionæ“ä½œå¤–ï¼Œé˜Ÿåˆ—è¿˜æä¾›å…¶ä»–æ’å…¥ï¼Œæå–å’Œæ£€æŸ¥æ“ä½œã€‚ è¿™äº›æ–¹æ³•ä¸­çš„æ¯ä¸€ç§éƒ½ä»¥ä¸¤ç§å½¢å¼å­˜åœ¨ï¼šä¸€ç§åœ¨æ“ä½œå¤±è´¥æ—¶å¼•å‘å¼‚å¸¸ï¼Œå¦ä¸€ç§è¿”å›ä¸€ä¸ªç‰¹æ®Šå€¼ï¼ˆnull/false, å–å†³äºå…·ä½“æ“ä½œï¼‰ã€‚ **æ’å…¥æ“ä½œçš„åä¸€ç§å½¢å¼æ˜¯ä¸“é—¨ä¸ºä¸å®¹é‡å—é™çš„Queueå®ç°ä¸€èµ·ä½¿ç”¨è€Œè®¾è®¡çš„**ï¼› åœ¨å¤§å¤šæ•°å®ç°ä¸­ï¼Œæ’å…¥æ“ä½œä¸ä¼šå¤±è´¥ã€‚ 

| æ“ä½œ | æŠ›å‡ºå¼‚å¸¸ |   è¿”å›ç‰¹å®šå€¼   |
| :--: | :------: | :------------: |
| æ’å…¥ |   add    | offerï¼ˆfalseï¼‰ |
| å»é™¤ |  remove  |  pollï¼ˆnullï¼‰  |
| æ£€æŸ¥ | element  |  peekï¼ˆnullï¼‰  |

é˜Ÿåˆ—é€šå¸¸ä½†ä¸ä¸€å®šä»¥FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰çš„æ–¹å¼å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ ä¾‹å¤–æƒ…å†µåŒ…æ‹¬ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆæ ¹æ®æä¾›çš„æ¯”è¾ƒå™¨å¯¹å…ƒç´ è¿›è¡Œæ’åºæˆ–å…ƒç´ çš„è‡ªç„¶æ’åºï¼‰å’ŒLIFOé˜Ÿåˆ—ï¼ˆæˆ–å †æ ˆï¼‰ï¼Œå¯¹LIFOè¿›è¡Œæ’åºï¼ˆåè¿›å…ˆå‡ºï¼‰ã€‚æ¯ä¸ªQueueå®ç°å¿…é¡»æŒ‡å®šå…¶æ’åºå±æ€§ã€‚
Queueå®ç°é€šå¸¸ä¸å…è®¸æ’å…¥nullå…ƒç´ ï¼Œå°½ç®¡æŸäº›å®ç°ï¼ˆä¾‹å¦‚LinkedListä¸å…è®¸æ’å…¥null ã€‚ å³ä½¿åœ¨å…è®¸çš„å®ç°ä¸­ï¼Œä¹Ÿä¸åº”å°†nullæ’å…¥åˆ°Queue ï¼Œå› ä¸ºpollæ–¹æ³•è¿˜å°†nullç”¨ä½œç‰¹æ®Šçš„è¿”å›å€¼ï¼Œä»¥æŒ‡ç¤ºè¯¥é˜Ÿåˆ—ä¸åŒ…å«ä»»ä½•å…ƒç´ ã€‚
Queueå®ç°é€šå¸¸ä¸å®šä¹‰æ–¹æ³•equalså’ŒhashCodeçš„åŸºäºå…ƒç´ çš„ç‰ˆæœ¬ï¼Œè€Œæ˜¯ä»Objectç±»ç»§æ‰¿åŸºäºèº«ä»½çš„ç‰ˆæœ¬ï¼Œå› ä¸ºå¯¹äºå…·æœ‰ç›¸åŒå…ƒç´ ä½†é¡ºåºå±æ€§ä¸åŒçš„é˜Ÿåˆ—ï¼ŒåŸºäºå…ƒç´ çš„ç›¸ç­‰æ€§å¹¶ä¸æ€»æ˜¯å¾ˆå¥½å®šä¹‰çš„

#### Deque

åŒç«¯é˜Ÿåˆ—ã€‚ å¤§å¤šæ•°Dequeå®ç°å¯¹å®ƒä»¬å¯èƒ½åŒ…å«çš„å…ƒç´ æ•°é‡æ²¡æœ‰å›ºå®šçš„é™åˆ¶ï¼Œä½†æ˜¯æ­¤æ¥å£æ”¯æŒå®¹é‡å—é™çš„åŒç«¯é˜Ÿåˆ—ä»¥åŠæ²¡æœ‰å›ºå®šå¤§å°é™åˆ¶çš„åŒç«¯é˜Ÿåˆ—ã€‚

|      |          å¤´ | éƒ¨         |         å°¾ | éƒ¨        |
| :--: | ----------: | :--------- | ---------: | :-------- |
|      |    å¼•å‘å¼‚å¸¸ | ç‰¹æ®Šå€¼     |   å¼•å‘å¼‚å¸¸ | ç‰¹æ®Šå€¼    |
| æ’å…¥ |    addFirst | offerFirst |    addLast | offerLast |
| å»é™¤ | removeFirst | pollFirst  | removeLast | pollLast  |
| æ£€æŸ¥ |    getFirst | peekFirst  |    getLast | peekLast  |

 å½“åŒç«¯é˜Ÿåˆ—ç”¨ä½œé˜Ÿåˆ—æ—¶ï¼Œå°†å¯¼è‡´FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰è¡Œä¸ºã€‚ å…ƒç´ åœ¨åŒç«¯é˜Ÿåˆ—çš„æœ«å°¾æ·»åŠ ï¼Œå¹¶ä»å¼€å¤´åˆ é™¤ã€‚ ç»§æ‰¿è‡ªQueueæ¥å£çš„æ–¹æ³•ä¸Dequeæ–¹æ³•å®Œå…¨ç­‰æ•ˆï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| Queueæ–¹æ³• |  Dequeæ–¹æ³•  |
| :-------: | :---------: |
|    add    |   addLast   |
|   offer   |  offerLast  |
|  remove   | removeFirst |
|   poll    |  pollFirst  |
|  element  |  getFirst   |
|   peek    |  peekFirst  |

 å½“åŒç«¯é˜Ÿåˆ—ç”¨ä½œå †æ ˆæ—¶ï¼Œå…ƒç´ ä»åŒç«¯é˜Ÿåˆ—çš„å¼€å¤´è¢«å‹å…¥å¹¶å¼¹å‡ºã€‚ å †æ ˆæ–¹æ³•å®Œå…¨ç­‰åŒäºDequeæ–¹æ³•ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| å †æ ˆæ–¹æ³• |  Dequeæ–¹æ³•  |
| :------: | :---------: |
|   push   |  addFirst   |
|   pop    | removeFirst |
|   peek   |  peekFirst  |


æ­¤æ¥å£æä¾›äº†ä¸¤ç§åˆ é™¤å†…éƒ¨å…ƒç´ çš„æ–¹æ³•ï¼š 

|             æ–¹æ³•              |              åŠŸèƒ½              |
| :---------------------------: | :----------------------------: |
| removeFirstOccurrence(Object) | ç§»é™¤ä»é˜Ÿé¦–å¼€å§‹é¦–æ¬¡å‡ºç°çš„è¯¥å…ƒç´  |
| removeLastOccurrence(Object)  | ç§»é™¤ä»é˜Ÿå°¾å¼€å§‹é¦–æ¬¡å‡ºç°çš„è¯¥å…ƒç´  |

å°½ç®¡ä¸¥æ ¼ä¸è¦æ±‚Dequeå®ç°ç¦æ­¢æ’å…¥nullå…ƒç´ ï¼Œä½†å¼ºçƒˆå»ºè®®è¿™æ ·åšã€‚

#### BlockingQueue

~~~~java
BlockingQueue<E> extends Queue<E>
~~~~

å½“æ£€ç´¢å’Œç§»é™¤å…ƒç´ æ—¶æ”¯æŒç­‰å¾…é˜Ÿåˆ—ç”±ç©ºè½¬ä¸ºéç©ºï¼Œ æ·»åŠ å…ƒç´ æ—¶æ”¯æŒç­‰å¾…é˜Ÿåˆ—ç”±ä¸å¯ç”¨è½¬ä¸ºå¯ç”¨ã€‚

BlockingQueueæ–¹æ³•æœ‰å››ç§å½¢å¼ï¼Œå®ƒä»¬ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†æ“ä½œï¼Œè¿™äº›æ“ä½œæ— æ³•ç«‹å³æ»¡è¶³ï¼Œä½†å°†æ¥å¯èƒ½ä¼šæ»¡è¶³ï¼š

- ä¸€ç§æŠ›å‡ºå¼‚å¸¸

- ç¬¬äºŒç§è¿”å›ç‰¹æ®Šå€¼ï¼ˆ nullæˆ–false ï¼Œå…·ä½“å–å†³äºæ“ä½œï¼‰

- ç¬¬ä¸‰ä¸ªå—å°†æ— é™æœŸåœ°é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æ“ä½œæˆåŠŸä¸ºæ­¢

- ç¬¬å››ä¸ªå—ä»…åœ¨ç»™å®šçš„æœ€å¤§æ—¶é—´é™åˆ¶å†…æ”¾å¼ƒã€‚ 

ä¸‹è¡¨æ€»ç»“äº†è¿™äº›æ–¹æ³•ï¼š

|      | å¼•å‘å¼‚å¸¸  | è¿”å›ç‰¹æ®Šå€¼ |  å µå¡  |         è¶…æ—¶         |
| :--: | :-------: | :--------: | :----: | :------------------: |
| æ’å…¥ |  add(e)   |  offer(e)  | put(e) | offer(e, time, unit) |
| å»é™¤ | remove()  |   poll()   | take() |   poll(time, unit)   |
| æ£€æŸ¥ | element() |   peek()   | ä¸é€‚ç”¨ |        ä¸é€‚ç”¨        |

- BlockingQueueä¸æ¥å—nullå…ƒç´ ã€‚ å®ç°ä¼šåœ¨å°è¯•add ï¼Œ putæˆ–offer nullæŠ›å‡ºNullPointerException ã€‚nullå€¼ç”¨ä½œæ ‡è®°å€¼ï¼Œä»¥æŒ‡ç¤ºpollæ“ä½œå¤±è´¥
- BlockingQueueå¯èƒ½å—å®¹é‡é™åˆ¶ã€‚ åœ¨ä»»ä½•ç»™å®šæ—¶é—´ï¼Œå®ƒéƒ½å¯èƒ½å…·æœ‰remainingCapacityå®¹é‡ï¼Œè¶…è¿‡è¯¥å®¹é‡å°±ä¸èƒ½putå…¶ä»–å…ƒç´ è€Œä¸ä¼šé˜»å¡ã€‚ æ²¡æœ‰ä»»ä½•å†…éƒ¨å®¹é‡çº¦æŸçš„BlockingQueueå§‹ç»ˆè¿”å›Integer.MAX_VALUEçš„å‰©ä½™å®¹é‡ã€‚
- BlockingQueueå®ç°è¢«è®¾è®¡ä¸ºä¸»è¦ç”¨äºç”Ÿäº§è€…-æ¶ˆè´¹è€…é˜Ÿåˆ—ï¼Œä½†å¦å¤–è¿˜æ”¯æŒCollectionæ¥å£ã€‚ å› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨remove(x)ä»é˜Ÿåˆ—ä¸­remove(x)ä»»æ„å…ƒç´ ã€‚ ä½†æ˜¯ï¼Œè¿™æ ·çš„æ“ä½œé€šå¸¸ä¸èƒ½éå¸¸æœ‰æ•ˆåœ°æ‰§è¡Œï¼Œå¹¶ä¸”ä»…ç”¨äºå¶å°”çš„ä½¿ç”¨ï¼Œä¾‹å¦‚å½“å–æ¶ˆæ’é˜Ÿçš„æ¶ˆæ¯æ—¶ã€‚
  BlockingQueueå®ç°æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ æ‰€æœ‰æ’é˜Ÿæ–¹æ³•éƒ½æ˜¯ä½¿ç”¨å†…éƒ¨é”æˆ–å…¶ä»–å½¢å¼çš„å¹¶å‘æ§åˆ¶æ¥åŸå­åœ°å®ç°å…¶æ•ˆæœçš„ã€‚ ç„¶è€Œï¼Œå¤§é‡çš„Collectionæ“ä½œaddAll ï¼Œ containsAll ï¼Œ retainAllå’ŒremoveAllä¸ä¸€å®šåŸå­é™¤éåœ¨å®ç°ä¸­å¦æœ‰è§„å®šæ‰§è¡Œã€‚ å› æ­¤ï¼Œä¾‹å¦‚ï¼Œä»…åœ¨cæ·»åŠ ä¸€äº›å…ƒç´ ä¹‹åï¼Œ addAll(c)å¯èƒ½ä¼šå¤±è´¥ï¼ˆå¼•å‘å¼‚å¸¸ï¼‰ã€‚
- BlockingQueueæœ¬è´¨ä¸Šä¸æ”¯æŒä»»ä½•ç±»å‹çš„â€œå…³é—­â€æˆ–â€œå…³é—­â€æ“ä½œï¼Œä»¥æŒ‡ç¤ºå°†ä¸å†æ·»åŠ ä»»ä½•é¡¹ç›®ã€‚ æ­¤ç±»åŠŸèƒ½çš„éœ€æ±‚å’Œä½¿ç”¨å¾€å¾€å–å†³äºå®ç°ã€‚ ä¾‹å¦‚ï¼Œä¸€ç§å¸¸è§çš„ç­–ç•¥æ˜¯è®©ç”Ÿäº§è€…æ’å…¥ç‰¹æ®Šçš„æµå°¾å¯¹è±¡æˆ–æœ‰æ¯’å¯¹è±¡ï¼Œå½“æ¶ˆè´¹è€…é‡‡å–è¿™ç§æ–¹æ³•æ—¶ä¼šå¯¹å…¶è¿›è¡Œç›¸åº”çš„è§£é‡Šã€‚
  ä½¿ç”¨ç¤ºä¾‹ï¼ŒåŸºäºå…¸å‹çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ–¹æ¡ˆã€‚ è¯·æ³¨æ„ï¼Œ BlockingQueueå¯ä»¥å®‰å…¨åœ°ä¸å¤šä¸ªç”Ÿäº§è€…å’Œå¤šä¸ªæ¶ˆè´¹è€…ä¸€èµ·ä½¿ç”¨ã€‚



# æ•°æ®ç»“æ„

#### äºŒå‰æ ‘

éœ€è¦ç¬¦åˆçš„ç‰¹æ€§

- æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šåªæœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹

  <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922162110144.png" alt="image-20220922162110144" style="zoom:25%;" />

è¿™æ ·çš„æ•°å› ä¸ºæ²¡æœ‰é¡ºåºæ€§æ‰€ä»¥æ²¡æœ‰åŠæ³•è¿›è¡ŒæŸ¥æ‰¾



#### äºŒå‰æŸ¥æ‰¾æ ‘(BST)

Binary Search Tree[BST], éœ€è¦ç¬¦åˆçš„ç‰¹æ€§

1. æŸèŠ‚ç‚¹çš„å·¦å­æ ‘èŠ‚ç‚¹å€¼ä»…åŒ…å«å°äºè¯¥èŠ‚ç‚¹å€¼
2. æŸèŠ‚ç‚¹çš„å³å­æ ‘èŠ‚ç‚¹å€¼ä»…åŒ…å«å¤§äºè¯¥èŠ‚ç‚¹å€¼
3. å·¦å³å­æ ‘æ¯ä¸ªä¹Ÿå¿…é¡»æ˜¯äºŒå‰æŸ¥æ‰¾æ ‘

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922162410091.png" alt="image-20220922162410091" style="zoom: 25%;" />

BSTæ ‘åœ¨æç«¯çš„æƒ…å†µä¸‹ä¼šé€€åŒ–æˆé“¾è¡¨, æŸ¥æ‰¾æ•ˆç‡ä¸é«˜, æ‰€ä»¥`ä¸ºäº†æŸ¥æ‰¾æ•ˆç‡é«˜æˆ‘ä»¬éœ€è¦åœ¨æ’å…¥åˆ é™¤çš„æ—¶å€™ä½¿ç”¨ä¸€å®šçš„å¹³è¡¡ç®—æ³•, è®©ä»–çš„å·¦å³å­æ•°çš„é«˜åº¦å·®ä¸è¦å·®å¤ªå¤š, æ‰€ä»¥å°±æœ‰äº†å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘å’Œçº¢é»‘æ ‘`



#### äºŒå‰æ ‘çš„å·¦æ—‹å³æ—‹

> å·¦æ—‹(é€†æ—¶é’ˆ)

ä¸‹å›¾å±•ç¤ºäº†å¯¹èŠ‚ç‚¹66è¿›è¡Œå·¦æ—‹çš„è¿‡ç¨‹, å³

1. 66åš77å·¦å­æ ‘
2. 77çš„å·¦å­æ ‘åš66çš„å³å­æ ‘

![åŠ¨å›¾](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/v2-db1cdb0da952a71f9b6d64b2608467eb_b.webp)

> å³æ—‹

ä¸‹å›¾å±•ç¤ºäº†66èŠ‚ç‚¹çš„å³æ—‹è¿‡ç¨‹

1. 66åš60çš„å·¦å­æ ‘
2. 60çš„å·¦å­æ ‘åš66çš„å³å­æ ‘

![åŠ¨å›¾](img/åˆ†å¸ƒå¼ä¸å¤šçº¿ç¨‹/v2-05246384c1c16537ca6176983bdb2627_b.webp)



#### å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘(AVLæ ‘)

å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘åœ¨äºŒå‰æŸ¥æ‰¾æ ‘çš„åŸºç¡€ä¸Šæ·»åŠ äº†ä¸€ä¸ªæ¡ä»¶, å³`ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹çš„å·¦å³å­æ ‘é«˜åº¦å·®ä¸èƒ½è¶…è¿‡äºŒ`

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922163857532.png" alt="image-20220922163857532" style="zoom:25%;" />

ä¸Šå›¾60èŠ‚ç‚¹çš„å·¦å³å­æ ‘é«˜åº¦å·®ä¸º2, æ‰€ä»¥ä¸æ˜¯. 

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922164008049.png" alt="image-20220922164008049" style="zoom:25%;" />

ä¸Šå›¾66èŠ‚ç‚¹çš„å·¦å³å­æ ‘é«˜åº¦å·®ä¸º2, æ‰€ä»¥ä¸æ˜¯

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922164103926.png" alt="image-20220922164103926" style="zoom:25%;" />

ä¸Šå›¾ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹çš„å·¦å³å­æ ‘é«˜åº¦å·®éƒ½ä¸è¶…è¿‡äºŒ, æ‰€ä»¥æ˜¯å¹³è¡¡äºŒå‰æ ‘

> å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘çš„å¹³è¡¡å› å­

å¯¹äºæ¯ä¸€ä¸ªèŠ‚ç‚¹, æˆ‘ä»¬éƒ½ç»™ä»–å®šä¹‰ä¸€ä¸ªå±æ€§å«åš`å¹³è¡¡å› å­`, å³å½“å‰èŠ‚ç‚¹çš„å·¦å­æ ‘å’Œå³å­æ ‘çš„é«˜åº¦å·®çš„ç»å¯¹å€¼,  ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªæ•°çš„å„ä¸ªèŠ‚ç‚¹çš„é«˜åº¦å·®

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922165652334.png" alt="image-20220922165652334" style="zoom:33%;" />

åªè¦æœ‰äº†è¿™ä¸ªé«˜åº¦å·®, æˆ‘ä»¬å°±çŸ¥é“äº†åœ¨æ’å…¥å’Œåˆ é™¤çš„æ—¶å€™æ˜¯é‚£ä¸ªèŠ‚ç‚¹å‘ç”Ÿäº†ä¸å¹³è¡¡, æˆ‘ä»¬åªéœ€è¦å¯¹è¿™ä¸ªèŠ‚ç‚¹è¿›è¡Œè°ƒæ•´å°±è¡Œäº†, åœ¨æ’å…¥åˆ é™¤çš„æ—¶å€™, ä¸€ä¸ªæœ‰å››ç§ä¸å¹³è¡¡çš„æƒ…å†µ, ä¸‹é¢ä¸€ä¸€è®²è§£

> LLçš„æƒ…å†µå¯¼è‡´ä¸å¹³è¡¡

å¯¹äºä¸‹é¢è¿™ç§æƒ…å†µ, æˆ‘ä»¬åœ¨åŸæœ¬å¹³è¡¡çš„æ ‘ä¸Šæ’å…¥fçš„æ—¶å€™, è¿™ä¸ªæ—¶å€™açš„å¹³è¡¡å› å­ä¸º2, å¯¼è‡´äº†ä¸å¹³è¡¡, å› ä¸ºæˆ‘ä»¬æ˜¯åœ¨`açš„å·¦èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹ä¸Šæ’å…¥çš„f, æ‰€ä»¥è¿™ç§æƒ…å†µç§°ä¸ºLLçš„æƒ…å†µ`

é’ˆå¯¹LLçš„æƒ…å†µ, æˆ‘ä»¬åªéœ€è¦`å³æ—‹aèŠ‚ç‚¹`å°±èƒ½å¤Ÿè§£å†³ä¸å¹³è¡¡çš„é—®é¢˜

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922170234663.png" alt="image-20220922170234663" style="zoom: 33%;" />

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/v2-373766641d1c03a78f3d7eac803d1f57_b.webp" alt="åŠ¨å›¾" style="zoom: 33%;" />

> RRçš„æƒ…å†µå¯¼è‡´ä¸å¹³è¡¡

å¦‚ä¸‹å›¾æ‰€ç¤º, æˆ‘ä»¬åœ¨ä¸€é¢—æœ¬æ¥å¹³è¡¡çš„æ ‘ä¸Šæ’å…¥äº†fèŠ‚ç‚¹, è¿™æ ·å°±å¯¼è‡´äº†aèŠ‚ç‚¹çš„å¹³è¡¡å› å­æ˜¯2, å› ä¸ºæˆ‘ä»¬æ˜¯`åœ¨aèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸Šé¢æ’å…¥çš„fèŠ‚ç‚¹æ‰€å¯¼è‡´çš„ä¸å¹³è¡¡, è¿™ç§æƒ…å†µæˆ‘ä»¬ç§°ä¸ºRRçš„æƒ…å†µ`

é’ˆå¯¹RRçš„æƒ…å†µ, æˆ‘ä»¬åªéœ€è¦`å·¦æ—‹AèŠ‚ç‚¹`å°±èƒ½å¤Ÿè§£å†³ä¸å¹³è¡¡çš„é—®é¢˜

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922170727579.png" alt="image-20220922170727579" style="zoom: 33%;" />

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/v2-e7044e4965ba640ee9ef35beac407cdc_b.webp" alt="åŠ¨å›¾" style="zoom: 33%;" />

> LRçš„æƒ…å†µå¯¼è‡´ä¸å¹³è¡¡

å¦‚ä¸‹å›¾æ‰€ç¤º, æˆ‘ä»¬åœ¨ä¸€é¢—æœ¬æ¥å¹³è¡¡çš„æ ‘ä¸Šæ’å…¥äº†fèŠ‚ç‚¹, è¿™æ ·å°±å¯¼è‡´äº†aèŠ‚ç‚¹çš„å¹³è¡¡å› å­æ˜¯2, å› ä¸ºæˆ‘ä»¬æ˜¯`åœ¨aèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸Šé¢æ’å…¥çš„fèŠ‚ç‚¹æ‰€å¯¼è‡´çš„ä¸å¹³è¡¡, è¿™ç§æƒ…å†µæˆ‘ä»¬ç§°ä¸ºLRçš„æƒ…å†µ`

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922172137520.png" alt="image-20220922172137520" style="zoom:33%;" />

é’ˆå¯¹LRçš„æƒ…å†µ, æˆ‘ä»¬åªéœ€è¦ä¸¤ä¸ªæ­¥éª¤

1. `å·¦æ—‹açš„å·¦å­èŠ‚ç‚¹`

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922171802190.png" alt="image-20220922171802190" style="zoom: 33%;" />

2. `å³æ—‹aèŠ‚ç‚¹`

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922172005211.png" alt="image-20220922172005211" style="zoom:33%;" />

> RLçš„æƒ…å†µå¯¼è‡´ä¸å¹³è¡¡

å¦‚ä¸‹å›¾æ‰€ç¤º, æˆ‘ä»¬åœ¨ä¸€é¢—æœ¬æ¥å¹³è¡¡çš„æ ‘ä¸Šæ’å…¥äº†fèŠ‚ç‚¹, è¿™æ ·å°±å¯¼è‡´äº†aèŠ‚ç‚¹çš„å¹³è¡¡å› å­æ˜¯2, å› ä¸ºæˆ‘ä»¬æ˜¯`åœ¨aèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¸Šé¢æ’å…¥çš„fèŠ‚ç‚¹æ‰€å¯¼è‡´çš„ä¸å¹³è¡¡, è¿™ç§æƒ…å†µæˆ‘ä»¬ç§°ä¸ºRLçš„æƒ…å†µ`

<img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922172247914.png" alt="image-20220922172247914" style="zoom:33%;" />

é’ˆå¯¹RLçš„æƒ…å†µ, æˆ‘ä»¬åšå¦‚ä¸‹ä¸¤ä¸ªæ­¥éª¤

1. `å³æ—‹açš„å³å­©å­`

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922173237914.png" alt="image-20220922173237914" style="zoom:33%;" />

2. `å·¦æ—‹a`

   <img src="../é¢è¯•é¢˜/img/é¢è¯•é¢˜/image-20220922173457997.png" alt="image-20220922173457997" style="zoom:33%;" />

#### çº¢é»‘æ ‘

åœ¨ä½¿ç”¨AVLæ ‘çš„æ—¶å€™, æˆ‘ä»¬å‘ç°`AVLçš„å¹³è¡¡æ¡ä»¶è¿‡äºä¸¥æ ¼, å¯¼è‡´å‡ ä¹æ¯æ¬¡çš„æ’å…¥å’Œåˆ é™¤éƒ½éœ€è¦å¯¹æ ‘è¿›è¡Œå¹³è¡¡`, æ‰€ä»¥AVLæ•°æ¯”è¾ƒé€‚åˆåœ¨è¯»å¤šå†™å°‘çš„æƒ…å†µä¸‹ä½¿ç”¨, åŒæ—¶æˆ‘ä»¬éœ€è¦ä¸€ç§ç›¸å¯¹AVLæ ‘ä¸é‚£ä¹ˆå¹³è¡¡çš„æ ‘(`ç‰ºç‰²ä¸€å®šçš„è¯»æ€§èƒ½, å¢åŠ å†™æ€§èƒ½`), äºæ˜¯å°±æœ‰äº†çº¢é»‘æ ‘

çº¢é»‘æ ‘çš„ç‰¹æ€§å¦‚ä¸‹: 

1. æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰çº¢è‰²æˆ–è€…é»‘è‰²
2. æ ¹èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²
3. çˆ¶å­èŠ‚ç‚¹ä¸èƒ½åŒæ—¶ä¸ºçº¢è‰²
4. çº¢é»‘æ ‘çš„å¶å­èŠ‚ç‚¹æ˜¯NullèŠ‚ç‚¹, å¹¶ä¸”æ˜¯é»‘è‰²çš„
5. ä»»æ„çš„èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹(NullèŠ‚ç‚¹)æ‰€ç»å†çš„é»‘è‰²èŠ‚ç‚¹çš„æ•°é‡æ˜¯ç›¸åŒçš„



#### bitmap

https://juejin.cn/post/7074747080492711943

ä½œç”¨: 

- å¤§æ•°æ®é‡å»é‡(40äº¿QQå·å»é‡)

  ä½¿ç”¨redisçš„bitmap, å¼„é•¿åº¦ä¸º40äº¿çš„bitmap, å°†qqå·å¯¹åº”çš„ä¸‹æ ‡æ ‡ä½1, ä¸‹æ¬¡å†æ¥åŒæ ·çš„qqå·, é‚£ä¹ˆé€šè¿‡ä¸‹æ ‡å¯ä»¥å¾—çŸ¥å·²ç»å­˜åœ¨äº†

- é˜²æ­¢redisç¼“å­˜